import{F as Pe,u as Ke,a as Ht}from"./Form-6ecdf185.js";import{r,c as i,a as u,b as c,i as C,l as U,f as s,q as ge,v as be,Y as Ie,F as K,_ as Je,e as E,h as D,m as Q,t as O,d as y,x as Me,S as pe,y as ze,u as qt,k as Yt,w as me,o as Gt,z as Ee,n as Ue,A as Le,B as Be,D as Re,C as Qt,L as Wt,p as Xt,g as Zt}from"./index-cf9ea608.js";import{u as _t}from"./errors-a6177d44.js";import{a as ea}from"./dataAccess-238ee380.js";const Ne={__name:"FormDialog",props:{modelValue:{type:Boolean,default:!1},fieldsLayout:{type:Array,default:[]},dataFields:{type:Array,default:[]},data:{type:Object,default:{}},schemas:{type:Object,default:{}},dialogTitle:{type:String,default:""},fullscreen:{type:Boolean,default:!1},errorMessages:{type:Object,default(){return{}}}},emits:["update:modelValue","submit"],setup(a,{emit:l}){const L=a,B=r(!1),R=r(""),p=i({get:()=>L.modelValue,set:m=>{l("update:modelValue",m)}}),w=i(()=>L.data);function A(m){l("submit",m)}function S(){p.value=!1,l("update:modelValue",!1)}return(m,f)=>(u(),c(K,null,[C(s(be),{modelValue:s(p),"onUpdate:modelValue":f[1]||(f[1]=h=>ge(p)?p.value=h:null),title:a.dialogTitle,fullscreen:a.fullscreen,class:"form-dialog"},{body:U(()=>[C(Pe,{modelValue:s(w),"onUpdate:modelValue":f[0]||(f[0]=h=>ge(w)?w.value=h:null),"fields-layout":a.fieldsLayout,"data-fields":a.dataFields,schemas:a.schemas,"error-messages":a.errorMessages,onSubmit:A,onCancel:S},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),_:1},8,["modelValue","title","fullscreen"]),C(s(Ie),{title:"Error",content:R.value,width:400,height:250,modelValue:B.value,"onUpdate:modelValue":f[2]||(f[2]=h=>B.value=h)},null,8,["content","modelValue"])],64))}};const ta={class:"data-row"},aa={class:"data-col"},la={class:"data-label"},na={key:0,class:"data-value"},sa={key:0},oa={key:1,class:"no-value"},ra={key:1,class:"data-value tags"},ua={key:0,class:"no-value"},ia={__name:"ViewDialog",props:{modelValue:{type:Boolean,default:!1},keys:{type:Array,default(){return[]}},record:{type:Object,default(){return{}}},dataFields:{type:Array,default(){return[]}},title:{type:String,default:"View"},inputLabel:{type:Function,default(a){return a}},inputValue:{type:Function,default(a,l){return l[a]}},includeKeys:{type:Array,default(){return[]}}},emits:["update:modelValue"],setup(a,{emit:l}){const L=a,{formatTag:B,tagStyle:R}=ze(),{tagsField:p}=Ke(L.dataFields),w=i({get:()=>L.modelValue,set:S=>{l("update:modelValue",S)}});function A(){l("update:modelValue",!1)}return(S,m)=>a.record?(u(),E(s(be),{key:0,modelValue:s(w),"onUpdate:modelValue":m[1]||(m[1]=f=>ge(w)?w.value=f:null),title:a.title},{body:U(()=>[D("div",ta,[(u(!0),c(K,null,Q(a.keys,f=>(u(),c("div",aa,[D("div",la,O(a.inputLabel(f)),1),s(p)(f)?y("",!0):(u(),c("div",na,[a.record[f]?(u(),c("div",sa,O(a.inputValue(f,a.record,a.includeKeys,a.dataFields)),1)):y("",!0),a.record[f]?y("",!0):(u(),c("div",oa," --- no value --- "))])),s(p)(f)?(u(),c("div",ra,[(u(!0),c(K,null,Q(a.record[f],h=>(u(),c("div",{class:"tag",style:Me(s(R)(a.record,h,f))},O(s(B)(a.record,h,f)),5))),256)),a.record[f].length===0?(u(),c("div",ua," --- no value --- ")):y("",!0)])):y("",!0)]))),256))])]),actions:U(()=>[C(s(pe),{"button-type":"text",value:"Close",icon:"fa-solid fa-xmark",onClick:m[0]||(m[0]=f=>A())})]),_:1},8,["modelValue","title"])):y("",!0)}},da=Je(ia,[["__scopeId","data-v-f27ca733"]]);const se=a=>(Xt("data-v-d0f65282"),a=a(),Zt(),a),ca={class:"page-container"},fa={class:"heading"},va=se(()=>D("h3",{class:"heading"},"Filters",-1)),ya=["onClick"],ma=se(()=>D("i",{class:"fa-solid fa-sort"},null,-1)),ga=se(()=>D("i",{class:"fa-solid fa-sort-up"},null,-1)),pa=se(()=>D("i",{class:"fa-solid fa-sort-down"},null,-1)),ba={key:0,class:"col"},ha={class:"col"},ka={key:0},Da={key:0},wa={key:1,class:"no-value"},Fa={key:1},Va={key:0,class:"no-value"},Oa=["download","href"],Ca={__name:"DataPage",props:{dataType:{type:String,default:""},modelClass:{type:String,default:null},filters:{type:Object,default:{}},dataFields:{type:Array,default:[]},fieldsLayout:{type:Array,default:[]},validations:{type:Object,default:{}},fullscreen:{type:Boolean,default:!1},createDialogTitle:{type:Function,default:function(a){return`Create ${a}`}},viewDialogTitle:{type:Function,default:function(a,l){return`View ${a} ${l.id}`}},updateDialogTitle:{type:Function,default:function(a,l){return l?`Update ${a} ${l.id}`:""}},deleteDialogTitle:{type:Function,default:function(a,l){return l?`Delete ${a} ${l.id}`:""}},deleteDialogPrimaryText:{type:Function,default:function(a,l){return l?`Are you sure you want to delete ${a} ${l.id}?`:""}},deleteDialogSecondaryText:{type:Function,default:function(a,l){return l?JSON.stringify(l,!1,2):""}},actions:{type:Object,default:{}}},setup(a){const l=a,{schemasMap:L,inputLabel:B,inputValue:R,tagsField:p,formatInputOptionsData:w,formatDataForShow:A,formatDataForSave:S,formatErrorsForDisplay:m,formatFilters:f,fetchOptions:h,initOptionsData:He}=Ke(l.dataFields),{formatDate:Aa,formatTimestamp:Sa,formatTag:qe,tagStyle:Ye}=ze(),Ge=_t(),x=ea();Ht();const he=qt(),Qe=Yt(),We=i(()=>l.dataFields.filter(e=>e.reference)),W=i(()=>We.value.map(e=>e.key)),T=r(Array.from(l.dataFields)),ke=r(!1),oe=r(!1);function De(e,t){return Object.keys(e).reduce((n,o)=>{const d=e[o].map(g=>g(t)).filter(g=>!!g);return d.length>0&&(n[o]=d),n},{})}function Xe(e){T.value=T.value.map(t=>{if(t.type==="enum"){const n=e[t.key].enums,o=Object.keys(n).map(d=>({value:d,label:n[d]}));return Object.assign({},t,{options:o})}else return t})}const Ze=r(l.filters.layout),re=r(!1),N=r({}),we=r(Array.from(l.dataFields)),_e=r({}),et=i(()=>({type:"icon",icon:"fa-solid fa-check"})),tt=i(()=>({type:"icon",icon:"fa-solid fa-filter-circle-xmark"})),at=i(()=>l.dataFields.filter(e=>e.filterable).reduce((e,t)=>(e[t.key]=t,e),{})),ue=i(()=>Object.keys(at.value)),Fe=i(()=>Ze.value&&ke.value&&oe.value),lt=i(()=>l.filters.layout),nt=i(()=>re.value?"filters expanded":"filters collapsed");async function st(e){M.value=0,await P()}async function I(){oe.value=!1,N.value=f(Object.assign({},l.filters.initData));const e=ue.value.map(t=>A(t,N.value));Promise.all(e).then(t=>{ue.value.forEach((n,o)=>{N.value[n]=t[o]}),oe.value=!0,P()})}function ot(){re.value=!re.value}function rt(){we.value=Array.from(T.value).map(e=>{const t=Object.assign({},e);return t.filterable&&(t.type==="date"?t.type="daterange":t.type==="datetime"?t.type="datetimerange":t.type==="number"&&(t.type="numberrange")),t}).filter(e=>e.filterable)}const X=r("id"),J=r(!0),ut=i(()=>({field:X.value,order:J.value?"asc":"desc"})),it=i(()=>l.dataFields.filter(e=>e.sortable).reduce((e,t)=>(e[t.key]=t,e),{})),dt=i(()=>Object.keys(it.value));function ie(e){return dt.value.includes(e)}const ct=i(()=>l.dataFields.reduce((e,t)=>{const n=t.key;return ie(n)&&n===X.value?J.value?e[n]="header-field sort down":e[n]="header-field sort up":ie(n)?e[n]="header-field sort reset":e[n]="header-field nosort",e},{}));async function ft(e){ie(e)&&(e===X.value?J.value=!J.value:(X.value=e,J.value=!0),M.value=0,await P())}const vt=i(()=>{const e={name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(ne){await At()}},t=l.actions.create||{},n=Object.assign({},e,t),o={name:"Export",icon:"fa-solid fa-file-export",click:async function(ne){await Mt()}},v=l.actions.export||{},d=Object.assign({},o,v),g={name:"Filter",icon:"fa-solid fa-filter",click:async function(){ot()}},ve=l.actions.filter||{},ye=Object.assign({},g,ve),V=[n,d];return Fe.value&&V.unshift(ye),V}),yt=i(()=>{const e={name:"View",icon:"fa-solid fa-magnifying-glass",click:async function(V,ne){await Vt(V.id)}},t=l.actions.view||{},n=Object.assign({},e,t),o={name:"Update",icon:"fa-solid fa-pen-to-square",click:async function(V,ne){await Lt(V.id)}},v=l.actions.update||{},d=Object.assign({},o,v),g={name:"Delete",icon:"fa-solid fa-trash-can",click:async function(V,ne){await It(V.id)}},ve=l.actions.remove||{},ye=Object.assign({},g,ve);return[n,d,ye]}),Ve=r([]),Oe=r(0),M=r(0),Ce=r(5),Z=r(!1),mt=i(()=>l.dataFields.filter(e=>e.listable)),gt=i(()=>Ve.value||[]);async function pt(e){M.value=e,await P()}const bt=r({});Qe.registerListener("loadData",{id:`DataPage-${l.dataType}`,invoke:e=>{e.dataType===l.dataType&&P()}});async function ht(){await x.schemas(l.modelClass).then(e=>{const t=e.fields;Xe(t),rt(),ke.value=!0}).catch(e=>{console.error(e),k("Error loading schemas!")})}async function P(){const e={include:W.value,offset:M.value,limit:Ce.value,filters:f(N.value),sort:ut.value};Z.value=!0,await x.list(l.modelClass,e).then(t=>{Ve.value=t.data,Oe.value=t.total,Z.value=!1}).catch(t=>{Z.value=!1,console.error(t),k("Error loading data!")})}async function de(e,t,n){const o={include:W.value};await x.view(l.modelClass,e,o).then(v=>{t(v)}).catch(v=>{n(v)})}function k(e){he.show(e),setTimeout(kt,5e3)}function kt(){he.hide()}const F=r(!1),b=r(""),Dt=i(()=>b.value&&b.value.length>0?(b.value.match(/.{1,100}/g)??[]).join(`
`):""),Ae=i(()=>({width:800,height:400})),ce=r(!1),z=r(),wt=i(()=>l.dataFields.filter(e=>e.viewable).reduce((e,t)=>(e[t.key]=t,e),{})),Ft=i(()=>Object.keys(wt.value));async function Vt(e){de(e,t=>{z.value=t,ce.value=!0},t=>{z.value=null,F.value=!0,b.value=JSON.stringify(t,!1,4)})}const H=r(!1),q=r(),_=r({}),Ot=i(()=>l.dataFields.filter(e=>e.creatable).reduce((e,t)=>(e[t.key]=t,e),{})),fe=i(()=>Object.keys(Ot.value)),Ct=i(()=>l.validations.create||[]);me(H,(e,t)=>{e||(_.value={})});async function At(e){q.value={};const t=fe.value.map(n=>A(n,{}));Promise.all(t).then(n=>{fe.value.forEach((o,v)=>{q.value[o]=n[v],H.value=!0})})}async function St(e){const t=xt(e);if(Object.keys(t).length>0){_.value=t,k("Error creating data!");return}const n=S(e);await x.create(l.modelClass,n).then(o=>{k("Data created successfully!"),I(),Tt()}).catch(o=>{_.value=m(o),k("Error creating data!")})}function xt(e){return De(Ct.value,e)}function Tt(){H.value=!1,jt()}function jt(){q.value=null}const Y=r(!1),j=r(),ee=r({}),$t=i(()=>l.dataFields.filter(e=>e.updatable).reduce((e,t)=>(e[t.key]=t,e),{})),Et=i(()=>Object.keys($t.value)),Ut=i(()=>l.validations.update||[]);me(Y,(e,t)=>{e||(ee.value={})});async function Lt(e){de(e,t=>{Pt(t),Y.value=!0},t=>{Se(),F.value=!0,b.value=JSON.stringify(t,!1,4)})}async function Bt(e){const t=Rt(e);if(Object.keys(t).length>0){ee.value=t,k("Error updating data!");return}const n=e.id,o=S(e);await x.update(l.modelClass,n,o).then(v=>{k("Data updated successfully!"),I(),Nt()}).catch(v=>{ee.value=m(v),k("Error updating data!")})}function Rt(e){return De(Ut.value,e)}function Nt(){Y.value=!1,Se()}async function Pt(e){j.value={};const t=l.dataFields.map(n=>{const o=n.key;return A(o,e)});Promise.all(t).then(n=>{l.dataFields.forEach((o,v)=>{const d=o.key;j.value[d]=n[v]})})}function Se(){j.value=null}const G=r(!1),$=r(),Kt=r({});me(G,(e,t)=>{e||(Kt.value={})});async function It(e){de(e,t=>{$.value=t,G.value=!0},t=>{Te(),F.value=!0,b.value=JSON.stringify(t,!1,4)})}async function Jt(){const t=$.value.id;await x.remove(l.modelClass,t).then(n=>{k("Data deleted successfully!"),I()}).catch(n=>{F.value=!0,b.value=n.map(o=>Ge[o]()).join(", ")}).finally(()=>{xe()})}function xe(){G.value=!1,Te()}function Te(){$.value=null}const te=r(!1),ae=r(),le=r(),je=r("downloadAnchor");async function Mt(){await x.download(l.modelClass).then(e=>{const t=window.URL.createObjectURL(new Blob([e.data]));ae.value=t,le.value=e.filename,te.value=!0}).catch(e=>{F.value=!0,b.value=JSON.stringify(result.error,!1,4)})}function zt(){je.value.click(),$e()}function $e(){te.value=!1,ae.value=null,le.value=null}return Gt(async()=>{await ht(),await P(),await He().then(e=>{bt.value=e}).catch(e=>{F.value=!0,b.value=JSON.stringify(e,!1,4)}),await I()}),(e,t)=>(u(),c("div",ca,[D("h2",fa,O(a.dataType),1),s(Fe)?(u(),c("div",{key:0,class:Ee(s(nt))},[va,C(Pe,{modelValue:N.value,"onUpdate:modelValue":t[0]||(t[0]=n=>N.value=n),"fields-layout":s(lt),"data-fields":s(ue),schemas:we.value,"error-messages":_e.value,"confirm-button":s(et),"cancel-button":s(tt),compact:!0,onSubmit:st,onCancel:I},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"])],2)):y("",!0),C(s(Qt),{name:"",headers:s(mt),data:s(gt),"table-actions":s(vt),actions:s(yt),loading:Z.value,pagination:{offset:M.value,limit:Ce.value,client:!1},"total-data":Oe.value,onOffsetChange:pt},{"header-row":U(({headers:n,actions:o})=>[(u(!0),c(K,null,Q(n,(v,d)=>(u(),c("th",{class:"col",onClick:g=>ft(v.key)},[D("div",{class:Ee(s(ct)[v.key])},[Ue(O(v.label)+" ",1),ma,ga,pa],2)],8,ya))),256)),o.length>0?(u(),c("th",ba)):y("",!0)]),"data-content":U(({headers:n,row:o,i:v})=>[(u(!0),c(K,null,Q(n,d=>(u(),c("td",ha,[Le(e.$slots,`data-col.${d.key}`,Be(Re({header:d,row:o,i:v})),()=>[s(p)(d.key)?y("",!0):(u(),c("div",ka,[o[d.key]?(u(),c("div",Da,O(s(R)(d.key,o,s(W),T.value)),1)):y("",!0),o[d.key]?y("",!0):(u(),c("div",wa," --- no value --- "))])),s(p)(d.key)?(u(),c("div",Fa,[(u(!0),c(K,null,Q(o[d.key],g=>(u(),c("div",{class:"tag",style:Me(s(Ye)(o,g,d.key))},O(s(qe)(o,g,d.key)),5))),256)),o[d.key].length===0?(u(),c("div",Va," --- no value --- ")):y("",!0)])):y("",!0)],!0)]))),256))]),_:3},8,["headers","data","table-actions","actions","loading","pagination","total-data"]),b.value.length>0?(u(),E(s(Ie),{key:1,title:"Error",class:"error-alert",content:s(Dt),width:s(Ae).width,height:s(Ae).height,modelValue:F.value,"onUpdate:modelValue":t[1]||(t[1]=n=>F.value=n)},null,8,["content","width","height","modelValue"])):y("",!0),q.value?(u(),E(Ne,{key:2,modelValue:H.value,"onUpdate:modelValue":t[2]||(t[2]=n=>H.value=n),schemas:T.value,"fields-layout":a.fieldsLayout,"data-fields":s(fe),data:q.value,"dialog-title":a.createDialogTitle(a.dataType),fullscreen:a.fullscreen,"error-messages":_.value,onSubmit:St},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):y("",!0),Le(e.$slots,"updateDialog",Be(Re({row:j.value})),()=>[j.value?(u(),E(Ne,{key:0,modelValue:Y.value,"onUpdate:modelValue":t[3]||(t[3]=n=>Y.value=n),schemas:T.value,"fields-layout":a.fieldsLayout,"data-fields":s(Et),data:j.value,"dialog-title":a.updateDialogTitle(a.dataType,j.value),fullscreen:a.fullscreen,"error-messages":ee.value,onSubmit:Bt},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):y("",!0)],!0),z.value?(u(),E(da,{key:3,modelValue:ce.value,"onUpdate:modelValue":t[4]||(t[4]=n=>ce.value=n),keys:s(Ft),"include-keys":s(W),"data-fields":T.value,record:z.value,title:a.viewDialogTitle(a.dataType,z.value),"input-label":s(B),"input-value":s(R),class:"view-dialog"},null,8,["modelValue","keys","include-keys","data-fields","record","title","input-label","input-value"])):y("",!0),$.value?(u(),E(s(Wt),{key:4,modelValue:G.value,"onUpdate:modelValue":t[5]||(t[5]=n=>G.value=n),title:a.deleteDialogTitle(a.dataType,$.value),"primary-text":a.deleteDialogPrimaryText(a.dataType,$.value),"secondary-text":a.deleteDialogSecondaryText(a.dataType,$.value),width:500,height:350,onConfirm:Jt,onCancel:xe,class:"delete-dialog"},null,8,["modelValue","title","primary-text","secondary-text"])):y("",!0),ae.value?(u(),E(s(be),{key:5,modelValue:te.value,"onUpdate:modelValue":t[8]||(t[8]=n=>te.value=n),title:"Download export file",width:400,height:250},{body:U(()=>[Ue(O(le.value),1)]),actions:U(()=>[D("a",{class:"hidden",ref_key:"downloadAnchor",ref:je,rel:"noreferrer",download:le.value,href:ae.value},null,8,Oa),C(s(pe),{"button-type":"text",value:"Download",icon:"fa-solid fa-file-arrow-down",onClick:t[6]||(t[6]=n=>zt())}),C(s(pe),{"button-type":"text",value:"Cancel",icon:"fa-solid fa-xmark",onClick:t[7]||(t[7]=n=>$e())})]),_:1},8,["modelValue"])):y("",!0)]))}},Ea=Je(Ca,[["__scopeId","data-v-d0f65282"]]);export{Ea as D,Ne as _};
