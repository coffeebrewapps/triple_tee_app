import{v as me,b as y,_ as _e,a as ge,n as Te,u as pe,C as ce,W as Ee,r as f,w as xe,d as he,o as l,c as u,j as r,g as t,T as D,s as j,E as H,e as k,t as $,F as ie,y as ue,k as ye,A as be,p as we,i as De,f as te,q as ae}from"./index-b3ed4318.js";import{_ as ke,D as $e}from"./DataPage-4999849a.js";import{T as Ce}from"./TabContainer-41a4bb62.js";import{u as Ke}from"./input-811f8f86.js";import"./errors-53bc63a8.js";import"./DataForm-ebf3e12e.js";const{isEmpty:Ve,notEarlierThan:Me}=me();function de(){const g=[{key:"id",type:"text",label:"ID",listable:!0,viewable:!0,creatable:!1,updatable:!1,sortable:!0},{key:"startTime",type:"datetime",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetime",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"description",type:"text",label:"Description",defaultValue:()=>"New Task",listable:!0,viewable:!0,creatable:!0,updatable:!0},{key:"content",type:"textarea",label:"Content",listable:!1,viewable:!0,creatable:!0,updatable:!0},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:T},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:B,label:T}}],S=[{startTime:"md",endTime:"md"},{description:"lg"},{content:"lg"},{tags:"lg"}],K={initData:{startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},layout:[{tags:"md"},{startTime:"md"},{endTime:"md"}]},C={create:{endTime:[V]},update:{endTime:[V]}};function B(s){return s.id}function T(s){return`${s.category}:${s.name}`}function V(s){return Me(s,"endTime","startTime")}function M(s){if(s===0)return"0 h 0 m 0 s";const L=Math.floor(s/1e3/60/60/24),W=L*1e3*60*60*24,h=Math.floor((s-W)/1e3/60/60),_=h*1e3*60*60,F=Math.floor((s-W-_)/1e3/60),m=F*1e3*60,Q=Math.floor((s-W-_-m)/1e3),v=[];return L>0&&v.push(`${L} d`),h>0&&v.push(`${h} h`),F>0&&v.push(`${F} m`),Q>0&&v.push(`${Q} s`),v.join(" ")}function A(s){return Ve(s.endTime)?new Date-new Date(s.startTime):new Date(s.endTime)-new Date(s.startTime)}const d=y(()=>g.filter(s=>s.reference)),p=y(()=>d.value.map(s=>s.key));return{dataFields:g,fieldsLayout:S,filters:K,validations:C,formatDuration:M,calculateDuration:A,includeKeys:p,recordValue:B,tagLabel:T}}const Fe=g=>(we("data-v-8fb66cf5"),g=g(),De(),g),Ne={class:"today-logs-container"},Ae={class:"controls"},Ie=["onKeydown"],Oe=["onKeydown"],je=["onKeydown"],He=["onKeydown"],Be=["onKeydown"],Qe={class:"logs"},qe={class:"total"},ze=Fe(()=>r("div",{class:"divider"},null,-1)),Ue={class:"duration"},Pe={class:"start-time"},Ge={key:0,class:"end-time"},Ye={key:1,class:"elapsed"},Je={key:2,class:"elapsed"},Re={class:"description"},Xe={__name:"TodayLog",setup(g){const{isEmpty:S,notEmpty:K}=me(),C=ge(),T=Te().getSystemConfigs(),{formatShortTime:V}=be(),{dataFields:M,fieldsLayout:A,validations:d,formatDuration:p,calculateDuration:s,includeKeys:L}=de(),{formatDataFields:W,validateParams:h,formatDataForShow:_,formatDataForSave:F}=Ke(M),{flashMessage:m}=pe(),Q=ce(),v=Ee(),N=f([]),R=y(()=>M.map(e=>e.key)),E=f({}),se=y(()=>{const e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e}),ne=y(()=>{const e=new Date;return e.setHours(23),e.setMinutes(59),e.setSeconds(59),e}),I=f([]),O=y(()=>I.value.length===0?!1:S(E.value.endTime)&&a.value),X=y(()=>I.value.reduce((e,i)=>e+i.duration,0));function U(e){return e.map(i=>(i.duration=s(i),i))}function q(e){return S(e)?{}:(e.duration=s(e),e)}const n=f(!1),a=f(!1);function o(){return M.reduce((e,i)=>{const c=i.key,ee=i.defaultValue;return K(ee)?e[c]=ee():e[c]=null,e},{})}function b(){E.value=o(),G.value="",n.value=!0}async function x(){E.value=o(),G.value="",await fe()}function P(){n.value=!1}async function fe(){const e=h(d.create,E.value);if(Object.keys(e).length>0){m("Error submitting task!");return}const i=F(E.value);await C.create("work_logs",i).then(c=>{m("Started task successfully!"),Z(),P()}).catch(c=>{console.error(c),m("Error creating data!")})}const z=f(!1),G=f(""),w=f({});xe(z,(e,i)=>{e||(w.value={})});async function Se(){const e=h(d.update,w.value);if(Object.keys(e).length>0){m("Error submitting task!");return}const i=F(w.value);await C.update("work_logs",w.value.id,i).then(c=>{m("Ended task successfully!"),Z(),Le(),G.value==="quick"?x():G.value==="input"&&setTimeout(b,1e3)}).catch(c=>{console.error(c),m("Error submiting task!")})}async function Y(){w.value=Object.assign({},E.value),await _("startTime",w.value).then(e=>{w.value.startTime=e}),await _("tags",w.value).then(e=>{w.value.tags=e}),w.value.endTime=new Date,z.value=!0}function oe(){Y(),G.value="input"}function re(){Y(),G.value="quick"}function Le(){w.value={},z.value=!1}const le=f(!1),J=y(()=>le.value?"shortcut show":"shortcut hide");v.registerListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask",invoke:e=>{b()}}),v.registerListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask",invoke:e=>{x()}}),v.registerListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask",invoke:e=>{Y()}}),v.registerListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask",invoke:e=>{oe()}}),v.registerListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask",invoke:e=>{re()}}),v.registerListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs",invoke:e=>{n.value&&(n.value=!1),z.value&&(z.value=!1)}}),Q.registerListener("loadTodayLogs",{id:"TodayLog",invoke:e=>{Z()}}),Q.registerListener("toggleShortcut",{id:"ToggleTodayLogShortcut",invoke:e=>{le.value=!le.value}});async function We(){await C.schemas("work_logs").then(e=>{const i=e.fields;N.value=W(i)}).catch(e=>{m("Error loading schemas!"),console.error(e)})}async function Z(){const e={include:L.value,filters:{startTime:{startDate:se.value,endDate:ne.value}},sort:{field:"startTime",order:"desc"}};await C.list("work_logs",e).then(i=>{I.value=U(i.data),E.value=q(I.value[0]),K(E.value.startTime)&&(a.value=!0)}).catch(i=>{m("Error loading work logs!"),console.error(i)})}return he(async()=>{await Z(),await We()}),(e,i)=>(l(),u("div",Ne,[r("div",Ae,[t(O)?k("",!0):(l(),u("div",{key:0,class:"button",tabindex:"0",onClick:b,onKeydown:D(b,["enter"])},[j(" Start New Task "),r("div",{class:H(t(J))}," N ",2)],40,Ie)),t(O)?k("",!0):(l(),u("div",{key:1,class:"button",tabindex:"0",onClick:x,onKeydown:D(x,["enter"])},[j(" Quick Start New Task "),r("div",{class:H(t(J))}," Q ",2)],40,Oe)),t(O)?(l(),u("div",{key:2,class:"button",tabindex:"0",onClick:Y,onKeydown:D(Y,["enter"])},[j(" End Current Task "),r("div",{class:H(t(J))}," E ",2)],40,je)):k("",!0),t(O)?(l(),u("div",{key:3,class:"button",tabindex:"0",onClick:oe,onKeydown:D(oe,["enter"])},[j(" End and Start New "),r("div",{class:H(t(J))}," G ",2)],40,He)):k("",!0),t(O)?(l(),u("div",{key:4,class:"button",tabindex:"0",onClick:re,onKeydown:D(re,["enter"])},[j(" End and Quick Start "),r("div",{class:H(t(J))}," F ",2)],40,Be)):k("",!0)]),r("div",Qe,[r("div",qe," Today's total: "+$(t(p)(t(X))),1),(l(!0),u(ie,null,ue(I.value,(c,ee)=>(l(),u("div",{key:ee,class:"log"},[ze,r("div",Ue,[r("div",Pe,$(t(V)(c.startTime,t(T).timezone)),1),t(K)(c.endTime)?(l(),u("div",Ge," to "+$(t(V)(c.endTime,t(T).timezone)),1)):k("",!0),t(K)(c.endTime)?(l(),u("div",Ye," ("+$(t(p)(c.duration))+") ",1)):k("",!0),t(S)(c.endTime)?(l(),u("div",Je," (not ended) ")):k("",!0)]),r("div",Re,$(c.description),1)]))),128))]),ye(ke,{modelValue:n.value,"onUpdate:modelValue":i[0]||(i[0]=c=>n.value=c),schemas:N.value,"fields-layout":t(A),"data-fields":t(R),data:E.value,fullscreen:!0,"dialog-title":"Start Task",onSubmit:fe},null,8,["modelValue","schemas","fields-layout","data-fields","data"]),ye(ke,{modelValue:z.value,"onUpdate:modelValue":i[1]||(i[1]=c=>z.value=c),schemas:N.value,"fields-layout":t(A),"data-fields":t(R),data:w.value,fullscreen:!0,"dialog-title":"End Task",onSubmit:Se},null,8,["modelValue","schemas","fields-layout","data-fields","data"])]))}},Ze=_e(Xe,[["__scopeId","data-v-8fb66cf5"]]);const ve=g=>(we("data-v-ea75fb5c"),g=g(),De(),g),et={class:"weekly-tab-container"},tt={class:"weekly-tabs"},at=["onKeydown"],st=ve(()=>r("i",{class:"fa-solid fa-angle-left"},null,-1)),nt=["onKeydown"],ot=["onKeydown"],rt=ve(()=>r("i",{class:"fa-solid fa-angle-right"},null,-1)),lt={class:"weekly-tab-content"},it={key:0,class:"total"},ut={key:1,class:"total"},ct={class:"timeline"},dt=ve(()=>r("div",{class:"divider"},null,-1)),vt={class:"heading"},ft={class:"date"},yt={key:0,class:"duration"},kt={key:1,class:"duration"},mt={class:"entries"},_t={key:0},gt={class:"description"},Tt={class:"duration"},pt={__name:"WeekLog",props:{loadData:{type:Boolean,default:!1}},setup(g){const S=ge(),C=Te().getSystemConfigs(),{formatLongDate:B}=be(),{formatDuration:T,calculateDuration:V}=de(),{flashMessage:M}=pe(),A=ce(),d=f("this"),p=f({}),s=f(0),L=f("prevWeekTab"),W=f("thisWeekTab"),h=f("nextWeekTab"),_=y(()=>{const n=new Date,a=new Date,o=s.value*7;return d.value==="prev"?(a.setDate(a.getDate()+o),a.setDate(a.getDate()-n.getDay())):(d.value==="next"&&a.setDate(a.getDate()+o),a.setDate(a.getDate()-n.getDay())),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a}),F=y(()=>{const n=new Date;return n.setDate(_.value.getDate()+6),n.setHours(23),n.setMinutes(59),n.setSeconds(59),n}),m=y(()=>Array.from(Array(7)).map((n,a)=>{const o=new Date(_.value);return o.setDate(_.value.getDate()+a),o.setHours(0),o.setMinutes(0),o.setSeconds(0),o})),Q=y(()=>({startTime:{startDate:_.value,endDate:F.value}})),v=y(()=>Object.entries(p.value).reduce((n,[a,{total:o}])=>n+o,0));function N(n){return p.value[n]?p.value[n]:{total:0,entries:[]}}function R(n){const a=m.value.reduce((o,b)=>(o[b]={entries:[],total:0},o),{});return n.forEach(o=>{const b=new Date(o.startTime),x=new Date(b.getFullYear(),b.getMonth(),b.getDate(),0,0,0),P=V(o);a[x].entries.push(Object.assign({},o,{duration:P})),a[x].total=a[x].total+P}),a}A.registerListener("loadWeeklyLogs",{id:"WeekLog",invoke:n=>{q()}});const E=y(()=>d.value==="prev"?"weekly-tab active":"weekly-tab"),se=y(()=>d.value==="this"?"weekly-tab active":"weekly-tab"),ne=y(()=>d.value==="next"?"weekly-tab active":"weekly-tab");async function I(){s.value=s.value-1,d.value="prev",L.value.blur(),await q()}async function O(){s.value=0,d.value="this",W.value.blur(),await q()}async function X(){s.value=s.value+1,d.value="next",h.value.blur(),await q()}function U(n){n==="prev"?L.value.focus():n==="next"?h.value.focus():W.value.focus()}async function q(){const n={filters:Q.value};await S.list("work_logs",n).then(a=>{p.value=R(a.data)}).catch(a=>{M("Error loading work logs!"),console.error(a)})}return he(async()=>{await q()}),(n,a)=>(l(),u("div",et,[r("div",tt,[r("div",{ref_key:"prevWeekTab",ref:L,class:H(t(E)),tabindex:"0",onClick:I,onKeydown:[D(I,["enter"]),a[0]||(a[0]=D(o=>U("this"),["arrow-right"]))]},[st,j(" Prev Week ")],42,at),r("div",{ref_key:"thisWeekTab",ref:W,class:H(t(se)),tabindex:"0",onClick:O,onKeydown:[D(O,["enter"]),a[1]||(a[1]=D(o=>U("prev"),["arrow-left"])),a[2]||(a[2]=D(o=>U("next"),["arrow-right"]))]}," This Week ",42,nt),r("div",{ref_key:"nextWeekTab",ref:h,class:H(t(ne)),tabindex:"0",onClick:X,onKeydown:[D(X,["enter"]),a[3]||(a[3]=D(o=>U("this"),["arrow-left"]))]},[j(" Next Week "),rt],42,ot)]),r("div",lt,[t(v)>0?(l(),u("div",it," Week's total: "+$(t(T)(t(v))),1)):k("",!0),t(v)===0?(l(),u("div",ut," Week's total: 0 h 0 m 0 s ")):k("",!0),r("div",ct,[(l(!0),u(ie,null,ue(t(m),(o,b)=>(l(),u("div",{key:b,class:"day"},[dt,r("div",vt,[r("div",ft,$(t(B)(o,t(C).timezone)),1),N(o).total>0?(l(),u("div",yt," ("+$(t(T)(N(o).total))+") ",1)):k("",!0),N(o).total===0?(l(),u("div",kt," (0 h 0 m 0 s) ")):k("",!0)]),r("div",mt,[N(o).entries.length===0?(l(),u("div",_t," No entry ")):k("",!0),(l(!0),u(ie,null,ue(N(o).entries,(x,P)=>(l(),u("div",{key:P,class:"entry"},[r("div",gt,$(x.description),1),r("div",Tt,$(t(T)(x.duration)),1)]))),128))])]))),128))])])]))}},ht=_e(pt,[["__scopeId","data-v-ea75fb5c"]]),Et={__name:"WorkLogs",setup(g){const S=ce(),{dataFields:K,fieldsLayout:C,filters:B,validations:T,formatDuration:V,calculateDuration:M}=de(),A={oneline:!0,showHeader:!1,highlightField:"description"},d=f(0),p=[{label:"Today",onchange:s},{label:"Weekly",onchange:L},{label:"All Logs",onchange:W}];function s(){S.emitEvent("loadTodayLogs",{})}function L(){S.emitEvent("loadWeeklyLogs",{})}function W(){S.emitEvent("loadData",{dataType:"Work Logs"})}async function h(_){await p[_].onchange(),d.value=_}return(_,F)=>(l(),te(Ce,{tabs:p,"selected-tab":d.value,onTabChange:h},{"tab-0":ae(()=>[d.value===0?(l(),te(Ze,{key:0})):k("",!0)]),"tab-1":ae(()=>[d.value===1?(l(),te(ht,{key:0})):k("",!0)]),"tab-2":ae(()=>[d.value===2?(l(),te($e,{key:0,"model-class":"work_logs","data-type":"Work Logs",fullscreen:!0,"fields-layout":t(C),"data-fields":t(K),validations:t(T),filters:t(B),"table-style":A},{["data-col.startTime"]:ae(({row:m})=>[j(" Total duration "),r("strong",null,$(t(V)(t(M)(m))),1)]),_:2},1032,["fields-layout","data-fields","validations","filters"])):k("",!0)]),_:1},8,["selected-tab"]))}};export{Et as default};
