import{c as f,_ as fe,b as ye,m as we,a as me,q as oe,D as Ce,r as y,w as Ie,o as ke,d as c,e as d,j as i,h as a,E as C,z as J,G as Q,f as D,t as N,F as de,y as ve,k as G,C as De,p as _e,i as pe,g as Ve,x as ne}from"./index-b3128bd9.js";import{a as ie,u as Se,F as Fe}from"./Form-77967d6a.js";import{_ as be,D as Ke}from"./DataPage-726cf7ba.js";import{T as Me}from"./TabContainer-8746c156.js";import Ne from"./CreateInvoice-1b35796b.js";import"./errors-a6177d44.js";import"./utils-47359872.js";import"./TemplateEditor-4d9b7e97.js";const{isEmpty:Be,notEarlierThan:Oe}=ie();function le(){const m=[{key:"id",type:"text",label:"ID",listable:!0,viewable:!0,creatable:!1,updatable:!1,sortable:!0},{key:"startTime",type:"datetime",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetime",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"description",type:"text",label:"Description",defaultValue:()=>"New Task",listable:!0,viewable:!0,creatable:!0,updatable:!0},{key:"content",type:"textarea",label:"Content",listable:!1,viewable:!0,creatable:!0,updatable:!0},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:g},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:V,label:g}}],p=[{startTime:"md",endTime:"md"},{description:"lg"},{content:"lg"},{tags:"lg"}],W={initData:{startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},layout:[{tags:"md"},{startTime:"md"},{endTime:"md"}]},S={create:{endTime:[w]},update:{endTime:[w]}};function V(s){return s.id}function g(s){return`${s.category}:${s.name}`}function w(s){return Oe(s,"endTime","startTime")}function h(s){if(s===0)return"0 h 0 m 0 s";const x=Math.floor(s/1e3/60/60/24),$=x*1e3*60*60*24,F=Math.floor((s-$)/1e3/60/60),K=F*1e3*60*60,B=Math.floor((s-$-K)/1e3/60),O=B*1e3*60,l=Math.floor((s-$-K-O)/1e3),b=[];return x>0&&b.push(`${x} d`),F>0&&b.push(`${F} h`),B>0&&b.push(`${B} m`),l>0&&b.push(`${l} s`),b.join(" ")}function L(s){return Be(s.endTime)?new Date-new Date(s.startTime):new Date(s.endTime)-new Date(s.startTime)}const _=f(()=>m.filter(s=>s.reference)),T=f(()=>_.value.map(s=>s.key));return{dataFields:m,fieldsLayout:p,filters:W,validations:S,formatDuration:h,calculateDuration:L,includeKeys:T,recordValue:V,tagLabel:g}}const Ae=m=>(_e("data-v-1ed67e39"),m=m(),pe(),m),je={class:"today-logs-container"},qe={class:"controls"},He=["onKeydown"],Ue=["onKeydown"],Qe=["onKeydown"],Ge=["onKeydown"],Pe=["onKeydown"],ze={class:"logs"},Ye={class:"total"},Je={class:"log"},Re=Ae(()=>i("div",{class:"divider"},null,-1)),Xe={class:"duration"},Ze={class:"start-time"},et={key:0,class:"end-time"},tt={key:1,class:"elapsed"},at={key:2,class:"elapsed"},st={class:"description"},nt={__name:"TodayLog",setup(m){const{isEmpty:p,notEmpty:W}=ie(),S=ye();we();const{formatShortTime:V}=De(),{dataFields:g,fieldsLayout:w,filters:h,validations:L,formatDuration:_,calculateDuration:T,includeKeys:s}=le(),{formatDataFields:x,validateParams:$,formatDataForShow:F,formatDataForSave:K,fetchOptions:B,initOptionsData:O}=Se(g),l=me(),b=oe(),M=Ce(),A=y([]),v=f(()=>g.map(e=>e.key)),r=y({}),Z=f(()=>{const e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e}),ae=f(()=>{const e=new Date;return e.setHours(23),e.setMinutes(59),e.setSeconds(59),e}),j=y([]),q=f(()=>j.value.length===0?!1:p(r.value.endTime)&&n.value),R=f(()=>j.value.reduce((e,u)=>e+u.duration,0));function P(e){return e.map(u=>(u.duration=T(u),u))}function o(e){return p(e)?{}:(e.duration=T(e),e)}const t=y(!1),n=y(!1);function I(){return g.reduce((e,u)=>{const k=u.key,Te=u.defaultValue;return W(Te)?e[k]=Te():e[k]=null,e},{})}function H(){r.value=I(),X.value="",t.value=!0}async function z(){r.value=I(),X.value="",await he()}function Le(){t.value=!1}async function he(){const e=$(L.create,r.value);if(Object.keys(e).length>0){U("Error submitting task!");return}const u=K(r.value);await S.create("work_logs",u).then(k=>{U("Started task successfully!"),se(),Le()}).catch(k=>{U("Error creating data!")})}const Y=y(!1),X=y(""),E=y({});Ie(Y,(e,u)=>{e||(E.value={})});async function $e(){const e=$(L.update,E.value);if(Object.keys(e).length>0){U("Error submitting task!");return}const u=K(E.value);await S.update("work_logs",E.value.id,u).then(k=>{U("Ended task successfully!"),se(),We(),X.value==="quick"?z():X.value==="input"&&setTimeout(H,1e3)}).catch(k=>{U("Error submiting task!")})}async function ee(){E.value=Object.assign({},r.value),await F("startTime",E.value).then(e=>{E.value.startTime=e}),await F("tags",E.value).then(e=>{E.value.tags=e}),E.value.endTime=new Date,Y.value=!0}function re(){ee(),X.value="input"}function ue(){ee(),X.value="quick"}function We(){E.value={},Y.value=!1}const ce=y(!1),te=f(()=>ce.value?"shortcut show":"shortcut hide");M.registerListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask",invoke:e=>{H()}}),M.registerListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask",invoke:e=>{z()}}),M.registerListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask",invoke:e=>{ee()}}),M.registerListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask",invoke:e=>{re()}}),M.registerListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask",invoke:e=>{ue()}}),M.registerListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs",invoke:e=>{t.value&&(t.value=!1),Y.value&&(Y.value=!1)}});function U(e){l.show(e),setTimeout(xe,5e3)}function xe(){l.hide()}b.registerListener("loadTodayLogs",{id:"TodayLog",invoke:e=>{se()}}),b.registerListener("toggleShortcut",{id:"ToggleTodayLogShortcut",invoke:e=>{ce.value=!ce.value}});async function Ee(){await S.schemas("work_logs").then(e=>{const u=e.fields;A.value=x(u)}).catch(e=>{U("Error loading schemas!"),console.log(e)})}async function se(){const e={include:s.value,filters:{startTime:{startDate:Z.value,endDate:ae.value}},sort:{field:"startTime",order:"desc"}};await S.list("work_logs",e).then(u=>{j.value=P(u.data),r.value=o(j.value[0]),W(r.value.startTime)&&(n.value=!0)}).catch(u=>{U("Error loading work logs!"),console.log(u)})}return ke(async()=>{await se(),await Ee()}),(e,u)=>(c(),d("div",je,[i("div",qe,[a(q)?D("",!0):(c(),d("div",{key:0,class:"button",tabindex:"0",onClick:H,onKeydown:C(H,["enter"])},[J(" Start New Task "),i("div",{class:Q(a(te))},"N",2)],40,He)),a(q)?D("",!0):(c(),d("div",{key:1,class:"button",tabindex:"0",onClick:z,onKeydown:C(z,["enter"])},[J(" Quick Start New Task "),i("div",{class:Q(a(te))},"Q",2)],40,Ue)),a(q)?(c(),d("div",{key:2,class:"button",tabindex:"0",onClick:ee,onKeydown:C(ee,["enter"])},[J(" End Current Task "),i("div",{class:Q(a(te))},"E",2)],40,Qe)):D("",!0),a(q)?(c(),d("div",{key:3,class:"button",tabindex:"0",onClick:re,onKeydown:C(re,["enter"])},[J(" End and Start New "),i("div",{class:Q(a(te))},"G",2)],40,Ge)):D("",!0),a(q)?(c(),d("div",{key:4,class:"button",tabindex:"0",onClick:ue,onKeydown:C(ue,["enter"])},[J(" End and Quick Start "),i("div",{class:Q(a(te))},"F",2)],40,Pe)):D("",!0)]),i("div",ze,[i("div",Ye," Today's total: "+N(a(_)(a(R))),1),(c(!0),d(de,null,ve(j.value,k=>(c(),d("div",Je,[Re,i("div",Xe,[i("div",Ze,N(a(V)(k.startTime)),1),a(W)(k.endTime)?(c(),d("div",et," to "+N(a(V)(k.endTime)),1)):D("",!0),a(W)(k.endTime)?(c(),d("div",tt," ("+N(a(_)(k.duration))+") ",1)):D("",!0),a(p)(k.endTime)?(c(),d("div",at," (not ended) ")):D("",!0)]),i("div",st,N(k.description),1)]))),256))]),G(be,{modelValue:t.value,"onUpdate:modelValue":u[0]||(u[0]=k=>t.value=k),schemas:A.value,"fields-layout":a(w),"data-fields":a(v),data:r.value,fullscreen:!0,"dialog-title":"Start Task",onSubmit:he},null,8,["modelValue","schemas","fields-layout","data-fields","data"]),G(be,{modelValue:Y.value,"onUpdate:modelValue":u[1]||(u[1]=k=>Y.value=k),schemas:A.value,"fields-layout":a(w),"data-fields":a(v),data:E.value,fullscreen:!0,"dialog-title":"End Task",onSubmit:$e},null,8,["modelValue","schemas","fields-layout","data-fields","data"])]))}},ot=fe(nt,[["__scopeId","data-v-1ed67e39"]]);const ge=m=>(_e("data-v-03ddef01"),m=m(),pe(),m),it={class:"weekly-tab-container"},lt={class:"weekly-tabs"},rt=["onKeydown"],ut=ge(()=>i("i",{class:"fa-solid fa-angle-left"},null,-1)),ct=["onKeydown"],dt=["onKeydown"],vt=ge(()=>i("i",{class:"fa-solid fa-angle-right"},null,-1)),ft={class:"weekly-tab-content"},yt={key:0,class:"total"},mt={key:1,class:"total"},kt={class:"timeline"},_t={class:"day"},pt=ge(()=>i("div",{class:"divider"},null,-1)),gt={class:"heading"},ht={class:"date"},Tt={key:0,class:"duration"},bt={key:1,class:"duration"},wt={class:"entries"},Dt={key:0},St={class:"entry"},Lt={class:"description"},$t={class:"duration"},Wt={__name:"WeekLog",props:{loadData:{type:Boolean,default:!1}},setup(m){ie();const p=ye();we();const{formatLongDate:W}=De(),{formatDuration:S,calculateDuration:V}=le(),g=me(),w=oe(),h=y("this"),L=y({}),_=y(0),T=y("prevWeekTab"),s=y("thisWeekTab"),x=y("nextWeekTab"),$=f(()=>{const o=new Date,t=new Date,n=_.value*7;return h.value==="prev"?(t.setDate(t.getDate()+n),t.setDate(t.getDate()-o.getDay())):(h.value==="next"&&t.setDate(t.getDate()+n),t.setDate(t.getDate()-o.getDay())),t.setHours(0),t.setMinutes(0),t.setSeconds(0),t}),F=f(()=>{const o=new Date;return o.setDate($.value.getDate()+6),o.setHours(23),o.setMinutes(59),o.setSeconds(59),o}),K=f(()=>Array.from(Array(7)).map((o,t)=>{const n=new Date($.value);return n.setDate($.value.getDate()+t),n.setHours(0),n.setMinutes(0),n.setSeconds(0),n})),B=f(()=>({startTime:{startDate:$.value,endDate:F.value}})),O=f(()=>Object.entries(L.value).reduce((o,[t,{total:n}])=>o+n,0));function l(o){return L.value[o]?L.value[o]:{total:0,entries:[]}}function b(o){const t=K.value.reduce((n,I)=>(n[I]={entries:[],total:0},n),{});return o.forEach(n=>{const I=new Date(n.startTime),H=new Date(I.getFullYear(),I.getMonth(),I.getDate(),0,0,0),z=V(n);t[H].entries.push(Object.assign({},n,{duration:z})),t[H].total=t[H].total+z}),t}function M(o){g.show(o),setTimeout(A,5e3)}function A(){g.hide()}w.registerListener("loadWeeklyLogs",{id:"WeekLog",invoke:o=>{P()}});const v=f(()=>h.value==="prev"?"weekly-tab active":"weekly-tab"),r=f(()=>h.value==="this"?"weekly-tab active":"weekly-tab"),Z=f(()=>h.value==="next"?"weekly-tab active":"weekly-tab");async function ae(){_.value=_.value-1,h.value="prev",T.value.blur(),await P()}async function j(){_.value=0,h.value="this",s.value.blur(),await P()}async function q(){_.value=_.value+1,h.value="next",x.value.blur(),await P()}function R(o){o==="prev"?T.value.focus():o==="next"?x.value.focus():s.value.focus()}async function P(){const o={filters:B.value};await p.list("work_logs",o).then(t=>{L.value=b(t.data)}).catch(t=>{M("Error loading work logs!"),console.log(t)})}return ke(async()=>{await P()}),(o,t)=>(c(),d("div",it,[i("div",lt,[i("div",{class:Q(a(v)),tabindex:"0",ref_key:"prevWeekTab",ref:T,onClick:ae,onKeydown:[C(ae,["enter"]),t[0]||(t[0]=C(n=>R("this"),["arrow-right"]))]},[ut,J(" Prev Week ")],42,rt),i("div",{class:Q(a(r)),tabindex:"0",ref_key:"thisWeekTab",ref:s,onClick:j,onKeydown:[C(j,["enter"]),t[1]||(t[1]=C(n=>R("prev"),["arrow-left"])),t[2]||(t[2]=C(n=>R("next"),["arrow-right"]))]}," This Week ",42,ct),i("div",{class:Q(a(Z)),tabindex:"0",ref_key:"nextWeekTab",ref:x,onClick:q,onKeydown:[C(q,["enter"]),t[3]||(t[3]=C(n=>R("this"),["arrow-left"]))]},[J(" Next Week "),vt],42,dt)]),i("div",ft,[a(O)>0?(c(),d("div",yt," Week's total: "+N(a(S)(a(O))),1)):D("",!0),a(O)===0?(c(),d("div",mt," Week's total: 0 h 0 m 0 s ")):D("",!0),i("div",kt,[(c(!0),d(de,null,ve(a(K),n=>(c(),d("div",_t,[pt,i("div",gt,[i("div",ht,N(a(W)(n)),1),l(n).total>0?(c(),d("div",Tt," ("+N(a(S)(l(n).total))+") ",1)):D("",!0),l(n).total===0?(c(),d("div",bt," (0 h 0 m 0 s) ")):D("",!0)]),i("div",wt,[l(n).entries.length===0?(c(),d("div",Dt," No entry ")):D("",!0),(c(!0),d(de,null,ve(l(n).entries,I=>(c(),d("div",St,[i("div",Lt,N(I.description),1),i("div",$t,N(a(S)(I.duration)),1)]))),256))])]))),256))])])]))}},xt=fe(Wt,[["__scopeId","data-v-03ddef01"]]),Et={class:"view-template"},Ct=i("div",{class:"divider"},null,-1),It={__name:"GenerateInvoice",props:{},setup(m){const{dataFields:p,recordValue:W,tagLabel:S,calculateDuration:V}=le();function g(v){return`Every ${v.invoiceCycleDurationValue} ${v.invoiceCycleDurationUnit}, due in ${v.dueDateCycleValue} ${v.dueDateCycleUnit}`}const w=f(()=>{const v=[];return v.push(Object.assign({},p.find(r=>r.key==="tags"))),v.push(Object.assign({},p.find(r=>r.key==="startTime"),{type:"datetimerange"})),v.push(Object.assign({},p.find(r=>r.key==="endTime"),{type:"datetimerange"})),v.push({key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",updatable:!0,reference:{label:g},options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:W,label:g}}),v}),h=Se(w.value);ie();const L=ye(),_=me();oe();const T=y({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}),s=f(()=>[{invoiceConfigId:"lg",tags:"lg"},{startTime:"md"},{endTime:"md"}]),x=f(()=>w.value.map(v=>v.key)),$=y({}),F=f(()=>({type:"text",value:"Filter",icon:"fa-solid fa-check"})),K=f(()=>({type:"text",value:"Cancel",icon:"fa-solid fa-xmark"}));function B(v){_.show(v),setTimeout(O,5e3)}function O(){_.hide()}const l=y(),b=y(!1);async function M(){b.value=!1;const v=h.formatFilters(T.value);L.create("work_logs",v,{path:"preview_invoice"}).then(r=>{l.value=r,l.value.invoice.invoiceDate=new Date(l.value.invoice.invoiceDate),l.value.invoice.dueDate=new Date(l.value.invoice.dueDate),b.value=!0}).catch(r=>{console.error(r),B("Error previewing invoice!")})}function A(){b.value=!1,T.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}return ke(()=>{A()}),(v,r)=>(c(),d("div",Et,[G(Fe,{modelValue:T.value,"onUpdate:modelValue":r[0]||(r[0]=Z=>T.value=Z),"fields-layout":a(s),"data-fields":a(x),schemas:a(w),"error-messages":$.value,"confirm-button":a(F),"cancel-button":a(K),onSubmit:M,onCancel:A},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"]),Ct,b.value?(c(),Ve(Ne,{key:0,invoice:l.value.invoice,"invoice-lines":l.value.invoiceLines,"invoice-config":l.value.invoiceConfig,"invoice-number-sequence":l.value.invoiceNumberSequence,contact:l.value.billingContact,"invoice-template":l.value.invoiceTemplate,currency:l.value.currency},null,8,["invoice","invoice-lines","invoice-config","invoice-number-sequence","contact","invoice-template","currency"])):D("",!0)]))}};const Vt=m=>(_e("data-v-a39d22c7"),m=m(),pe(),m),Ft={class:"view-container"},Kt=Vt(()=>i("h2",{class:"heading"},"Time Tracking",-1)),Mt={__name:"WorkLogs",setup(m){const p=oe(),{dataFields:W,fieldsLayout:S,filters:V,validations:g}=le(),w=[{label:"Today",onchange:h},{label:"Weekly",onchange:L},{label:"Generate Invoice",onchange:()=>{}},{label:"All Logs",onchange:_}];function h(){p.emitEvent("loadTodayLogs",{})}function L(){p.emitEvent("loadWeeklyLogs",{})}function _(){p.emitEvent("loadData",{dataType:"Work Logs"})}function T(s){w[s].onchange()}return(s,x)=>(c(),d("div",Ft,[Kt,G(Me,{tabs:w,onTabChange:T},{"tab-0":ne(()=>[G(ot)]),"tab-1":ne(()=>[G(xt)]),"tab-2":ne(()=>[G(It)]),"tab-3":ne(()=>[G(Ke,{"model-class":"work_logs","data-type":"Work Logs",fullscreen:!0,"fields-layout":a(S),"data-fields":a(W),validations:a(g),filters:a(V)},null,8,["fields-layout","data-fields","validations","filters"])]),_:1})]))}},Qt=fe(Mt,[["__scopeId","data-v-a39d22c7"]]);export{Qt as default};
