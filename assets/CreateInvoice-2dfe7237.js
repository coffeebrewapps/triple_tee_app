import{_ as ue,r as i,c as o,a as r,b as S,h as f,F as oe,m as ie,z as Ae,t as ce,d as k,R as Oe,T as Pe,A as ze,B as Be,D as Me,f as s,e as T,S as B,j as qe,u as He,o as Re,i as V,l as m,C as We,W as j,J as Ke,n as Je,p as Ge,g as Qe}from"./index-7f6b454a.js";import{a as Xe,u as M,F as re}from"./Form-a68d0e25.js";import{a as Ye}from"./dataAccess-5c645c6d.js";import{u as Ze}from"./utils-f0e90f1f.js";import{T as et}from"./TemplateEditor-7d1e9c58.js";import"./errors-a6177d44.js";import"./TabContainer-47d05ef3.js";const tt={class:"workflow-container"},at={class:"step-breadcrumbs"},nt={class:"title"},lt={key:0,class:"fa-solid fa-caret-right"},st={class:"step-container"},ot={class:"actions"},it={__name:"WorkflowContainer",props:{steps:{type:Array,default(){return[]}}},emits:["prevStep","nextStep","submit"],setup(v,{emit:x}){const b=v,n=i(0);o(()=>b.steps[n.value]);const N=o(()=>n.value<b.steps.length-1&&n.value>0),$=o(()=>n.value<b.steps.length-1),A=o(()=>{if(b.steps.length===1)return!0;n.value,b.steps.length-2});function U(){n.value>0&&(n.value=n.value-1,x("prevStep",n.value))}function q(){n.value<b.steps.length-1&&(n.value=n.value+1,x("nextStep",n.value))}function H(){x("submit")}function R(F){return n.value===F?"step-breadcrumb active":"step-breadcrumb"}return(F,g)=>(r(),S("div",tt,[f("div",at,[(r(!0),S(oe,null,ie(v.steps,(y,h)=>(r(),S("div",{class:Ae(R(h))},[f("div",nt,ce(y.title),1),h!==v.steps.length-1?(r(),S("i",lt)):k("",!0)],2))),256))]),(r(!0),S(oe,null,ie(v.steps,(y,h)=>Oe((r(),S("div",st,[ze(F.$slots,`step-${h}`,Be(Me({step:y,i:h})),void 0,!0)],512)),[[Pe,n.value===h]])),256)),f("div",ot,[s(N)?(r(),T(s(B),{key:0,value:"Prev Step",icon:"fa-solid fa-arrow-left",onClick:g[0]||(g[0]=y=>U())})):k("",!0),s($)?(r(),T(s(B),{key:1,value:"Next Step",icon:"fa-solid fa-arrow-right",onClick:g[1]||(g[1]=y=>q())})):k("",!0),s(A)?(r(),T(s(B),{key:2,value:"Submit",icon:"fa-solid fa-check",onClick:g[2]||(g[2]=y=>H())})):k("",!0)])]))}},rt=ue(it,[["__scopeId","data-v-fc5b0051"]]);const ut=v=>(Ge("data-v-3fafb329"),v=v(),Qe(),v),ct={class:"page-container"},dt=ut(()=>f("h3",{class:"heading"},"Create Invoice",-1)),vt={class:"data-col"},pt={class:"data-col"},mt={class:"data-col"},ft={class:"data-col"},bt={class:"data-col"},gt={__name:"CreateInvoice",setup(v){const x=qe(),{isEmpty:b,notEmpty:n}=Xe(),N=Ye(),$=He(),A=Object.assign({},x.currentRoute.value),U=o(()=>A.query.contactId),{worklogsUrl:q,invoicesUrl:H,invoiceLinesUrl:R,contactsUrl:F,invoiceConfigsUrl:g,templatesUrl:y,tagsUrl:h,generateDataFields:de,recordValue:O,tagLabel:W,contactLabel:K,currencyLabel:yt,invoiceConfigLabel:J}=Ze(),D=i({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}});n(U.value)&&(D.value.invoiceConfigId=[{value:U.value}]);const P=o(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:K},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",sourceUrl:F,value:O,label:K}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:J},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",sourceUrl:g,value:O,label:J}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:W},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",sourceUrl:h,value:O,label:W}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),ve=M(P.value),pe=o(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),me=o(()=>P.value.map(e=>e.key)),fe=i({});o(()=>({type:"text",value:"Filter",icon:"fa-solid fa-check"})),o(()=>({type:"text",value:"Cancel",icon:"fa-solid fa-xmark"}));function G(){u.value=null,d.value=[],L.value=null}async function be(e){const t=Z.value.map(a=>ee.formatDataForShow(a,e));Promise.all(t).then(a=>{u.value={},Z.value.forEach((l,c)=>{u.value[l]=a[c]}),u.value.totalAmount=te.value}).catch(a=>{E("Error generating invoice!"),console.error(a)})}async function ge(e){await be(Object.assign({},e.invoice)),d.value=e.invoiceLines.map(t=>we(t)),ae.value=Object.assign({},e.invoiceConfig),_.value=Object.assign({},e.invoiceNumberSequence),ne.value=Object.assign({},e.billingContact),le.value=Object.assign({},e.currency),L.value=Object.assign({},e.invoiceTemplate)}async function ye(){G(),C.value=!0;const e=ve.formatFilters(D.value);N.create("invoices",e,{path:"preview_invoice"}).then(t=>{ge(t),C.value=!1}).catch(t=>{console.error(t),E("Error previewing invoice!")})}function he(){G(),D.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}const Q=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],_e=M(Q),d=i([]),Ce=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await ke()}}],Ve=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,t){await X(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,t){await Ie(t)}}],C=i(!1),Se=o(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function ke(){C.value=!0,d.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),C.value=!1}function Ie(e){C.value=!0,d.value.splice(e,1),C.value=!1}function we(e){const t={};return t.description=e.description,t.unit=e.unit,t.unitCost=I(e.unitCost),t.unitValue=I(e.unitValue),b(e.subtotal)?X(t):t.subtotal=I(e.subtotal),t}function I(e){return(e||0).toFixed(2)}function X(e){const t=e.unitCost,a=e.unitValue;n(t)&&n(a)?e.subtotal=I(parseFloat(t)*parseFloat(a)):e.subtotal=I(0),u.value.totalAmount=te.value}const Le=i([]);function w(e,t){return Le[e]?w[e][t]:""}const u=i(),Y=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],Te=o(()=>Y.reduce((e,t)=>(Object.keys(t).forEach(a=>{e.push(a)}),e),[])),z=o(()=>de(U.value)),Z=o(()=>z.value.map(e=>e.key)),ee=M(z.value);o(()=>{const e=[];return n(_.value.prefix)&&e.push(_.value.prefix),e.push(_.value.currentSequence),n(_.value.suffix)&&e.push(_.value.suffix),e.join("-")});const te=o(()=>{const e=d.value.reduce((t,a)=>n(a.subtotal)?t+parseFloat(a.subtotal):t,0);return I(e)}),xe=i({}),L=i(),ae=i(),_=i(),ne=i(),le=i(),Ue=o(()=>({invoice:u.value,invoiceLines:d.value,invoiceConfig:ae.value,invoiceNumberSequence:_.value,billingContact:ne.value,currency:le.value}));async function Fe(){return new Promise((e,t)=>{const a=d.value.map(l=>_e.formatDataForSave(l));Promise.all(a).then(l=>{e(l)}).catch(l=>{t(l)})})}async function se(){await Fe().then(e=>{const t=Object.assign({},{invoice:ee.formatDataForSave(u.value),invoiceNumberSequence:_.value,invoiceLines:e});N.create("invoices",t,{path:"generate_with_lines"}).then(a=>{u.value.id=a.id,d.value=a.invoiceLines,E("Invoice created successfully!")}).catch(a=>{E("Error creating invoice!"),console.error(a)})}).catch(e=>{E("Error formatting invoice for save!"),console.error(e)})}function E(e){$.show(e),setTimeout(De,5e3)}function De(){$.hide()}const Ee=o(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function Ne(e){}async function $e(e){e===1?await ye():e===2&&await se()}async function je(){await se()}return Re(()=>{he()}),(e,t)=>(r(),S("div",ct,[dt,V(rt,{steps:s(Ee),onPrevStep:Ne,onNextStep:$e,onSubmit:je},{"step-0":m(()=>[V(re,{modelValue:D.value,"onUpdate:modelValue":t[0]||(t[0]=a=>D.value=a),"fields-layout":s(pe),"data-fields":s(me),schemas:s(P),"error-messages":fe.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":m(()=>[u.value?(r(),T(re,{key:0,modelValue:u.value,"onUpdate:modelValue":t[1]||(t[1]=a=>u.value=a),"fields-layout":Y,"data-fields":s(Te),schemas:s(z),"error-messages":xe.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):k("",!0),u.value?(r(),T(s(We),{key:1,name:"Invoice Lines",headers:Q,data:d.value,"table-actions":Ce,actions:Ve,loading:C.value,pagination:{offset:0,limit:d.value.length,client:!0}},{"data-col.description":m(({headers:a,row:l,i:c})=>[f("div",vt,[V(s(j),{modelValue:l.description,"onUpdate:modelValue":p=>l.description=p,type:"text",label:"",size:"lg","error-message":w(c,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),"data-col.unitCost":m(({headers:a,row:l,i:c})=>[f("div",pt,[V(s(j),{modelValue:l.unitCost,"onUpdate:modelValue":p=>l.unitCost=p,type:"number",label:"",size:"sm","error-message":w(c,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),"data-col.unit":m(({headers:a,row:l,i:c})=>[f("div",mt,[V(s(Ke),{modelValue:l.unit,"onUpdate:modelValue":p=>l.unit=p,type:"text",label:"",size:"md",options:s(Se),"error-message":w(c,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),"data-col.unitValue":m(({headers:a,row:l,i:c})=>[f("div",ft,[V(s(j),{modelValue:l.unitValue,"onUpdate:modelValue":p=>l.unitValue=p,type:"number",label:"",size:"sm","error-message":w(c,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),"data-col.subtotal":m(({headers:a,row:l,i:c})=>[f("div",bt,[V(s(j),{modelValue:l.subtotal,"onUpdate:modelValue":p=>l.subtotal=p,type:"number",label:"",size:"sm","error-message":w(c,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:m(({total:a})=>[Je(" Total Lines: "+ce(a),1)]),_:1},8,["data","loading","pagination"])):k("",!0)]),"step-2":m(()=>[L.value?(r(),T(et,{key:0,"templates-url":s(y),id:L.value.id,"content-markup":L.value.contentMarkup,"content-styles":L.value.contentStyles,data:s(Ue),disabled:!0,"template-type":"invoice_templates"},null,8,["templates-url","id","content-markup","content-styles","data"])):k("",!0)]),_:1},8,["steps"])]))}},wt=ue(gt,[["__scopeId","data-v-3fafb329"]]);export{wt as default};
