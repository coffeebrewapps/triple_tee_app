import{_ as Ie,n as he,a as Le,u as ke,c as u,r as o,o as Te,b as I,d as Se,k as v,v as c,g as l,f as D,e as U,h as Fe,j as f,B as h,l as we,z as De,t as Ue,p as xe,i as Ee}from"./index-522b32ec.js";import{u as je}from"./validations-9a1af222.js";import{u as x}from"./input-ae6e7048.js";import{u as Ne}from"./utils-7b0831a9.js";import{W as Oe}from"./WorkflowContainer-759985ee.js";import{D as G}from"./DataForm-8f7f0e0d.js";import{T as Ae}from"./TemplateEditor-5f1015af.js";import"./errors-53bc63a8.js";import"./TabContainer-e6b87ac2.js";const Me=V=>(xe("data-v-5a82329e"),V=V(),Ee(),V),ze={class:"page-container"},Be=Me(()=>f("h3",{class:"heading"}," Create Invoice ",-1)),He={class:"data-col"},qe={class:"data-col"},Pe={class:"data-col"},Re={class:"data-col"},Ke={class:"data-col"},We={__name:"CreateInvoice",setup(V){const J=he(),{isEmpty:Q,notEmpty:_}=je(),E=Le(),{flashMessage:g}=ke(),X=Object.assign({},J.currentRoute.value),L=u(()=>X.query.contactId),{generateDataFields:Y,recordValue:k,tagLabel:j,contactLabel:N,invoiceConfigLabel:O}=Ne(),y=o({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}});_(L.value)&&(y.value.invoiceConfigId=[{value:L.value}]);const T=u(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:N},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:k,label:N}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:O},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:k,label:O}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:j},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:k,label:j}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),Z=x(T.value),$=u(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),ee=u(()=>T.value.map(e=>e.key)),te=o({});function S(){i.value=null,r.value=[],b.value=null,P.value={}}async function ae(e){const a=B.value.map(t=>H.formatDataForShow(t,e));Promise.all(a).then(t=>{i.value={},B.value.forEach((n,s)=>{i.value[n]=t[s]}),i.value.totalAmount=q.value}).catch(t=>{g("Error generating invoice!"),console.error(t)})}async function ne(e){await ae(Object.assign({},e.invoice)),r.value=e.invoiceLines.map(a=>ve(a)),R.value=Object.assign({},e.invoiceConfig),w.value=Object.assign({},e.invoiceNumberSequence),K.value=Object.assign({},e.billingContact),W.value=Object.assign({},e.currency),b.value=Object.assign({},e.invoiceTemplate)}async function le(){S(),d.value=!0;const e=Z.formatFilters(y.value);E.create("invoices",e,{path:"preview_invoice"}).then(a=>{ne(a),d.value=!1,C.value=1}).catch(a=>{console.error(a),g("Error previewing invoice!")})}function oe(){S(),y.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}const A=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],ie=x(A),r=o([]),se=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await ce()}}],ue=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,a){await M(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,a){await de(a)}}],d=o(!1),re=u(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function ce(){d.value=!0,r.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),d.value=!1}function de(e){d.value=!0,r.value.splice(e,1),d.value=!1}function ve(e){const a={};return a.description=e.description,a.unit=e.unit,a.unitCost=m(e.unitCost),a.unitValue=m(e.unitValue),Q(e.subtotal)?M(a):a.subtotal=m(e.subtotal),a}function m(e){return(e||0).toFixed(2)}function M(e){const a=e.unitCost,t=e.unitValue;_(a)&&_(t)?e.subtotal=m(parseFloat(a)*parseFloat(t)):e.subtotal=m(0),i.value.totalAmount=q.value}const me=o([]);function p(e,a){return me[e]?p[e][a]:""}const i=o(),z=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],pe=u(()=>z.reduce((e,a)=>(Object.keys(a).forEach(t=>{e.push(t)}),e),[])),F=u(()=>Y(L.value)),B=u(()=>F.value.map(e=>e.key)),H=x(F.value),q=u(()=>{const e=r.value.reduce((a,t)=>_(t.subtotal)?a+parseFloat(t.subtotal):a,0);return m(e)}),P=o({}),b=o(),R=o(),w=o(),K=o(),W=o(),be=u(()=>({invoice:i.value,invoiceLines:r.value,invoiceConfig:R.value,invoiceNumberSequence:w.value,billingContact:K.value,currency:W.value}));async function fe(){return new Promise((e,a)=>{const t=r.value.map(n=>ie.formatDataForSave(n));Promise.all(t).then(n=>{e(n)}).catch(n=>{a(n)})})}async function ge(){await fe().then(e=>{const a=Object.assign({},{invoice:H.formatDataForSave(i.value),invoiceNumberSequence:w.value,invoiceLines:e});E.create("invoices",a,{path:"generate_with_lines"}).then(t=>{i.value.id=t.id,r.value=t.invoiceLines,C.value=2,g("Invoice created successfully!")}).catch(t=>{g("Error creating invoice!"),console.error(t)})}).catch(e=>{g("Error formatting invoice for save!"),console.error(e)})}const C=o(0),ye=u(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function Ve(e){e===0&&(S(),C.value=e)}async function _e(e){e===1&&await le()}async function Ce(){await ge()}return Te(()=>{oe()}),(e,a)=>(I(),Se("div",ze,[Be,v(Oe,{steps:l(ye),"current-step-number":C.value,onPrevStep:Ve,onNextStep:_e,onSubmit:Ce},{"step-0":c(()=>[v(G,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=t=>y.value=t),"fields-layout":l($),"data-fields":l(ee),schemas:l(T),"error-messages":te.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":c(()=>[i.value?(I(),D(G,{key:0,modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=t=>i.value=t),"fields-layout":z,"data-fields":l(pe),schemas:l(F),"error-messages":P.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):U("",!0),i.value?(I(),D(l(Fe),{key:1,name:"Invoice Lines",headers:A,data:r.value,"table-actions":se,actions:ue,loading:d.value,pagination:{offset:0,limit:r.value.length,client:!0}},{["data-col.description"]:c(({row:t,i:n})=>[f("div",He,[v(l(h),{modelValue:t.description,"onUpdate:modelValue":s=>t.description=s,type:"text",label:"",size:"lg","error-message":p(n,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unitCost"]:c(({row:t,i:n})=>[f("div",qe,[v(l(h),{modelValue:t.unitCost,"onUpdate:modelValue":s=>t.unitCost=s,type:"number",label:"",size:"sm","error-message":p(n,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unit"]:c(({row:t,i:n})=>[f("div",Pe,[v(l(we),{modelValue:t.unit,"onUpdate:modelValue":s=>t.unit=s,type:"text",label:"",size:"md",options:l(re),"error-message":p(n,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),["data-col.unitValue"]:c(({row:t,i:n})=>[f("div",Re,[v(l(h),{modelValue:t.unitValue,"onUpdate:modelValue":s=>t.unitValue=s,type:"number",label:"",size:"sm","error-message":p(n,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.subtotal"]:c(({row:t,i:n})=>[f("div",Ke,[v(l(h),{modelValue:t.subtotal,"onUpdate:modelValue":s=>t.subtotal=s,type:"number",label:"",size:"sm","error-message":p(n,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:c(({total:t})=>[De(" Total Lines: "+Ue(t),1)]),_:2},1032,["data","loading","pagination"])):U("",!0)]),"step-2":c(()=>[b.value?(I(),D(Ae,{key:0,id:b.value.id,"template-type":"invoice_templates","content-markup":b.value.contentMarkup,"content-styles":b.value.contentStyles,data:l(be),disabled:!0},null,8,["id","content-markup","content-styles","data"])):U("",!0)]),_:1},8,["steps","current-step-number"])]))}},at=Ie(We,[["__scopeId","data-v-5a82329e"]]);export{at as default};
