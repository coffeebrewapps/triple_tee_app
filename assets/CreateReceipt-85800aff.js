import{_ as ve,v as de,a as fe,u as be,r as a,b as s,w as ge,d as ye,o as w,c as _e,k as M,q as j,g as r,f as P,e as T,A as Ie,p as Se,i as he,j as Ce}from"./index-b3ed4318.js";import{u as U}from"./input-811f8f86.js";import{u as Ae}from"./utils-988c526d.js";import{W as ke}from"./WorkflowContainer-b1135769.js";import{D as H}from"./DataForm-ebf3e12e.js";import{T as Fe}from"./TemplateEditor-6070bea0.js";import"./errors-53bc63a8.js";import"./TabContainer-41a4bb62.js";const Re=l=>(Se("data-v-5aff78f5"),l=l(),he(),l),we={class:"page-container"},je=Re(()=>Ce("h3",{class:"heading"}," Create Receipt ",-1)),De={__name:"CreateReceipt",props:{contactId:{type:String,default:null},invoiceId:{type:String,default:null}},setup(l){const u=l,{isEmpty:D,notEmpty:K}=de(),N=fe(),{formatNumber:W}=Ie(),{flashMessage:p}=be(),{fieldsLayout:z,generateDataFields:G,recordValue:E,receiptConfigLabel:O,invoiceLabel:V,validations:J}=Ae(),c=a({invoiceId:[],receiptConfigId:[]});K(u.invoiceId)&&(c.value.invoiceId=[{value:u.invoiceId}]);const b=s(()=>[{key:"invoiceId",type:"singleSelect",label:"Invoice",reference:{label:V},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoices",value:E,label:V}},{key:"receiptConfigId",type:"singleSelect",label:"Receipt Config",reference:{label:O},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"receipt_configs",value:E,label:O}}]),Q=U(b.value),X=s(()=>[{invoiceId:"lg",receiptConfigId:"lg"}]),Y=s(()=>b.value.map(e=>e.key)),Z=a({});function g(){n.value=null,I.value=null,S.value=null,h.value=null,d.value=null,C.value=null,o.value=null,A.value=null,v.value={},y.value=0}async function $(e){const t=q.value.map(i=>_.formatDataForShow(i,e));Promise.all(t).then(i=>{n.value={},q.value.forEach((F,R)=>{n.value[F]=i[R]})}).catch(i=>{p("Error generating receipt!"),console.error(i)})}async function ee(e){await $(Object.assign({},e.receipt)),I.value=Object.assign({},e.invoice),S.value=Object.assign({},e.currency),h.value=Object.assign({},e.billingContact),d.value=Object.assign({},e.receiptConfig),C.value=Object.assign({},e.receiptNumberSequence),o.value=Object.assign({},e.receiptTemplate),A.value=Object.assign({},e.invoiceNumberSequence)}async function te(){g();const e=Q.formatFilters(c.value);N.create("income_receipts",e,{path:"preview_receipt"}).then(t=>{ee(t),f.value=1}).catch(t=>{console.error(t),p("Error previewing receipt!")})}function ae(){g(),c.value={invoiceId:[],receiptConfigId:[]}}const n=a(),y=a(0),ne=z,m=s(()=>G(u.invoiceId,u.contactId)),ie=s(()=>re.value.map(e=>e.key)),se=["receiptNumber","billableAmount","paidAmount","remainingAmount"],re=s(()=>m.value.filter(e=>!se.includes(e.key)&&e.creatable)),q=s(()=>m.value.map(e=>e.key)),_=U(m.value);ge(n,(e,t)=>{if(!(D(e)||D(t))&&(v.value={},y.value!==e.paymentAmount)){const{billableAmount:i,paidAmount:F,paymentAmount:R}=n.value,B=i-F-R,L=_.validateParams({remainingAmount:J.create.remainingAmount},Object.assign({},n.value,{paymentAmount:e.paymentAmount,remainingAmount:B}));Object.keys(L).length>0?v.value=L:n.value.remainingAmount=parseFloat(W(B,2)),y.value=e.paymentAmount}},{deep:!0});const v=a({}),I=a(),S=a(),x=a(),h=a(),d=a(),C=a(),o=a(),A=a(),le=s(()=>({receipt:n.value,invoice:I.value,currency:S.value,transaction:x.value,billingContact:h.value,receiptConfig:d.value,receiptNumberSequence:C.value,invoiceNumberSequence:A.value})),k=a(!1);async function ce(){k.value=!1;const e=Object.assign({},{receipt:_.formatDataForSave(n.value),receiptConfigId:d.value.id});await N.create("income_receipts",e,{path:"generate_with_transaction"}).then(t=>{n.value.id=t.id,x.value=t.transaction,k.value=!0,f.value=2,p("Receipt created successfully!")}).catch(t=>{p("Error creating receipt!"),console.error(t)})}const f=a(0),oe=s(()=>[{title:"Select Invoice"},{title:"Fill Receipt"},{title:"Preview Receipt"}]);async function ue(e){e===0&&(g(),f.value=e)}async function pe(e){e===1&&await te()}async function me(){await ce()}return ye(()=>{ae()}),(e,t)=>(w(),_e("div",we,[je,M(ke,{steps:r(oe),"current-step-number":f.value,onPrevStep:ue,onNextStep:pe,onSubmit:me},{"step-0":j(()=>[M(H,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=i=>c.value=i),"fields-layout":r(X),"data-fields":r(Y),schemas:r(b),"error-messages":Z.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":j(()=>[n.value?(w(),P(H,{key:0,modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=i=>n.value=i),"fields-layout":r(ne),"data-fields":r(ie),schemas:r(m),"error-messages":v.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])):T("",!0)]),"step-2":j(()=>[k.value?(w(),P(Fe,{key:0,id:o.value.id,"template-type":"receipt_templates","content-markup":o.value.contentMarkup,"content-styles":o.value.contentStyles,data:r(le),disabled:!0},null,8,["id","content-markup","content-styles","data"])):T("",!0)]),_:1},8,["steps","current-step-number"])]))}},Me=ve(De,[["__scopeId","data-v-5aff78f5"]]);export{Me as default};
