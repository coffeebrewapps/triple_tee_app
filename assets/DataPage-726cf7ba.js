import{F as We,a as Ye,u as _e}from"./Form-77967d6a.js";import{r,c as d,d as u,e as v,k as T,x as K,h as o,A as Ae,P as Te,X as et,F as X,_ as tt,m as at,o as lt,g as B,j as O,y as se,t as x,f as m,S as nt,M as xe,C as st,b as ta,a as aa,q as la,w as Se,G as He,z as qe,J as Xe,K as Ze,L as Ge,R as na,Z as sa,p as oa,i as ra}from"./index-b3128bd9.js";import{u as ia}from"./errors-a6177d44.js";const Qe={__name:"FormDialog",props:{modelValue:{type:Boolean,default:!1},fieldsLayout:{type:Array,default:[]},dataFields:{type:Array,default:[]},data:{type:Object,default:{}},schemas:{type:Object,default:{}},dialogTitle:{type:String,default:""},fullscreen:{type:Boolean,default:!1},errorMessages:{type:Object,default(){return{}}}},emits:["update:modelValue","submit"],setup(l,{emit:n}){const w=l,Z=r(!1),N=r(""),b=d({get:()=>w.modelValue,set:V=>{n("update:modelValue",V)}}),M=d(()=>w.data);function j(V){n("submit",V)}function I(){b.value=!1,n("update:modelValue",!1)}return(V,p)=>(u(),v(X,null,[T(o(Te),{modelValue:o(b),"onUpdate:modelValue":p[1]||(p[1]=k=>Ae(b)?b.value=k:null),title:l.dialogTitle,fullscreen:l.fullscreen,class:"form-dialog"},{body:K(()=>[T(We,{modelValue:o(M),"onUpdate:modelValue":p[0]||(p[0]=k=>Ae(M)?M.value=k:null),"fields-layout":l.fieldsLayout,"data-fields":l.dataFields,schemas:l.schemas,"error-messages":l.errorMessages,onSubmit:j,onCancel:I},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),_:1},8,["modelValue","title","fullscreen"]),T(o(et),{title:"Error",content:N.value,width:400,height:250,modelValue:Z.value,"onUpdate:modelValue":p[2]||(p[2]=k=>Z.value=k)},null,8,["content","modelValue"])],64))}};const ua={class:"data-row"},ca={class:"data-col"},da={class:"data-label"},fa={key:0,class:"data-value"},va={key:0},ya={key:1,class:"no-value"},ma={key:1,class:"data-value tags"},ga={key:0,class:"no-value"},pa={__name:"ViewDialog",props:{modelValue:{type:Boolean,default:!1},keys:{type:Array,default(){return[]}},record:{type:Object,default(){return{}}},dataFields:{type:Array,default(){return[]}},title:{type:String,default:"View"},inputLabel:{type:Function,default(l){return l}},inputValue:{type:Function,default(l,n){return n[l]}},includeKeys:{type:Array,default(){return[]}}},emits:["update:modelValue"],setup(l,{emit:n}){const w=l,N=at().getSystemConfigs(),{isEmpty:b,notEmpty:M}=Ye(),{formatTag:j,tagStyle:I}=st(),{tagsFields:V,tagsField:p}=_e(w.dataFields),k=d({get:()=>w.modelValue,set:D=>{n("update:modelValue",D)}});function pe(){n("update:modelValue",!1)}const J=r();async function he(D,y,i){const G=y.map(E=>new Promise((z,$)=>{j(D,E,i,N.tagFormat).then(Q=>{z(Q)}).catch(Q=>{$(Q)})}));return new Promise((E,z)=>{Promise.all(G).then($=>{E({key:i,formattedValue:$})}).catch($=>{z($)})})}function be(D,y,i){return J.value[y]?J.value[y][i]:D[y][i]}return lt(async()=>{const D=V.value.map(y=>{const i=w.record[y];return he(w.record,i,y)});Promise.all(D).then(y=>{J.value=Object.assign({},w.record),y.forEach(i=>{J.value[i.key]=i.formattedValue})}).catch(y=>{console.error(y)})}),(D,y)=>J.value?(u(),B(o(Te),{key:0,modelValue:o(k),"onUpdate:modelValue":y[1]||(y[1]=i=>Ae(k)?k.value=i:null),title:l.title},{body:K(()=>[O("div",ua,[(u(!0),v(X,null,se(l.keys,i=>(u(),v("div",ca,[O("div",da,x(l.inputLabel(i)),1),o(p)(i)?m("",!0):(u(),v("div",fa,[o(M)(l.record[i])?(u(),v("div",va,x(l.inputValue(i,l.record,l.includeKeys,l.dataFields)),1)):m("",!0),o(b)(l.record[i])?(u(),v("div",ya," --- no value --- ")):m("",!0)])),o(p)(i)?(u(),v("div",ma,[(u(!0),v(X,null,se(l.record[i],(G,E)=>(u(),v("div",{class:"tag",style:nt(o(I)(l.record,G,i))},x(be(l.record,i,E)),5))),256)),l.record[i].length===0?(u(),v("div",ga," --- no value --- ")):m("",!0)])):m("",!0)]))),256))])]),actions:K(()=>[T(o(xe),{"button-type":"text",value:"Close",icon:"fa-solid fa-xmark",onClick:y[0]||(y[0]=i=>pe())})]),_:1},8,["modelValue","title"])):m("",!0)}},ha=tt(pa,[["__scopeId","data-v-98c48421"]]);const ge=l=>(oa("data-v-86d820c4"),l=l(),ra(),l),ba={class:"page-container"},ka={class:"heading"},Da=ge(()=>O("h3",{class:"heading"},"Filters",-1)),Fa=["onClick"],wa=ge(()=>O("i",{class:"fa-solid fa-sort"},null,-1)),Va=ge(()=>O("i",{class:"fa-solid fa-sort-up"},null,-1)),Ca=ge(()=>O("i",{class:"fa-solid fa-sort-down"},null,-1)),Oa={key:0,class:"col"},Sa={class:"col"},Aa={key:0},xa={key:0},Ta={key:1,class:"no-value"},ja={key:1},Ea={key:0,class:"no-value"},$a=["download","href"],Ua={__name:"DataPage",props:{dataType:{type:String,default:""},modelClass:{type:String,default:null},filters:{type:Object,default:{}},dataFields:{type:Array,default:[]},fieldsLayout:{type:Array,default:[]},validations:{type:Object,default:{}},fullscreen:{type:Boolean,default:!1},createDialogTitle:{type:Function,default:function(l){return`Create ${l}`}},viewDialogTitle:{type:Function,default:function(l,n){return`View ${l} ${n.id}`}},updateDialogTitle:{type:Function,default:function(l,n){return n?`Update ${l} ${n.id}`:""}},deleteDialogTitle:{type:Function,default:function(l,n){return n?`Delete ${l} ${n.id}`:""}},deleteDialogPrimaryText:{type:Function,default:function(l,n){return n?`Are you sure you want to delete ${l} ${n.id}?`:""}},deleteDialogSecondaryText:{type:Function,default:function(l,n){return n?JSON.stringify(n,!1,2):""}},actions:{type:Object,default:{}}},setup(l){const n=l,{schemasMap:w,inputLabel:Z,inputValue:N,tagsField:b,formatInputOptionsData:M,formatDataForShow:j,formatDataForSave:I,formatErrorsForDisplay:V,formatFilters:p,fetchOptions:k,initOptionsData:pe}=_e(n.dataFields),he=at().getSystemConfigs(),{formatTag:be,tagStyle:D}=st(),y=ia(),i=ta(),{isEmpty:G,notEmpty:E}=Ye(),z=aa(),$=la(),Q=d(()=>n.dataFields.filter(e=>e.reference)),oe=d(()=>Q.value.map(e=>e.key)),U=r(Array.from(n.dataFields)),je=r(!1),ke=r(!1);function Ee(e,t){return Object.keys(e).reduce((a,s)=>{const c=e[s].map(g=>g(t)).filter(g=>!!g);return c.length>0&&(a[s]=c),a},{})}function ot(e){U.value=U.value.map(t=>{if(t.type==="enum"){const a=e[t.key].enums,s=Object.keys(a).map(c=>({value:c,label:a[c]}));return Object.assign({},t,{options:s})}else return t})}const rt=r(n.filters.layout),De=r(!1),H=r({}),$e=r(Array.from(n.dataFields)),it=r({}),ut=d(()=>({type:"icon",icon:"fa-solid fa-check"})),ct=d(()=>({type:"icon",icon:"fa-solid fa-filter-circle-xmark"})),dt=d(()=>n.dataFields.filter(e=>e.filterable).reduce((e,t)=>(e[t.key]=t,e),{})),Fe=d(()=>Object.keys(dt.value)),Ue=d(()=>rt.value&&je.value&&ke.value),ft=d(()=>n.filters.layout),vt=d(()=>De.value?"filters expanded":"filters collapsed");async function yt(e){_.value=0,await q()}async function W(){ke.value=!1,H.value=p(Object.assign({},n.filters.initData));const e=Fe.value.map(t=>j(t,H.value));Promise.all(e).then(t=>{Fe.value.forEach((a,s)=>{H.value[a]=t[s]}),ke.value=!0,q()})}function mt(){De.value=!De.value}function gt(){$e.value=Array.from(U.value).map(e=>{const t=Object.assign({},e);return t.filterable&&(t.type==="date"?t.type="daterange":t.type==="datetime"?t.type="datetimerange":t.type==="number"&&(t.type="numberrange")),t}).filter(e=>e.filterable)}const re=r("id"),Y=r(!0),pt=d(()=>({field:re.value,order:Y.value?"asc":"desc"})),ht=d(()=>n.dataFields.filter(e=>e.sortable).reduce((e,t)=>(e[t.key]=t,e),{})),bt=d(()=>Object.keys(ht.value));function we(e){return bt.value.includes(e)}const kt=d(()=>n.dataFields.reduce((e,t)=>{const a=t.key;return we(a)&&a===re.value?Y.value?e[a]="header-field sort down":e[a]="header-field sort up":we(a)?e[a]="header-field sort reset":e[a]="header-field nosort",e},{}));async function Dt(e){we(e)&&(e===re.value?Y.value=!Y.value:(re.value=e,Y.value=!0),_.value=0,await q())}const Ft=d(()=>{const e={name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(me){await Rt()}},t=n.actions.create||{},a=Object.assign({},e,t),s={name:"Export",icon:"fa-solid fa-file-export",click:async function(me){await _t()}},f=n.actions.export||{},c=Object.assign({},s,f),g={name:"Filter",icon:"fa-solid fa-filter",click:async function(){mt()}},h=n.actions.filter||{},R=Object.assign({},g,h),A=[a,c];return Ue.value&&A.unshift(R),A}),wt=d(()=>{const e={name:"View",icon:"fa-solid fa-magnifying-glass",click:async function(A,me){await Ut(A.id)}},t=n.actions.view||{},a=Object.assign({},e,t),s={name:"Update",icon:"fa-solid fa-pen-to-square",click:async function(A,me){await Ht(A.id)}},f=n.actions.update||{},c=Object.assign({},s,f),g={name:"Delete",icon:"fa-solid fa-trash-can",click:async function(A,me){await Wt(A.id)}},h=n.actions.remove||{},R=Object.assign({},g,h);return[a,c,R]}),Pe=r([]),Le=r(0),_=r(0),Re=r(5),ie=r(!1),Be=d(()=>n.dataFields.filter(e=>e.listable)),ue=r([]);async function Vt(e){_.value=e,await q()}async function Ct(e,t,a,s){const f=t.map(c=>new Promise((g,h)=>{be(e,c,a,he.tagFormat).then(R=>{g(R)}).catch(R=>{h(R)})}));return new Promise((c,g)=>{Promise.all(f).then(h=>{c({i:s,key:a,formattedValue:h})}).catch(h=>{g(h)})})}function Ot(e,t,a){const s=`${t}Formatted`;return e[s]?e[s][a]:e[t]}async function St(){const e=[];ue.value=[],Pe.value.forEach((t,a)=>{ue.value.push(Object.assign({},t)),Be.value.forEach(s=>{const f=s.key,c=t[f];b(f)&&e.push(Ct(t,c,f,a))})}),Promise.all(e).then(t=>{t.forEach(a=>{const s=`${a.key}Formatted`;ue.value[a.i][s]=a.formattedValue})}).catch(t=>{console.error(t)})}const At=r({});$.registerListener("loadData",{id:`DataPage-${n.dataType}`,invoke:e=>{e.dataType===n.dataType&&q()}});async function xt(){await i.schemas(n.modelClass).then(e=>{const t=e.fields;ot(t),gt(),je.value=!0}).catch(e=>{console.error(e),C("Error loading schemas!")})}async function q(){const e={include:oe.value,offset:_.value,limit:Re.value,filters:p(H.value),sort:pt.value};ie.value=!0,await i.list(n.modelClass,e).then(t=>{Pe.value=t.data,St(),Le.value=t.total,ie.value=!1}).catch(t=>{ie.value=!1,console.error(t),C("Error loading data!")})}async function Ve(e,t,a){const s={include:oe.value};await i.view(n.modelClass,e,s).then(f=>{t(f)}).catch(f=>{a(f)})}function C(e){z.show(e),setTimeout(Tt,5e3)}function Tt(){z.hide()}const S=r(!1),F=r(""),jt=d(()=>F.value&&F.value.length>0?(F.value.match(/.{1,100}/g)??[]).join(`
`):""),Ke=d(()=>({width:800,height:400})),Ce=r(!1),ee=r(),Et=d(()=>n.dataFields.filter(e=>e.viewable).reduce((e,t)=>(e[t.key]=t,e),{})),$t=d(()=>Object.keys(Et.value));async function Ut(e){Ve(e,t=>{ee.value=t,Ce.value=!0},t=>{ee.value=null,S.value=!0,F.value=JSON.stringify(t,!1,4)})}const te=r(!1),ae=r(),ce=r({}),Pt=d(()=>n.dataFields.filter(e=>e.creatable).reduce((e,t)=>(e[t.key]=t,e),{})),Oe=d(()=>Object.keys(Pt.value)),Lt=d(()=>n.validations.create||[]);Se(te,(e,t)=>{e||(ce.value={})});async function Rt(e){ae.value={};const t=Oe.value.map(a=>j(a,{}));Promise.all(t).then(a=>{Oe.value.forEach((s,f)=>{ae.value[s]=a[f],te.value=!0})})}async function Bt(e){const t=Kt(e);if(Object.keys(t).length>0){ce.value=t,C("Error creating data!");return}const a=I(e);await i.create(n.modelClass,a).then(s=>{C("Data created successfully!"),W(),Nt()}).catch(s=>{ce.value=V(s),C("Error creating data!")})}function Kt(e){return Ee(Lt.value,e)}function Nt(){te.value=!1,Mt()}function Mt(){ae.value=null}const le=r(!1),P=r(),de=r({}),It=d(()=>n.dataFields.filter(e=>e.updatable).reduce((e,t)=>(e[t.key]=t,e),{})),Jt=d(()=>Object.keys(It.value)),zt=d(()=>n.validations.update||[]);Se(le,(e,t)=>{e||(de.value={})});async function Ht(e){Ve(e,t=>{Gt(t),le.value=!0},t=>{Ne(),S.value=!0,F.value=JSON.stringify(t,!1,4)})}async function qt(e){const t=Xt(e);if(Object.keys(t).length>0){de.value=t,C("Error updating data!");return}const a=e.id,s=I(e);await i.update(n.modelClass,a,s).then(f=>{C("Data updated successfully!"),W(),Zt()}).catch(f=>{de.value=V(f),C("Error updating data!")})}function Xt(e){return Ee(zt.value,e)}function Zt(){le.value=!1,Ne()}async function Gt(e){P.value={};const t=n.dataFields.map(a=>{const s=a.key;return j(s,e)});Promise.all(t).then(a=>{n.dataFields.forEach((s,f)=>{const c=s.key;P.value[c]=a[f]})})}function Ne(){P.value=null}const ne=r(!1),L=r(),Qt=r({});Se(ne,(e,t)=>{e||(Qt.value={})});async function Wt(e){Ve(e,t=>{L.value=t,ne.value=!0},t=>{Ie(),S.value=!0,F.value=JSON.stringify(t,!1,4)})}async function Yt(){const t=L.value.id;await i.remove(n.modelClass,t).then(a=>{C("Data deleted successfully!"),W()}).catch(a=>{S.value=!0,F.value=a.map(s=>y[s]()).join(", ")}).finally(()=>{Me()})}function Me(){ne.value=!1,Ie()}function Ie(){L.value=null}const fe=r(!1),ve=r(),ye=r(),Je=r("downloadAnchor");async function _t(){await i.download(n.modelClass).then(e=>{const t=window.URL.createObjectURL(new Blob([e.data]));ve.value=t,ye.value=e.filename,fe.value=!0}).catch(e=>{S.value=!0,F.value=JSON.stringify(result.error,!1,4)})}function ea(){Je.value.click(),ze()}function ze(){fe.value=!1,ve.value=null,ye.value=null}return lt(async()=>{await xt(),await q(),await pe().then(e=>{At.value=e}).catch(e=>{S.value=!0,F.value=JSON.stringify(e,!1,4)}),await W()}),(e,t)=>(u(),v("div",ba,[O("h2",ka,x(l.dataType),1),o(Ue)?(u(),v("div",{key:0,class:He(o(vt))},[Da,T(We,{modelValue:H.value,"onUpdate:modelValue":t[0]||(t[0]=a=>H.value=a),"fields-layout":o(ft),"data-fields":o(Fe),schemas:$e.value,"error-messages":it.value,"confirm-button":o(ut),"cancel-button":o(ct),compact:!0,onSubmit:yt,onCancel:W},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"])],2)):m("",!0),T(o(na),{name:"",headers:o(Be),data:ue.value,"table-actions":o(Ft),actions:o(wt),loading:ie.value,pagination:{offset:_.value,limit:Re.value,client:!1},"total-data":Le.value,onOffsetChange:Vt},{"header-row":K(({headers:a,actions:s})=>[(u(!0),v(X,null,se(a,(f,c)=>(u(),v("th",{class:"col",onClick:g=>Dt(f.key)},[O("div",{class:He(o(kt)[f.key])},[qe(x(f.label)+" ",1),wa,Va,Ca],2)],8,Fa))),256)),s.length>0?(u(),v("th",Oa)):m("",!0)]),"data-content":K(({headers:a,row:s,i:f})=>[(u(!0),v(X,null,se(a,c=>(u(),v("td",Sa,[Xe(e.$slots,`data-col.${c.key}`,Ze(Ge({header:c,row:s,i:f})),()=>[o(b)(c.key)?m("",!0):(u(),v("div",Aa,[o(E)(s[c.key])?(u(),v("div",xa,x(o(N)(c.key,s,o(oe),U.value)),1)):m("",!0),o(G)(s[c.key])?(u(),v("div",Ta," --- no value --- ")):m("",!0)])),o(b)(c.key)?(u(),v("div",ja,[(u(!0),v(X,null,se(s[c.key],(g,h)=>(u(),v("div",{class:"tag",style:nt(o(D)(s,g,c.key))},x(Ot(s,c.key,h)),5))),256)),s[c.key].length===0?(u(),v("div",Ea," --- no value --- ")):m("",!0)])):m("",!0)],!0)]))),256))]),_:3},8,["headers","data","table-actions","actions","loading","pagination","total-data"]),F.value.length>0?(u(),B(o(et),{key:1,title:"Error",class:"error-alert",content:o(jt),width:o(Ke).width,height:o(Ke).height,modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=a=>S.value=a)},null,8,["content","width","height","modelValue"])):m("",!0),ae.value?(u(),B(Qe,{key:2,modelValue:te.value,"onUpdate:modelValue":t[2]||(t[2]=a=>te.value=a),schemas:U.value,"fields-layout":l.fieldsLayout,"data-fields":o(Oe),data:ae.value,"dialog-title":l.createDialogTitle(l.dataType),fullscreen:l.fullscreen,"error-messages":ce.value,onSubmit:Bt},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):m("",!0),Xe(e.$slots,"updateDialog",Ze(Ge({row:P.value})),()=>[P.value?(u(),B(Qe,{key:0,modelValue:le.value,"onUpdate:modelValue":t[3]||(t[3]=a=>le.value=a),schemas:U.value,"fields-layout":l.fieldsLayout,"data-fields":o(Jt),data:P.value,"dialog-title":l.updateDialogTitle(l.dataType,P.value),fullscreen:l.fullscreen,"error-messages":de.value,onSubmit:qt},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):m("",!0)],!0),ee.value?(u(),B(ha,{key:3,modelValue:Ce.value,"onUpdate:modelValue":t[4]||(t[4]=a=>Ce.value=a),keys:o($t),"include-keys":o(oe),"data-fields":U.value,record:ee.value,title:l.viewDialogTitle(l.dataType,ee.value),"input-label":o(Z),"input-value":o(N),class:"view-dialog"},null,8,["modelValue","keys","include-keys","data-fields","record","title","input-label","input-value"])):m("",!0),L.value?(u(),B(o(sa),{key:4,modelValue:ne.value,"onUpdate:modelValue":t[5]||(t[5]=a=>ne.value=a),title:l.deleteDialogTitle(l.dataType,L.value),"primary-text":l.deleteDialogPrimaryText(l.dataType,L.value),"secondary-text":l.deleteDialogSecondaryText(l.dataType,L.value),width:500,height:350,onConfirm:Yt,onCancel:Me,class:"delete-dialog"},null,8,["modelValue","title","primary-text","secondary-text"])):m("",!0),ve.value?(u(),B(o(Te),{key:5,modelValue:fe.value,"onUpdate:modelValue":t[8]||(t[8]=a=>fe.value=a),title:"Download export file",width:400,height:250},{body:K(()=>[qe(x(ye.value),1)]),actions:K(()=>[O("a",{class:"hidden",ref_key:"downloadAnchor",ref:Je,rel:"noreferrer",download:ye.value,href:ve.value},null,8,$a),T(o(xe),{"button-type":"text",value:"Download",icon:"fa-solid fa-file-arrow-down",onClick:t[6]||(t[6]=a=>ea())}),T(o(xe),{"button-type":"text",value:"Cancel",icon:"fa-solid fa-xmark",onClick:t[7]||(t[7]=a=>ze())})]),_:1},8,["modelValue"])):m("",!0)]))}},Ba=tt(Ua,[["__scopeId","data-v-86d820c4"]]);export{Ba as D,Qe as _};
