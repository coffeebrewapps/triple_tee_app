import{_ as be,n as ge,a as ye,u as _e,c as s,r as a,w as he,o as Ce,b as w,d as Ie,k as P,v as j,g as i,f as T,e as U,C as Se,p as Re,i as ke,j as Ae}from"./index-522b32ec.js";import{u as Fe}from"./validations-9a1af222.js";import{u as H}from"./input-ae6e7048.js";import{u as we}from"./utils-e5d368b1.js";import{W as je}from"./WorkflowContainer-759985ee.js";import{D as K}from"./DataForm-8f7f0e0d.js";import{T as De}from"./TemplateEditor-5f1015af.js";import"./errors-53bc63a8.js";import"./TabContainer-e6b87ac2.js";const Ne=l=>(Re("data-v-ba034973"),l=l(),ke(),l),Oe={class:"page-container"},Ee=Ne(()=>Ae("h3",{class:"heading"}," Create Receipt ",-1)),qe={__name:"CreateReceipt",setup(l){const W=ge(),{isEmpty:D,notEmpty:z}=Fe(),N=ye(),{formatNumber:G}=Se(),{flashMessage:u}=_e(),O=Object.assign({},W.currentRoute.value),f=s(()=>O.query.invoiceId),J=s(()=>O.query.contactId),{fieldsLayout:Q,generateDataFields:X,recordValue:E,receiptConfigLabel:q,invoiceLabel:V,validations:Y}=we(),o=a({invoiceId:[],receiptConfigId:[]});z(f.value)&&(o.value.invoiceId=[{value:f.value}]);const b=s(()=>[{key:"invoiceId",type:"singleSelect",label:"Invoice",reference:{label:V},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoices",value:E,label:V}},{key:"receiptConfigId",type:"singleSelect",label:"Receipt Config",reference:{label:q},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"receipt_configs",value:E,label:q}}]),Z=H(b.value),$=s(()=>[{invoiceId:"lg",receiptConfigId:"lg"}]),ee=s(()=>b.value.map(e=>e.key)),te=a({});function g(){n.value=null,h.value=null,C.value=null,I.value=null,m.value=null,S.value=null,c.value=null,R.value=null,v.value={},y.value=0}async function ae(e){const t=x.value.map(r=>_.formatDataForShow(r,e));Promise.all(t).then(r=>{n.value={},x.value.forEach((A,F)=>{n.value[A]=r[F]})}).catch(r=>{u("Error generating receipt!"),console.error(r)})}async function ne(e){await ae(Object.assign({},e.receipt)),h.value=Object.assign({},e.invoice),C.value=Object.assign({},e.currency),I.value=Object.assign({},e.billingContact),m.value=Object.assign({},e.receiptConfig),S.value=Object.assign({},e.receiptNumberSequence),c.value=Object.assign({},e.receiptTemplate),R.value=Object.assign({},e.invoiceNumberSequence)}async function re(){g();const e=Z.formatFilters(o.value);N.create("income_receipts",e,{path:"preview_receipt"}).then(t=>{ne(t),d.value=1}).catch(t=>{console.error(t),u("Error previewing receipt!")})}function se(){g(),o.value={invoiceId:[],receiptConfigId:[]}}const n=a(),y=a(0),ie=Q,p=s(()=>X(f.value,J.value)),oe=s(()=>le.value.map(e=>e.key)),ce=["receiptNumber","billableAmount","paidAmount","remainingAmount"],le=s(()=>p.value.filter(e=>!ce.includes(e.key)&&e.creatable)),x=s(()=>p.value.map(e=>e.key)),_=H(p.value);he(n,(e,t)=>{if(!(D(e)||D(t))&&(v.value={},y.value!==e.paymentAmount)){const{billableAmount:r,paidAmount:A,paymentAmount:F}=n.value,L=r-A-F,M=_.validateParams({remainingAmount:Y.create.remainingAmount},Object.assign({},n.value,{paymentAmount:e.paymentAmount,remainingAmount:L}));Object.keys(M).length>0?v.value=M:n.value.remainingAmount=parseFloat(G(L,2)),y.value=e.paymentAmount}},{deep:!0});const v=a({}),h=a(),C=a(),B=a(),I=a(),m=a(),S=a(),c=a(),R=a(),ue=s(()=>({receipt:n.value,invoice:h.value,currency:C.value,transaction:B.value,billingContact:I.value,receiptConfig:m.value,receiptNumberSequence:S.value,invoiceNumberSequence:R.value})),k=a(!1);async function pe(){k.value=!1;const e=Object.assign({},{receipt:_.formatDataForSave(n.value),receiptConfigId:m.value.id});await N.create("income_receipts",e,{path:"generate_with_transaction"}).then(t=>{n.value.id=t.id,B.value=t.transaction,k.value=!0,d.value=2,u("Receipt created successfully!")}).catch(t=>{u("Error creating receipt!"),console.error(t)})}const d=a(0),ve=s(()=>[{title:"Select Invoice"},{title:"Fill Receipt"},{title:"Preview Receipt"}]);async function me(e){e===0&&(g(),d.value=e)}async function de(e){e===1&&await re()}async function fe(){await pe()}return Ce(()=>{se()}),(e,t)=>(w(),Ie("div",Oe,[Ee,P(je,{steps:i(ve),"current-step-number":d.value,onPrevStep:me,onNextStep:de,onSubmit:fe},{"step-0":j(()=>[P(K,{modelValue:o.value,"onUpdate:modelValue":t[0]||(t[0]=r=>o.value=r),"fields-layout":i($),"data-fields":i(ee),schemas:i(b),"error-messages":te.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":j(()=>[n.value?(w(),T(K,{key:0,modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=r=>n.value=r),"fields-layout":i(ie),"data-fields":i(oe),schemas:i(p),"error-messages":v.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])):U("",!0)]),"step-2":j(()=>[k.value?(w(),T(De,{key:0,id:c.value.id,"template-type":"receipt_templates","content-markup":c.value.contentMarkup,"content-styles":c.value.contentStyles,data:i(ue),disabled:!0},null,8,["id","content-markup","content-styles","data"])):U("",!0)]),_:1},8,["steps","current-step-number"])]))}},Ke=be(qe,[["__scopeId","data-v-ba034973"]]);export{Ke as default};
