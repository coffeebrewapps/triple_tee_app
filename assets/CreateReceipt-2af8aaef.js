import{_ as ye,m as _e,a as he,u as Ce,c as s,r as a,w as Ie,o as Se,b as F,d as Re,j as M,v as j,g as i,f as U,e as H,B as Ae,p as ke,h as we,i as Fe}from"./index-456a89cc.js";import{a as je,u as K}from"./input-701303c2.js";import{u as De}from"./utils-bba51a4e.js";import{W as Ne}from"./WorkflowContainer-9ef6ad6a.js";import{D as W}from"./DataForm-c9afdb67.js";import{T as Oe}from"./TemplateEditor-4ab264f1.js";import"./errors-a6177d44.js";import"./TabContainer-65d2b41a.js";const Ee=l=>(ke("data-v-574fb8d9"),l=l(),we(),l),qe={class:"page-container"},Be=Ee(()=>Fe("h3",{class:"heading"}," Create Receipt ",-1)),Ve={__name:"CreateReceipt",setup(l){const z=_e(),{isEmpty:D,notEmpty:G}=je(),N=he(),{formatNumber:J}=Ae(),O=Ce(),E=Object.assign({},z.currentRoute.value),f=s(()=>E.query.invoiceId),Q=s(()=>E.query.contactId),{fieldsLayout:X,generateDataFields:Y,recordValue:q,receiptConfigLabel:B,invoiceLabel:V,validations:Z}=De(),o=a({invoiceId:[],receiptConfigId:[]});G(f.value)&&(o.value.invoiceId=[{value:f.value}]);const b=s(()=>[{key:"invoiceId",type:"singleSelect",label:"Invoice",reference:{label:V},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoices",value:q,label:V}},{key:"receiptConfigId",type:"singleSelect",label:"Receipt Config",reference:{label:B},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"receipt_configs",value:q,label:B}}]),$=K(b.value),ee=s(()=>[{invoiceId:"lg",receiptConfigId:"lg"}]),te=s(()=>b.value.map(e=>e.key)),ae=a({});function g(){n.value=null,h.value=null,C.value=null,I.value=null,v.value=null,S.value=null,c.value=null,R.value=null,p.value={},y.value=0}async function ne(e){const t=x.value.map(r=>_.formatDataForShow(r,e));Promise.all(t).then(r=>{n.value={},x.value.forEach((k,w)=>{n.value[k]=r[w]})}).catch(r=>{m("Error generating receipt!"),console.error(r)})}async function re(e){await ne(Object.assign({},e.receipt)),h.value=Object.assign({},e.invoice),C.value=Object.assign({},e.currency),I.value=Object.assign({},e.billingContact),v.value=Object.assign({},e.receiptConfig),S.value=Object.assign({},e.receiptNumberSequence),c.value=Object.assign({},e.receiptTemplate),R.value=Object.assign({},e.invoiceNumberSequence)}async function se(){g();const e=$.formatFilters(o.value);N.create("income_receipts",e,{path:"preview_receipt"}).then(t=>{re(t),d.value=1}).catch(t=>{console.error(t),m("Error previewing receipt!")})}function ie(){g(),o.value={invoiceId:[],receiptConfigId:[]}}const n=a(),y=a(0),oe=X,u=s(()=>Y(f.value,Q.value)),ce=s(()=>ue.value.map(e=>e.key)),le=["receiptNumber","billableAmount","paidAmount","remainingAmount"],ue=s(()=>u.value.filter(e=>!le.includes(e.key)&&e.creatable)),x=s(()=>u.value.map(e=>e.key)),_=K(u.value);Ie(n,(e,t)=>{if(!(D(e)||D(t))&&(p.value={},y.value!==e.paymentAmount)){const{billableAmount:r,paidAmount:k,paymentAmount:w}=n.value,L=r-k-w,P=_.validateParams({remainingAmount:Z.create.remainingAmount},Object.assign({},n.value,{paymentAmount:e.paymentAmount,remainingAmount:L}));Object.keys(P).length>0?p.value=P:n.value.remainingAmount=parseFloat(J(L,2)),y.value=e.paymentAmount}},{deep:!0});const p=a({}),h=a(),C=a(),T=a(),I=a(),v=a(),S=a(),c=a(),R=a(),pe=s(()=>({receipt:n.value,invoice:h.value,currency:C.value,transaction:T.value,billingContact:I.value,receiptConfig:v.value,receiptNumberSequence:S.value,invoiceNumberSequence:R.value})),A=a(!1);async function ve(){A.value=!1;const e=Object.assign({},{receipt:_.formatDataForSave(n.value),receiptConfigId:v.value.id});await N.create("income_receipts",e,{path:"generate_with_transaction"}).then(t=>{n.value.id=t.id,T.value=t.transaction,A.value=!0,d.value=2,m("Receipt created successfully!")}).catch(t=>{m("Error creating receipt!"),console.error(t)})}function m(e){O.show(e),setTimeout(me,5e3)}function me(){O.hide()}const d=a(0),de=s(()=>[{title:"Select Invoice"},{title:"Fill Receipt"},{title:"Preview Receipt"}]);async function fe(e){e===0&&(g(),d.value=e)}async function be(e){e===1&&await se()}async function ge(){await ve()}return Se(()=>{ie()}),(e,t)=>(F(),Re("div",qe,[Be,M(Ne,{steps:i(de),"current-step-number":d.value,onPrevStep:fe,onNextStep:be,onSubmit:ge},{"step-0":j(()=>[M(W,{modelValue:o.value,"onUpdate:modelValue":t[0]||(t[0]=r=>o.value=r),"fields-layout":i(ee),"data-fields":i(te),schemas:i(b),"error-messages":ae.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":j(()=>[n.value?(F(),U(W,{key:0,modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=r=>n.value=r),"fields-layout":i(oe),"data-fields":i(ce),schemas:i(u),"error-messages":p.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])):H("",!0)]),"step-2":j(()=>[A.value?(F(),U(Oe,{key:0,id:c.value.id,"template-type":"receipt_templates","content-markup":c.value.contentMarkup,"content-styles":c.value.contentStyles,data:i(pe),disabled:!0},null,8,["id","content-markup","content-styles","data"])):H("",!0)]),_:1},8,["steps","current-step-number"])]))}},We=ye(Ve,[["__scopeId","data-v-574fb8d9"]]);export{We as default};
