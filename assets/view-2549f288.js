import{c as v,_ as ge,u as pe,k as re,V as Fe,r as m,w as Ke,o as he,a as u,b as d,h as l,f as t,N as x,n as J,z as Q,d as w,t as M,F as ke,m as _e,i as G,y as xe,p as Te,g as be,e as Ne,l as le}from"./index-7f6b454a.js";import{u as ue,a as we}from"./dataAccess-5c645c6d.js";import{a as ce,u as Ce,F as Me}from"./Form-a68d0e25.js";import{_ as Le,D as Be}from"./DataPage-366bbb6f.js";import{T as Oe}from"./TabContainer-47d05ef3.js";import Ae from"./CreateInvoice-2dfe7237.js";import"./errors-a6177d44.js";import"./utils-f0e90f1f.js";import"./TemplateEditor-7d1e9c58.js";const ye=ue(),{isEmpty:je,notEarlierThan:qe}=ce();function de(){const k=`${ye.baseUrl}/api/schemas/work_logs`,T=`${ye.baseUrl}/api/tags`,C=`${ye.baseUrl}/api/work_logs`,E=[{key:"id",type:"text",label:"ID",listable:!0,viewable:!0,creatable:!1,updatable:!1,sortable:!0},{key:"startTime",type:"datetime",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetime",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"description",type:"text",label:"Description",defaultValue:()=>"New Task",listable:!0,viewable:!0,creatable:!0,updatable:!0},{key:"content",type:"textarea",label:"Content",listable:!1,viewable:!0,creatable:!0,updatable:!0},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:f},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",sourceUrl:T,value:q,label:f}}],b=[{startTime:"md",endTime:"md"},{description:"lg"},{content:"lg"},{tags:"lg"}],j={initData:{startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},layout:[{tags:"md"},{startTime:"md"},{endTime:"md"}]},B={create:{endTime:[g]},update:{endTime:[g]}};function q(s){return s.id}function f(s){return`${s.category}:${s.name}`}function g(s){return qe(s,"endTime","startTime")}function p(s){if(s===0)return"0 h 0 m 0 s";const O=Math.floor(s/1e3/60/60/24),I=O*1e3*60*60*24,K=Math.floor((s-I)/1e3/60/60),U=K*1e3*60*60,$=Math.floor((s-I-U)/1e3/60),R=$*1e3*60,A=Math.floor((s-I-U-R)/1e3),c=[];return O>0&&c.push(`${O} d`),K>0&&c.push(`${K} h`),$>0&&c.push(`${$} m`),A>0&&c.push(`${A} s`),c.join(" ")}function D(s){return je(s.endTime)?new Date-new Date(s.startTime):new Date(s.endTime)-new Date(s.startTime)}const W=v(()=>E.filter(s=>s.reference)),V=v(()=>W.value.map(s=>s.key));return{schemasUrl:k,tagsUrl:T,worklogsUrl:C,dataFields:E,fieldsLayout:b,filters:j,validations:B,formatDuration:p,calculateDuration:D,includeKeys:V,recordValue:q,tagLabel:f}}const He=k=>(Te("data-v-b707717a"),k=k(),be(),k),Qe={class:"today-logs-container"},Ge={class:"controls"},Pe=["onKeydown"],ze=["onKeydown"],Ye=["onKeydown"],Je=["onKeydown"],Re=["onKeydown"],Xe={class:"logs"},Ze={class:"total"},et={class:"log"},tt=He(()=>l("div",{class:"divider"},null,-1)),at={class:"duration"},st={class:"start-time"},nt={key:0,class:"end-time"},ot={key:1,class:"elapsed"},it={key:2,class:"elapsed"},lt={class:"description"},rt={__name:"TodayLog",setup(k){ue();const{isEmpty:T,notEmpty:C}=ce(),E=we(),{formatShortTime:b}=xe(),{schemasUrl:j,tagsUrl:B,worklogsUrl:q,dataFields:f,fieldsLayout:g,filters:p,validations:D,formatDuration:W,calculateDuration:V,includeKeys:s}=de(),{formatDataFields:O,validateParams:I,formatDataForShow:K,formatDataForSave:U,fetchOptions:$,initOptionsData:R}=Ce(f),A=pe(),c=re(),S=Fe(),P=m([]),z=v(()=>f.map(e=>e.key)),n=m({}),_=v(()=>{const e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e}),X=v(()=>{const e=new Date;return e.setHours(23),e.setMinutes(59),e.setSeconds(59),e}),N=m([]),F=v(()=>N.value.length===0?!1:T(n.value.endTime)&&Z.value),i=v(()=>N.value.reduce((e,r)=>e+r.duration,0));function a(e){return e.map(r=>(r.duration=V(r),r))}function o(e){return T(e)?{}:(e.duration=V(e),e)}const h=m(!1),Z=m(!1);function te(){return f.reduce((e,r)=>{const y=r.key,$e=r.defaultValue;return C($e)?e[y]=$e():e[y]=null,e},{})}function ne(){n.value=te(),ee.value="",h.value=!0}async function oe(){n.value=te(),ee.value="",await Se()}function Ee(){h.value=!1}async function Se(){const e=I(D.create,n.value);if(Object.keys(e).length>0){H("Error submitting task!");return}const r=U(n.value);await E.create("work_logs",r).then(y=>{H("Started task successfully!"),ie(),Ee()}).catch(y=>{H("Error creating data!")})}const Y=m(!1),ee=m(""),L=m({});Ke(Y,(e,r)=>{e||(L.value={})});async function We(){const e=I(D.update,L.value);if(Object.keys(e).length>0){H("Error submitting task!");return}const r=U(L.value);await E.update("work_logs",L.value.id,r).then(y=>{H("Ended task successfully!"),ie(),Ve(),ee.value==="quick"?oe():ee.value==="input"&&setTimeout(ne,1e3)}).catch(y=>{H("Error submiting task!")})}async function ae(){L.value=Object.assign({},n.value),await K("startTime",L.value).then(e=>{L.value.startTime=e}),await K("tags",L.value).then(e=>{L.value.tags=e}),L.value.endTime=new Date,Y.value=!0}function ve(){ae(),ee.value="input"}function fe(){ae(),ee.value="quick"}function Ve(){L.value={},Y.value=!1}const me=m(!1),se=v(()=>me.value?"shortcut show":"shortcut hide");S.registerListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask",invoke:e=>{ne()}}),S.registerListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask",invoke:e=>{oe()}}),S.registerListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask",invoke:e=>{ae()}}),S.registerListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask",invoke:e=>{ve()}}),S.registerListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask",invoke:e=>{fe()}}),S.registerListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs",invoke:e=>{h.value&&(h.value=!1),Y.value&&(Y.value=!1)}});function H(e){A.show(e),setTimeout(Ie,5e3)}function Ie(){A.hide()}c.registerListener("loadTodayLogs",{id:"TodayLog",invoke:e=>{ie()}}),c.registerListener("toggleShortcut",{id:"ToggleTodayLogShortcut",invoke:e=>{me.value=!me.value}});async function Ue(){await E.schemas("work_logs").then(e=>{const r=e.fields;P.value=O(r)}).catch(e=>{H("Error loading schemas!"),console.log(e)})}async function ie(){const e={include:s.value,filters:{startTime:{startDate:_.value,endDate:X.value}},sort:{field:"startTime",order:"desc"}};await E.list("work_logs",e).then(r=>{N.value=a(r.data),n.value=o(N.value[0]),C(n.value.startTime)&&(Z.value=!0)}).catch(r=>{H("Error loading work logs!"),console.log(r)})}return he(async()=>{await ie(),await Ue()}),(e,r)=>(u(),d("div",Qe,[l("div",Ge,[t(F)?w("",!0):(u(),d("div",{key:0,class:"button",tabindex:"0",onClick:ne,onKeydown:x(ne,["enter"])},[J(" Start New Task "),l("div",{class:Q(t(se))},"N",2)],40,Pe)),t(F)?w("",!0):(u(),d("div",{key:1,class:"button",tabindex:"0",onClick:oe,onKeydown:x(oe,["enter"])},[J(" Quick Start New Task "),l("div",{class:Q(t(se))},"Q",2)],40,ze)),t(F)?(u(),d("div",{key:2,class:"button",tabindex:"0",onClick:ae,onKeydown:x(ae,["enter"])},[J(" End Current Task "),l("div",{class:Q(t(se))},"E",2)],40,Ye)):w("",!0),t(F)?(u(),d("div",{key:3,class:"button",tabindex:"0",onClick:ve,onKeydown:x(ve,["enter"])},[J(" End and Start New "),l("div",{class:Q(t(se))},"G",2)],40,Je)):w("",!0),t(F)?(u(),d("div",{key:4,class:"button",tabindex:"0",onClick:fe,onKeydown:x(fe,["enter"])},[J(" End and Quick Start "),l("div",{class:Q(t(se))},"F",2)],40,Re)):w("",!0)]),l("div",Xe,[l("div",Ze," Today's total: "+M(t(W)(t(i))),1),(u(!0),d(ke,null,_e(N.value,y=>(u(),d("div",et,[tt,l("div",at,[l("div",st,M(t(b)(y.startTime)),1),t(C)(y.endTime)?(u(),d("div",nt," to "+M(t(b)(y.endTime)),1)):w("",!0),t(C)(y.endTime)?(u(),d("div",ot," ("+M(t(W)(y.duration))+") ",1)):w("",!0),t(T)(y.endTime)?(u(),d("div",it," (not ended) ")):w("",!0)]),l("div",lt,M(y.description),1)]))),256))]),G(Le,{modelValue:h.value,"onUpdate:modelValue":r[0]||(r[0]=y=>h.value=y),schemas:P.value,"fields-layout":t(g),"data-fields":t(z),data:n.value,fullscreen:!0,"dialog-title":"Start Task",onSubmit:Se},null,8,["modelValue","schemas","fields-layout","data-fields","data"]),G(Le,{modelValue:Y.value,"onUpdate:modelValue":r[1]||(r[1]=y=>Y.value=y),schemas:P.value,"fields-layout":t(g),"data-fields":t(z),data:L.value,fullscreen:!0,"dialog-title":"End Task",onSubmit:We},null,8,["modelValue","schemas","fields-layout","data-fields","data"])]))}},ut=ge(rt,[["__scopeId","data-v-b707717a"]]);const De=k=>(Te("data-v-ba62155a"),k=k(),be(),k),ct={class:"weekly-tab-container"},dt={class:"weekly-tabs"},vt=["onKeydown"],ft=De(()=>l("i",{class:"fa-solid fa-angle-left"},null,-1)),mt=["onKeydown"],yt=["onKeydown"],kt=De(()=>l("i",{class:"fa-solid fa-angle-right"},null,-1)),_t={class:"weekly-tab-content"},gt={key:0,class:"total"},pt={key:1,class:"total"},ht={class:"timeline"},Tt={class:"day"},bt=De(()=>l("div",{class:"divider"},null,-1)),wt={class:"heading"},Dt={class:"date"},St={key:0,class:"duration"},$t={key:1,class:"duration"},Lt={class:"entries"},xt={key:0},Ct={class:"entry"},Et={class:"description"},Wt={class:"duration"},Vt={__name:"WeekLog",props:{loadData:{type:Boolean,default:!1}},setup(k){ue(),ce();const T=we(),{formatLongDate:C}=xe(),{worklogsUrl:E,formatDuration:b,calculateDuration:j}=de(),B=pe(),q=re(),f=m("this"),g=m({}),p=m(0),D=m("prevWeekTab"),W=m("thisWeekTab"),V=m("nextWeekTab"),s=v(()=>{const i=new Date,a=new Date,o=p.value*7;return f.value==="prev"?(a.setDate(a.getDate()+o),a.setDate(a.getDate()-i.getDay())):(f.value==="next"&&a.setDate(a.getDate()+o),a.setDate(a.getDate()-i.getDay())),a.setHours(0),a.setMinutes(0),a.setSeconds(0),a}),O=v(()=>{const i=new Date;return i.setDate(s.value.getDate()+6),i.setHours(23),i.setMinutes(59),i.setSeconds(59),i}),I=v(()=>Array.from(Array(7)).map((i,a)=>{const o=new Date(s.value);return o.setDate(s.value.getDate()+a),o.setHours(0),o.setMinutes(0),o.setSeconds(0),o})),K=v(()=>({startTime:{startDate:s.value,endDate:O.value}})),U=v(()=>Object.entries(g.value).reduce((i,[a,{total:o}])=>i+o,0));function $(i){return g.value[i]?g.value[i]:{total:0,entries:[]}}function R(i){const a=I.value.reduce((o,h)=>(o[h]={entries:[],total:0},o),{});return i.forEach(o=>{const h=new Date(o.startTime),Z=new Date(h.getFullYear(),h.getMonth(),h.getDate(),0,0,0),te=j(o);a[Z].entries.push(Object.assign({},o,{duration:te})),a[Z].total=a[Z].total+te}),a}function A(i){B.show(i),setTimeout(c,5e3)}function c(){B.hide()}q.registerListener("loadWeeklyLogs",{id:"WeekLog",invoke:i=>{F()}});const S=v(()=>f.value==="prev"?"weekly-tab active":"weekly-tab"),P=v(()=>f.value==="this"?"weekly-tab active":"weekly-tab"),z=v(()=>f.value==="next"?"weekly-tab active":"weekly-tab");async function n(){p.value=p.value-1,f.value="prev",D.value.blur(),await F()}async function _(){p.value=0,f.value="this",W.value.blur(),await F()}async function X(){p.value=p.value+1,f.value="next",V.value.blur(),await F()}function N(i){i==="prev"?D.value.focus():i==="next"?V.value.focus():W.value.focus()}async function F(){const i={filters:K.value};await T.list("work_logs",i).then(a=>{g.value=R(a.data)}).catch(a=>{A("Error loading work logs!"),console.log(a)})}return he(async()=>{await F()}),(i,a)=>(u(),d("div",ct,[l("div",dt,[l("div",{class:Q(t(S)),tabindex:"0",ref_key:"prevWeekTab",ref:D,onClick:n,onKeydown:[x(n,["enter"]),a[0]||(a[0]=x(o=>N("this"),["arrow-right"]))]},[ft,J(" Prev Week ")],42,vt),l("div",{class:Q(t(P)),tabindex:"0",ref_key:"thisWeekTab",ref:W,onClick:_,onKeydown:[x(_,["enter"]),a[1]||(a[1]=x(o=>N("prev"),["arrow-left"])),a[2]||(a[2]=x(o=>N("next"),["arrow-right"]))]}," This Week ",42,mt),l("div",{class:Q(t(z)),tabindex:"0",ref_key:"nextWeekTab",ref:V,onClick:X,onKeydown:[x(X,["enter"]),a[3]||(a[3]=x(o=>N("this"),["arrow-left"]))]},[J(" Next Week "),kt],42,yt)]),l("div",_t,[t(U)>0?(u(),d("div",gt," Week's total: "+M(t(b)(t(U))),1)):w("",!0),t(U)===0?(u(),d("div",pt," Week's total: 0 h 0 m 0 s ")):w("",!0),l("div",ht,[(u(!0),d(ke,null,_e(t(I),o=>(u(),d("div",Tt,[bt,l("div",wt,[l("div",Dt,M(t(C)(o)),1),$(o).total>0?(u(),d("div",St," ("+M(t(b)($(o).total))+") ",1)):w("",!0),$(o).total===0?(u(),d("div",$t," (0 h 0 m 0 s) ")):w("",!0)]),l("div",Lt,[$(o).entries.length===0?(u(),d("div",xt," No entry ")):w("",!0),(u(!0),d(ke,null,_e($(o).entries,h=>(u(),d("div",Ct,[l("div",Et,M(h.description),1),l("div",Wt,M(t(b)(h.duration)),1)]))),256))])]))),256))])])]))}},It=ge(Vt,[["__scopeId","data-v-ba62155a"]]),Ut={class:"view-template"},Ft=l("div",{class:"divider"},null,-1),Kt={__name:"GenerateInvoice",props:{},setup(k){const T=ue(),{tagsUrl:C,worklogsUrl:E,dataFields:b,recordValue:j,tagLabel:B,calculateDuration:q}=de(),f=`${T.baseUrl}/api/invoice_configs`;function g(n){return`Every ${n.invoiceCycleDurationValue} ${n.invoiceCycleDurationUnit}, due in ${n.dueDateCycleValue} ${n.dueDateCycleUnit}`}const p=v(()=>{const n=[];return n.push(Object.assign({},b.find(_=>_.key==="tags"))),n.push(Object.assign({},b.find(_=>_.key==="startTime"),{type:"datetimerange"})),n.push(Object.assign({},b.find(_=>_.key==="endTime"),{type:"datetimerange"})),n.push({key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",updatable:!0,reference:{label:g},options:{server:!0,pagination:!0,modelClass:"invoice_configs",sourceUrl:f,value:j,label:g}}),n}),D=Ce(p.value);ce();const W=we(),V=pe();re();const s=m({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}),O=v(()=>[{invoiceConfigId:"lg",tags:"lg"},{startTime:"md"},{endTime:"md"}]),I=v(()=>p.value.map(n=>n.key)),K=m({}),U=v(()=>({type:"text",value:"Filter",icon:"fa-solid fa-check"})),$=v(()=>({type:"text",value:"Cancel",icon:"fa-solid fa-xmark"}));function R(n){V.show(n),setTimeout(A,5e3)}function A(){V.hide()}const c=m(),S=m(!1);async function P(){S.value=!1;const n=D.formatFilters(s.value);W.create("work_logs",n,{path:"preview_invoice"}).then(_=>{c.value=_,c.value.invoice.invoiceDate=new Date(c.value.invoice.invoiceDate),c.value.invoice.dueDate=new Date(c.value.invoice.dueDate),S.value=!0}).catch(_=>{console.error(_),R("Error previewing invoice!")})}function z(){S.value=!1,s.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}return he(()=>{z()}),(n,_)=>(u(),d("div",Ut,[G(Me,{modelValue:s.value,"onUpdate:modelValue":_[0]||(_[0]=X=>s.value=X),"fields-layout":t(O),"data-fields":t(I),schemas:t(p),"error-messages":K.value,"confirm-button":t(U),"cancel-button":t($),onSubmit:P,onCancel:z},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"]),Ft,S.value?(u(),Ne(Ae,{key:0,invoice:c.value.invoice,"invoice-lines":c.value.invoiceLines,"invoice-config":c.value.invoiceConfig,"invoice-number-sequence":c.value.invoiceNumberSequence,contact:c.value.billingContact,"invoice-template":c.value.invoiceTemplate,currency:c.value.currency},null,8,["invoice","invoice-lines","invoice-config","invoice-number-sequence","contact","invoice-template","currency"])):w("",!0)]))}};const Nt=k=>(Te("data-v-1434023a"),k=k(),be(),k),Mt={class:"view-container"},Bt=Nt(()=>l("h2",{class:"heading"},"Time Tracking",-1)),Ot={__name:"view",setup(k){const T=re(),{dataFields:C,fieldsLayout:E,filters:b,validations:j}=de(),B=[{label:"Today",onchange:q},{label:"Weekly",onchange:f},{label:"Generate Invoice",onchange:()=>{}},{label:"All Logs",onchange:g}];function q(){T.emitEvent("loadTodayLogs",{})}function f(){T.emitEvent("loadWeeklyLogs",{})}function g(){T.emitEvent("loadData",{dataType:"Work Logs"})}function p(D){B[D].onchange()}return(D,W)=>(u(),d("div",Mt,[Bt,G(Oe,{tabs:B,onTabChange:p},{"tab-0":le(()=>[G(ut)]),"tab-1":le(()=>[G(It)]),"tab-2":le(()=>[G(Kt)]),"tab-3":le(()=>[G(Be,{"model-class":"work_logs","data-type":"Work Logs","url-base":"api/work_logs","schemas-url-base":"api/schemas/work_logs",fullscreen:!0,"fields-layout":t(E),"data-fields":t(C),validations:t(j),filters:t(b)},null,8,["fields-layout","data-fields","validations","filters"])]),_:1})]))}},Jt=ge(Ot,[["__scopeId","data-v-1434023a"]]);export{Jt as default};
