import{u as Wt,a as Xt}from"./dataAccess-0d808513.js";import{F as ze,u as He,a as Zt}from"./Form-269cba48.js";import{r,c as i,a as u,b as d,i as S,l as U,f as s,q as pe,v as he,Y as qe,F as R,_ as Ye,e as j,h as k,m as Y,t as C,d as y,x as Ge,S as be,y as Qe,u as _t,k as ea,w as ge,o as ta,z as Ne,n as Pe,A as Ke,B as Ie,D as Je,C as aa,L as la,p as na,g as sa}from"./index-e89d949c.js";import{u as oa}from"./errors-a6177d44.js";const Me={__name:"FormDialog",props:{modelValue:{type:Boolean,default:!1},fieldsLayout:{type:Array,default:[]},dataFields:{type:Array,default:[]},data:{type:Object,default:{}},schemas:{type:Object,default:{}},dialogTitle:{type:String,default:""},fullscreen:{type:Boolean,default:!1},errorMessages:{type:Object,default(){return{}}}},emits:["update:modelValue","submit"],setup(a,{emit:l}){const D=a,N=r(!1),G=r(""),w=i({get:()=>D.modelValue,set:m=>{l("update:modelValue",m)}}),F=i(()=>D.data);function Q(m){l("submit",m)}function E(){w.value=!1,l("update:modelValue",!1)}return(m,v)=>(u(),d(R,null,[S(s(he),{modelValue:s(w),"onUpdate:modelValue":v[1]||(v[1]=b=>pe(w)?w.value=b:null),title:a.dialogTitle,fullscreen:a.fullscreen,class:"form-dialog"},{body:U(()=>[S(ze,{modelValue:s(F),"onUpdate:modelValue":v[0]||(v[0]=b=>pe(F)?F.value=b:null),"fields-layout":a.fieldsLayout,"data-fields":a.dataFields,schemas:a.schemas,"error-messages":a.errorMessages,onSubmit:Q,onCancel:E},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),_:1},8,["modelValue","title","fullscreen"]),S(s(qe),{title:"Error",content:G.value,width:400,height:250,modelValue:N.value,"onUpdate:modelValue":v[2]||(v[2]=b=>N.value=b)},null,8,["content","modelValue"])],64))}};const ra={class:"data-row"},ia={class:"data-col"},ua={class:"data-label"},da={key:0,class:"data-value"},ca={key:0},fa={key:1,class:"no-value"},va={key:1,class:"data-value tags"},ya={key:0,class:"no-value"},ma={__name:"ViewDialog",props:{modelValue:{type:Boolean,default:!1},keys:{type:Array,default(){return[]}},record:{type:Object,default(){return{}}},dataFields:{type:Array,default(){return[]}},title:{type:String,default:"View"},inputLabel:{type:Function,default(a){return a}},inputValue:{type:Function,default(a,l){return l[a]}},includeKeys:{type:Array,default(){return[]}}},emits:["update:modelValue"],setup(a,{emit:l}){const D=a,{formatTag:N,tagStyle:G}=Qe(),{tagsField:w}=He(D.dataFields),F=i({get:()=>D.modelValue,set:E=>{l("update:modelValue",E)}});function Q(){l("update:modelValue",!1)}return(E,m)=>a.record?(u(),j(s(he),{key:0,modelValue:s(F),"onUpdate:modelValue":m[1]||(m[1]=v=>pe(F)?F.value=v:null),title:a.title},{body:U(()=>[k("div",ra,[(u(!0),d(R,null,Y(a.keys,v=>(u(),d("div",ia,[k("div",ua,C(a.inputLabel(v)),1),s(w)(v)?y("",!0):(u(),d("div",da,[a.record[v]?(u(),d("div",ca,C(a.inputValue(v,a.record,a.includeKeys,a.dataFields)),1)):y("",!0),a.record[v]?y("",!0):(u(),d("div",fa," --- no value --- "))])),s(w)(v)?(u(),d("div",va,[(u(!0),d(R,null,Y(a.record[v],b=>(u(),d("div",{class:"tag",style:Ge(s(G)(a.record,b,v))},C(s(N)(a.record,b,v)),5))),256)),a.record[v].length===0?(u(),d("div",ya," --- no value --- ")):y("",!0)])):y("",!0)]))),256))])]),actions:U(()=>[S(s(be),{"button-type":"text",value:"Close",icon:"fa-solid fa-xmark",onClick:m[0]||(m[0]=v=>Q())})]),_:1},8,["modelValue","title"])):y("",!0)}},ga=Ye(ma,[["__scopeId","data-v-f27ca733"]]);const se=a=>(na("data-v-544398d7"),a=a(),sa(),a),pa={class:"page-container"},ba={class:"heading"},ha=se(()=>k("h3",{class:"heading"},"Filters",-1)),ka=["onClick"],Da=se(()=>k("i",{class:"fa-solid fa-sort"},null,-1)),wa=se(()=>k("i",{class:"fa-solid fa-sort-up"},null,-1)),Fa=se(()=>k("i",{class:"fa-solid fa-sort-down"},null,-1)),Va={key:0,class:"col"},Oa={class:"col"},Ca={key:0},Sa={key:0},Aa={key:1,class:"no-value"},xa={key:1},Ta={key:0,class:"no-value"},$a=["download","href"],ja={__name:"DataPage",props:{dataType:{type:String,default:""},modelClass:{type:String,default:null},urlBase:{type:String,default:""},schemasUrlBase:{type:String,default:""},filters:{type:Object,default:{}},dataFields:{type:Array,default:[]},fieldsLayout:{type:Array,default:[]},validations:{type:Object,default:{}},fullscreen:{type:Boolean,default:!1},createDialogTitle:{type:Function,default:function(a){return`Create ${a}`}},viewDialogTitle:{type:Function,default:function(a,l){return`View ${a} ${l.id}`}},updateDialogTitle:{type:Function,default:function(a,l){return l?`Update ${a} ${l.id}`:""}},deleteDialogTitle:{type:Function,default:function(a,l){return l?`Delete ${a} ${l.id}`:""}},deleteDialogPrimaryText:{type:Function,default:function(a,l){return l?`Are you sure you want to delete ${a} ${l.id}?`:""}},deleteDialogSecondaryText:{type:Function,default:function(a,l){return l?JSON.stringify(l,!1,2):""}},actions:{type:Object,default:{}}},setup(a){const l=a,D=Wt(),{schemasMap:N,multiSelectableFields:G,singleSelectableFields:w,clientOptionsFields:F,inputType:Q,inputLabel:E,inputValue:m,multiSelectableField:v,singleSelectableField:b,selectableField:Ua,tagsField:ke,formatInputOptionsData:Ea,formatDataForShow:oe,formatDataForSave:De,formatErrorsForDisplay:we,formatFilters:Fe,fetchOptions:Ba,initOptionsData:We}=He(l.dataFields),{formatDate:La,formatTimestamp:Ra,formatTag:Xe,tagStyle:Ze}=Qe(),_e=oa(),A=Xt();Zt();const Ve=_t(),et=ea();i(()=>`${D.baseUrl}/${l.urlBase}`),i(()=>`${D.baseUrl}/${l.schemasUrlBase}`);const tt=i(()=>l.dataFields.filter(e=>e.reference)),W=i(()=>tt.value.map(e=>e.key)),x=r(Array.from(l.dataFields)),Oe=r(!1),re=r(!1);function Ce(e,t){return Object.keys(e).reduce((n,o)=>{const c=e[o].map(g=>g(t)).filter(g=>!!g);return c.length>0&&(n[o]=c),n},{})}function at(e){x.value=x.value.map(t=>{if(t.type==="enum"){const n=e[t.key].enums,o=Object.keys(n).map(c=>({value:c,label:n[c]}));return Object.assign({},t,{options:o})}else return t})}const lt=r(l.filters.layout),ie=r(!1),B=r({}),Se=r(Array.from(l.dataFields)),nt=r({}),st=i(()=>({type:"icon",icon:"fa-solid fa-check"})),ot=i(()=>({type:"icon",icon:"fa-solid fa-filter-circle-xmark"})),rt=i(()=>l.dataFields.filter(e=>e.filterable).reduce((e,t)=>(e[t.key]=t,e),{})),ue=i(()=>Object.keys(rt.value)),Ae=i(()=>lt.value&&Oe.value&&re.value),it=i(()=>l.filters.layout),ut=i(()=>ie.value?"filters expanded":"filters collapsed");async function dt(e){I.value=0,await L()}async function P(){re.value=!1,B.value=Fe(Object.assign({},l.filters.initData));const e=ue.value.map(t=>oe(t,B.value));Promise.all(e).then(t=>{ue.value.forEach((n,o)=>{B.value[n]=t[o]}),re.value=!0,L()})}function ct(){ie.value=!ie.value}function ft(){Se.value=Array.from(x.value).map(e=>{const t=Object.assign({},e);return t.filterable&&(t.type==="date"?t.type="daterange":t.type==="datetime"?t.type="datetimerange":t.type==="number"&&(t.type="numberrange")),t}).filter(e=>e.filterable)}const X=r("id"),K=r(!0),vt=i(()=>({field:X.value,order:K.value?"asc":"desc"})),yt=i(()=>l.dataFields.filter(e=>e.sortable).reduce((e,t)=>(e[t.key]=t,e),{})),mt=i(()=>Object.keys(yt.value));function de(e){return mt.value.includes(e)}const gt=i(()=>l.dataFields.reduce((e,t)=>{const n=t.key;return de(n)&&n===X.value?K.value?e[n]="header-field sort down":e[n]="header-field sort up":de(n)?e[n]="header-field sort reset":e[n]="header-field nosort",e},{}));async function pt(e){de(e)&&(e===X.value?K.value=!K.value:(X.value=e,K.value=!0),I.value=0,await L())}const bt=i(()=>{const e={name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(ne){await jt()}},t=l.actions.create||{},n=Object.assign({},e,t),o={name:"Export",icon:"fa-solid fa-file-export",click:async function(ne){await Gt()}},f=l.actions.export||{},c=Object.assign({},o,f),g={name:"Filter",icon:"fa-solid fa-filter",click:async function(){ct()}},ye=l.actions.filter||{},me=Object.assign({},g,ye),O=[n,c];return Ae.value&&O.unshift(me),O}),ht=i(()=>{const e={name:"View",icon:"fa-solid fa-magnifying-glass",click:async function(O,ne){await xt(O.id)}},t=l.actions.view||{},n=Object.assign({},e,t),o={name:"Update",icon:"fa-solid fa-pen-to-square",click:async function(O,ne){await Kt(O.id)}},f=l.actions.update||{},c=Object.assign({},o,f),g={name:"Delete",icon:"fa-solid fa-trash-can",click:async function(O,ne){await qt(O.id)}},ye=l.actions.remove||{},me=Object.assign({},g,ye);return[n,c,me]}),xe=r([]),Te=r(0),I=r(0),$e=r(5),Z=r(!1),kt=i(()=>l.dataFields.filter(e=>e.listable)),Dt=i(()=>xe.value||[]);async function wt(e){I.value=e,await L()}const Ft=r({});et.registerListener("loadData",{id:`DataPage-${l.dataType}`,invoke:e=>{e.dataType===l.dataType&&L()}});async function Vt(){await A.schemas(l.modelClass).then(e=>{const t=e.fields;at(t),ft(),Oe.value=!0}).catch(e=>{console.error(e),h("Error loading schemas!")})}async function L(){const e={include:W.value,offset:I.value,limit:$e.value,filters:Fe(B.value),sort:vt.value};Z.value=!0,await A.list(l.modelClass,e).then(t=>{xe.value=t.data,Te.value=t.total,Z.value=!1}).catch(t=>{Z.value=!1,console.error(t),h("Error loading data!")})}async function ce(e,t,n){const o={include:W.value};await A.view(l.modelClass,e,o).then(f=>{t(f)}).catch(f=>{n(f)})}function h(e){Ve.show(e),setTimeout(Ot,5e3)}function Ot(){Ve.hide()}const V=r(!1),p=r(""),Ct=i(()=>p.value&&p.value.length>0?(p.value.match(/.{1,100}/g)??[]).join(`
`):""),je=i(()=>({width:800,height:400})),fe=r(!1),J=r(),St=i(()=>l.dataFields.filter(e=>e.viewable).reduce((e,t)=>(e[t.key]=t,e),{})),At=i(()=>Object.keys(St.value));async function xt(e){ce(e,t=>{J.value=t,fe.value=!0},t=>{J.value=null,V.value=!0,p.value=JSON.stringify(t,!1,4)})}const M=r(!1),z=r(),_=r({}),Tt=i(()=>l.dataFields.filter(e=>e.creatable).reduce((e,t)=>(e[t.key]=t,e),{})),ve=i(()=>Object.keys(Tt.value)),$t=i(()=>l.validations.create||[]);ge(M,(e,t)=>{e||(_.value={})});async function jt(e){z.value={};const t=ve.value.map(n=>oe(n,{}));Promise.all(t).then(n=>{ve.value.forEach((o,f)=>{z.value[o]=n[f],M.value=!0})})}async function Ut(e){const t=Et(e);if(Object.keys(t).length>0){_.value=t,h("Error creating data!");return}const n=De(e);await A.create(l.modelClass,n).then(o=>{h("Data created successfully!"),P(),Bt()}).catch(o=>{_.value=we(o),h("Error creating data!")})}function Et(e){return Ce($t.value,e)}function Bt(){M.value=!1,Lt()}function Lt(){z.value=null}const H=r(!1),T=r(),ee=r({}),Rt=i(()=>l.dataFields.filter(e=>e.updatable).reduce((e,t)=>(e[t.key]=t,e),{})),Nt=i(()=>Object.keys(Rt.value)),Pt=i(()=>l.validations.update||[]);ge(H,(e,t)=>{e||(ee.value={})});async function Kt(e){ce(e,t=>{zt(t),H.value=!0},t=>{Ue(),V.value=!0,p.value=JSON.stringify(t,!1,4)})}async function It(e){const t=Jt(e);if(Object.keys(t).length>0){ee.value=t,h("Error updating data!");return}const n=e.id,o=De(e);await A.update(l.modelClass,n,o).then(f=>{h("Data updated successfully!"),P(),Mt()}).catch(f=>{ee.value=we(f),h("Error updating data!")})}function Jt(e){return Ce(Pt.value,e)}function Mt(){H.value=!1,Ue()}async function zt(e){T.value={};const t=l.dataFields.map(n=>{const o=n.key;return oe(o,e)});Promise.all(t).then(n=>{l.dataFields.forEach((o,f)=>{const c=o.key;T.value[c]=n[f]})})}function Ue(){T.value=null}const q=r(!1),$=r(),Ht=r({});ge(q,(e,t)=>{e||(Ht.value={})});async function qt(e){ce(e,t=>{$.value=t,q.value=!0},t=>{Be(),V.value=!0,p.value=JSON.stringify(t,!1,4)})}async function Yt(){const t=$.value.id;await A.remove(l.modelClass,t).then(n=>{h("Data deleted successfully!"),P()}).catch(n=>{V.value=!0,p.value=n.map(o=>_e[o]()).join(", ")}).finally(()=>{Ee()})}function Ee(){q.value=!1,Be()}function Be(){$.value=null}const te=r(!1),ae=r(),le=r(),Le=r("downloadAnchor");async function Gt(){await A.download(l.modelClass).then(e=>{const t=window.URL.createObjectURL(new Blob([e.data]));ae.value=t,le.value=e.filename,te.value=!0}).catch(e=>{V.value=!0,p.value=JSON.stringify(result.error,!1,4)})}function Qt(){Le.value.click(),Re()}function Re(){te.value=!1,ae.value=null,le.value=null}return ta(async()=>{await Vt(),await L(),await We().then(e=>{Ft.value=e}).catch(e=>{V.value=!0,p.value=JSON.stringify(e,!1,4)}),await P()}),(e,t)=>(u(),d("div",pa,[k("h2",ba,C(a.dataType),1),s(Ae)?(u(),d("div",{key:0,class:Ne(s(ut))},[ha,S(ze,{modelValue:B.value,"onUpdate:modelValue":t[0]||(t[0]=n=>B.value=n),"fields-layout":s(it),"data-fields":s(ue),schemas:Se.value,"error-messages":nt.value,"confirm-button":s(st),"cancel-button":s(ot),compact:!0,onSubmit:dt,onCancel:P},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"])],2)):y("",!0),S(s(aa),{name:"",headers:s(kt),data:s(Dt),"table-actions":s(bt),actions:s(ht),loading:Z.value,pagination:{offset:I.value,limit:$e.value,client:!1},"total-data":Te.value,onOffsetChange:wt},{"header-row":U(({headers:n,actions:o})=>[(u(!0),d(R,null,Y(n,(f,c)=>(u(),d("th",{class:"col",onClick:g=>pt(f.key)},[k("div",{class:Ne(s(gt)[f.key])},[Pe(C(f.label)+" ",1),Da,wa,Fa],2)],8,ka))),256)),o.length>0?(u(),d("th",Va)):y("",!0)]),"data-content":U(({headers:n,row:o,i:f})=>[(u(!0),d(R,null,Y(n,c=>(u(),d("td",Oa,[Ke(e.$slots,`data-col.${c.key}`,Ie(Je({header:c,row:o,i:f})),()=>[s(ke)(c.key)?y("",!0):(u(),d("div",Ca,[o[c.key]?(u(),d("div",Sa,C(s(m)(c.key,o,s(W),x.value)),1)):y("",!0),o[c.key]?y("",!0):(u(),d("div",Aa," --- no value --- "))])),s(ke)(c.key)?(u(),d("div",xa,[(u(!0),d(R,null,Y(o[c.key],g=>(u(),d("div",{class:"tag",style:Ge(s(Ze)(o,g,c.key))},C(s(Xe)(o,g,c.key)),5))),256)),o.tags.length===0?(u(),d("div",Ta," --- no value --- ")):y("",!0)])):y("",!0)],!0)]))),256))]),_:3},8,["headers","data","table-actions","actions","loading","pagination","total-data"]),p.value.length>0?(u(),j(s(qe),{key:1,title:"Error",class:"error-alert",content:s(Ct),width:s(je).width,height:s(je).height,modelValue:V.value,"onUpdate:modelValue":t[1]||(t[1]=n=>V.value=n)},null,8,["content","width","height","modelValue"])):y("",!0),z.value?(u(),j(Me,{key:2,modelValue:M.value,"onUpdate:modelValue":t[2]||(t[2]=n=>M.value=n),schemas:x.value,"fields-layout":a.fieldsLayout,"data-fields":s(ve),data:z.value,"dialog-title":a.createDialogTitle(a.dataType),fullscreen:a.fullscreen,"error-messages":_.value,onSubmit:Ut},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):y("",!0),Ke(e.$slots,"updateDialog",Ie(Je({row:T.value})),()=>[T.value?(u(),j(Me,{key:0,modelValue:H.value,"onUpdate:modelValue":t[3]||(t[3]=n=>H.value=n),schemas:x.value,"fields-layout":a.fieldsLayout,"data-fields":s(Nt),data:T.value,"dialog-title":a.updateDialogTitle(a.dataType,T.value),fullscreen:a.fullscreen,"error-messages":ee.value,onSubmit:It},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):y("",!0)],!0),J.value?(u(),j(ga,{key:3,modelValue:fe.value,"onUpdate:modelValue":t[4]||(t[4]=n=>fe.value=n),keys:s(At),"include-keys":s(W),"data-fields":x.value,record:J.value,title:a.viewDialogTitle(a.dataType,J.value),"input-label":s(E),"input-value":s(m),class:"view-dialog"},null,8,["modelValue","keys","include-keys","data-fields","record","title","input-label","input-value"])):y("",!0),$.value?(u(),j(s(la),{key:4,modelValue:q.value,"onUpdate:modelValue":t[5]||(t[5]=n=>q.value=n),title:a.deleteDialogTitle(a.dataType,$.value),"primary-text":a.deleteDialogPrimaryText(a.dataType,$.value),"secondary-text":a.deleteDialogSecondaryText(a.dataType,$.value),width:500,height:350,onConfirm:Yt,onCancel:Ee,class:"delete-dialog"},null,8,["modelValue","title","primary-text","secondary-text"])):y("",!0),ae.value?(u(),j(s(he),{key:5,modelValue:te.value,"onUpdate:modelValue":t[8]||(t[8]=n=>te.value=n),title:"Download export file",width:400,height:250},{body:U(()=>[Pe(C(le.value),1)]),actions:U(()=>[k("a",{class:"hidden",ref_key:"downloadAnchor",ref:Le,rel:"noreferrer",download:le.value,href:ae.value},null,8,$a),S(s(be),{"button-type":"text",value:"Download",icon:"fa-solid fa-file-arrow-down",onClick:t[6]||(t[6]=n=>Qt())}),S(s(be),{"button-type":"text",value:"Cancel",icon:"fa-solid fa-xmark",onClick:t[7]||(t[7]=n=>Re())})]),_:1},8,["modelValue"])):y("",!0)]))}},Ja=Ye(ja,[["__scopeId","data-v-544398d7"]]);export{Ja as D,Me as _};
