import{c as f,_ as fe,u as me,k as oe,V as Ee,r as m,w as Ce,o as ye,a as c,b as d,h as i,f as a,N as C,n as J,z as Q,d as D,t as M,F as de,m as ve,i as G,y as we,p as ke,g as _e,e as Ve,l as ne}from"./index-cf9ea608.js";import{a as ie,u as De,F as Ie}from"./Form-6ecdf185.js";import{_ as be,D as Fe}from"./DataPage-a796708b.js";import{T as Ke}from"./TabContainer-bd4cd668.js";import{a as pe}from"./dataAccess-238ee380.js";import Ne from"./CreateInvoice-76860c1a.js";import"./errors-a6177d44.js";import"./utils-47eab738.js";import"./TemplateEditor-6719ac54.js";const{isEmpty:Me,notEarlierThan:Be}=ie();function le(){const y=[{key:"id",type:"text",label:"ID",listable:!0,viewable:!0,creatable:!1,updatable:!1,sortable:!0},{key:"startTime",type:"datetime",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetime",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"description",type:"text",label:"Description",defaultValue:()=>"New Task",listable:!0,viewable:!0,creatable:!0,updatable:!0},{key:"content",type:"textarea",label:"Content",listable:!1,viewable:!0,creatable:!0,updatable:!0},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:g},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:I,label:g}}],p=[{startTime:"md",endTime:"md"},{description:"lg"},{content:"lg"},{tags:"lg"}],W={initData:{startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},layout:[{tags:"md"},{startTime:"md"},{endTime:"md"}]},S={create:{endTime:[w]},update:{endTime:[w]}};function I(s){return s.id}function g(s){return`${s.category}:${s.name}`}function w(s){return Be(s,"endTime","startTime")}function h(s){if(s===0)return"0 h 0 m 0 s";const x=Math.floor(s/1e3/60/60/24),$=x*1e3*60*60*24,F=Math.floor((s-$)/1e3/60/60),K=F*1e3*60*60,B=Math.floor((s-$-K)/1e3/60),O=B*1e3*60,l=Math.floor((s-$-K-O)/1e3),b=[];return x>0&&b.push(`${x} d`),F>0&&b.push(`${F} h`),B>0&&b.push(`${B} m`),l>0&&b.push(`${l} s`),b.join(" ")}function L(s){return Me(s.endTime)?new Date-new Date(s.startTime):new Date(s.endTime)-new Date(s.startTime)}const _=f(()=>y.filter(s=>s.reference)),T=f(()=>_.value.map(s=>s.key));return{dataFields:y,fieldsLayout:p,filters:W,validations:S,formatDuration:h,calculateDuration:L,includeKeys:T,recordValue:I,tagLabel:g}}const Oe=y=>(ke("data-v-15db9158"),y=y(),_e(),y),Ae={class:"today-logs-container"},je={class:"controls"},qe=["onKeydown"],He=["onKeydown"],Ue=["onKeydown"],Qe=["onKeydown"],Ge=["onKeydown"],Pe={class:"logs"},ze={class:"total"},Ye={class:"log"},Je=Oe(()=>i("div",{class:"divider"},null,-1)),Re={class:"duration"},Xe={class:"start-time"},Ze={key:0,class:"end-time"},et={key:1,class:"elapsed"},tt={key:2,class:"elapsed"},at={class:"description"},st={__name:"TodayLog",setup(y){const{isEmpty:p,notEmpty:W}=ie(),S=pe(),{formatShortTime:I}=we(),{dataFields:g,fieldsLayout:w,filters:h,validations:L,formatDuration:_,calculateDuration:T,includeKeys:s}=le(),{formatDataFields:x,validateParams:$,formatDataForShow:F,formatDataForSave:K,fetchOptions:B,initOptionsData:O}=De(g),l=me(),b=oe(),N=Ee(),A=m([]),v=f(()=>g.map(e=>e.key)),r=m({}),Z=f(()=>{const e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e}),ae=f(()=>{const e=new Date;return e.setHours(23),e.setMinutes(59),e.setSeconds(59),e}),j=m([]),q=f(()=>j.value.length===0?!1:p(r.value.endTime)&&n.value),R=f(()=>j.value.reduce((e,u)=>e+u.duration,0));function P(e){return e.map(u=>(u.duration=T(u),u))}function o(e){return p(e)?{}:(e.duration=T(e),e)}const t=m(!1),n=m(!1);function V(){return g.reduce((e,u)=>{const k=u.key,Te=u.defaultValue;return W(Te)?e[k]=Te():e[k]=null,e},{})}function H(){r.value=V(),X.value="",t.value=!0}async function z(){r.value=V(),X.value="",await he()}function Se(){t.value=!1}async function he(){const e=$(L.create,r.value);if(Object.keys(e).length>0){U("Error submitting task!");return}const u=K(r.value);await S.create("work_logs",u).then(k=>{U("Started task successfully!"),se(),Se()}).catch(k=>{U("Error creating data!")})}const Y=m(!1),X=m(""),E=m({});Ce(Y,(e,u)=>{e||(E.value={})});async function Le(){const e=$(L.update,E.value);if(Object.keys(e).length>0){U("Error submitting task!");return}const u=K(E.value);await S.update("work_logs",E.value.id,u).then(k=>{U("Ended task successfully!"),se(),$e(),X.value==="quick"?z():X.value==="input"&&setTimeout(H,1e3)}).catch(k=>{U("Error submiting task!")})}async function ee(){E.value=Object.assign({},r.value),await F("startTime",E.value).then(e=>{E.value.startTime=e}),await F("tags",E.value).then(e=>{E.value.tags=e}),E.value.endTime=new Date,Y.value=!0}function re(){ee(),X.value="input"}function ue(){ee(),X.value="quick"}function $e(){E.value={},Y.value=!1}const ce=m(!1),te=f(()=>ce.value?"shortcut show":"shortcut hide");N.registerListener({route:"/work_logs",eventType:"ctrl-n"},{id:"TodayStartTask",invoke:e=>{H()}}),N.registerListener({route:"/work_logs",eventType:"ctrl-q"},{id:"TodayQuickStartTask",invoke:e=>{z()}}),N.registerListener({route:"/work_logs",eventType:"ctrl-e"},{id:"TodayEndTask",invoke:e=>{ee()}}),N.registerListener({route:"/work_logs",eventType:"ctrl-g"},{id:"TodayEndTaskAndStartTask",invoke:e=>{re()}}),N.registerListener({route:"/work_logs",eventType:"ctrl-f"},{id:"TodayEndTaskAndQuickStartTask",invoke:e=>{ue()}}),N.registerListener({route:"/work_logs",eventType:"keydown-Escape"},{id:"CloseTodayLogDialogs",invoke:e=>{t.value&&(t.value=!1),Y.value&&(Y.value=!1)}});function U(e){l.show(e),setTimeout(We,5e3)}function We(){l.hide()}b.registerListener("loadTodayLogs",{id:"TodayLog",invoke:e=>{se()}}),b.registerListener("toggleShortcut",{id:"ToggleTodayLogShortcut",invoke:e=>{ce.value=!ce.value}});async function xe(){await S.schemas("work_logs").then(e=>{const u=e.fields;A.value=x(u)}).catch(e=>{U("Error loading schemas!"),console.log(e)})}async function se(){const e={include:s.value,filters:{startTime:{startDate:Z.value,endDate:ae.value}},sort:{field:"startTime",order:"desc"}};await S.list("work_logs",e).then(u=>{j.value=P(u.data),r.value=o(j.value[0]),W(r.value.startTime)&&(n.value=!0)}).catch(u=>{U("Error loading work logs!"),console.log(u)})}return ye(async()=>{await se(),await xe()}),(e,u)=>(c(),d("div",Ae,[i("div",je,[a(q)?D("",!0):(c(),d("div",{key:0,class:"button",tabindex:"0",onClick:H,onKeydown:C(H,["enter"])},[J(" Start New Task "),i("div",{class:Q(a(te))},"N",2)],40,qe)),a(q)?D("",!0):(c(),d("div",{key:1,class:"button",tabindex:"0",onClick:z,onKeydown:C(z,["enter"])},[J(" Quick Start New Task "),i("div",{class:Q(a(te))},"Q",2)],40,He)),a(q)?(c(),d("div",{key:2,class:"button",tabindex:"0",onClick:ee,onKeydown:C(ee,["enter"])},[J(" End Current Task "),i("div",{class:Q(a(te))},"E",2)],40,Ue)):D("",!0),a(q)?(c(),d("div",{key:3,class:"button",tabindex:"0",onClick:re,onKeydown:C(re,["enter"])},[J(" End and Start New "),i("div",{class:Q(a(te))},"G",2)],40,Qe)):D("",!0),a(q)?(c(),d("div",{key:4,class:"button",tabindex:"0",onClick:ue,onKeydown:C(ue,["enter"])},[J(" End and Quick Start "),i("div",{class:Q(a(te))},"F",2)],40,Ge)):D("",!0)]),i("div",Pe,[i("div",ze," Today's total: "+M(a(_)(a(R))),1),(c(!0),d(de,null,ve(j.value,k=>(c(),d("div",Ye,[Je,i("div",Re,[i("div",Xe,M(a(I)(k.startTime)),1),a(W)(k.endTime)?(c(),d("div",Ze," to "+M(a(I)(k.endTime)),1)):D("",!0),a(W)(k.endTime)?(c(),d("div",et," ("+M(a(_)(k.duration))+") ",1)):D("",!0),a(p)(k.endTime)?(c(),d("div",tt," (not ended) ")):D("",!0)]),i("div",at,M(k.description),1)]))),256))]),G(be,{modelValue:t.value,"onUpdate:modelValue":u[0]||(u[0]=k=>t.value=k),schemas:A.value,"fields-layout":a(w),"data-fields":a(v),data:r.value,fullscreen:!0,"dialog-title":"Start Task",onSubmit:he},null,8,["modelValue","schemas","fields-layout","data-fields","data"]),G(be,{modelValue:Y.value,"onUpdate:modelValue":u[1]||(u[1]=k=>Y.value=k),schemas:A.value,"fields-layout":a(w),"data-fields":a(v),data:E.value,fullscreen:!0,"dialog-title":"End Task",onSubmit:Le},null,8,["modelValue","schemas","fields-layout","data-fields","data"])]))}},nt=fe(st,[["__scopeId","data-v-15db9158"]]);const ge=y=>(ke("data-v-7d5db8fc"),y=y(),_e(),y),ot={class:"weekly-tab-container"},it={class:"weekly-tabs"},lt=["onKeydown"],rt=ge(()=>i("i",{class:"fa-solid fa-angle-left"},null,-1)),ut=["onKeydown"],ct=["onKeydown"],dt=ge(()=>i("i",{class:"fa-solid fa-angle-right"},null,-1)),vt={class:"weekly-tab-content"},ft={key:0,class:"total"},mt={key:1,class:"total"},yt={class:"timeline"},kt={class:"day"},_t=ge(()=>i("div",{class:"divider"},null,-1)),pt={class:"heading"},gt={class:"date"},ht={key:0,class:"duration"},Tt={key:1,class:"duration"},bt={class:"entries"},wt={key:0},Dt={class:"entry"},St={class:"description"},Lt={class:"duration"},$t={__name:"WeekLog",props:{loadData:{type:Boolean,default:!1}},setup(y){ie();const p=pe(),{formatLongDate:W}=we(),{formatDuration:S,calculateDuration:I}=le(),g=me(),w=oe(),h=m("this"),L=m({}),_=m(0),T=m("prevWeekTab"),s=m("thisWeekTab"),x=m("nextWeekTab"),$=f(()=>{const o=new Date,t=new Date,n=_.value*7;return h.value==="prev"?(t.setDate(t.getDate()+n),t.setDate(t.getDate()-o.getDay())):(h.value==="next"&&t.setDate(t.getDate()+n),t.setDate(t.getDate()-o.getDay())),t.setHours(0),t.setMinutes(0),t.setSeconds(0),t}),F=f(()=>{const o=new Date;return o.setDate($.value.getDate()+6),o.setHours(23),o.setMinutes(59),o.setSeconds(59),o}),K=f(()=>Array.from(Array(7)).map((o,t)=>{const n=new Date($.value);return n.setDate($.value.getDate()+t),n.setHours(0),n.setMinutes(0),n.setSeconds(0),n})),B=f(()=>({startTime:{startDate:$.value,endDate:F.value}})),O=f(()=>Object.entries(L.value).reduce((o,[t,{total:n}])=>o+n,0));function l(o){return L.value[o]?L.value[o]:{total:0,entries:[]}}function b(o){const t=K.value.reduce((n,V)=>(n[V]={entries:[],total:0},n),{});return o.forEach(n=>{const V=new Date(n.startTime),H=new Date(V.getFullYear(),V.getMonth(),V.getDate(),0,0,0),z=I(n);t[H].entries.push(Object.assign({},n,{duration:z})),t[H].total=t[H].total+z}),t}function N(o){g.show(o),setTimeout(A,5e3)}function A(){g.hide()}w.registerListener("loadWeeklyLogs",{id:"WeekLog",invoke:o=>{P()}});const v=f(()=>h.value==="prev"?"weekly-tab active":"weekly-tab"),r=f(()=>h.value==="this"?"weekly-tab active":"weekly-tab"),Z=f(()=>h.value==="next"?"weekly-tab active":"weekly-tab");async function ae(){_.value=_.value-1,h.value="prev",T.value.blur(),await P()}async function j(){_.value=0,h.value="this",s.value.blur(),await P()}async function q(){_.value=_.value+1,h.value="next",x.value.blur(),await P()}function R(o){o==="prev"?T.value.focus():o==="next"?x.value.focus():s.value.focus()}async function P(){const o={filters:B.value};await p.list("work_logs",o).then(t=>{L.value=b(t.data)}).catch(t=>{N("Error loading work logs!"),console.log(t)})}return ye(async()=>{await P()}),(o,t)=>(c(),d("div",ot,[i("div",it,[i("div",{class:Q(a(v)),tabindex:"0",ref_key:"prevWeekTab",ref:T,onClick:ae,onKeydown:[C(ae,["enter"]),t[0]||(t[0]=C(n=>R("this"),["arrow-right"]))]},[rt,J(" Prev Week ")],42,lt),i("div",{class:Q(a(r)),tabindex:"0",ref_key:"thisWeekTab",ref:s,onClick:j,onKeydown:[C(j,["enter"]),t[1]||(t[1]=C(n=>R("prev"),["arrow-left"])),t[2]||(t[2]=C(n=>R("next"),["arrow-right"]))]}," This Week ",42,ut),i("div",{class:Q(a(Z)),tabindex:"0",ref_key:"nextWeekTab",ref:x,onClick:q,onKeydown:[C(q,["enter"]),t[3]||(t[3]=C(n=>R("this"),["arrow-left"]))]},[J(" Next Week "),dt],42,ct)]),i("div",vt,[a(O)>0?(c(),d("div",ft," Week's total: "+M(a(S)(a(O))),1)):D("",!0),a(O)===0?(c(),d("div",mt," Week's total: 0 h 0 m 0 s ")):D("",!0),i("div",yt,[(c(!0),d(de,null,ve(a(K),n=>(c(),d("div",kt,[_t,i("div",pt,[i("div",gt,M(a(W)(n)),1),l(n).total>0?(c(),d("div",ht," ("+M(a(S)(l(n).total))+") ",1)):D("",!0),l(n).total===0?(c(),d("div",Tt," (0 h 0 m 0 s) ")):D("",!0)]),i("div",bt,[l(n).entries.length===0?(c(),d("div",wt," No entry ")):D("",!0),(c(!0),d(de,null,ve(l(n).entries,V=>(c(),d("div",Dt,[i("div",St,M(V.description),1),i("div",Lt,M(a(S)(V.duration)),1)]))),256))])]))),256))])])]))}},Wt=fe($t,[["__scopeId","data-v-7d5db8fc"]]),xt={class:"view-template"},Et=i("div",{class:"divider"},null,-1),Ct={__name:"GenerateInvoice",props:{},setup(y){const{dataFields:p,recordValue:W,tagLabel:S,calculateDuration:I}=le();function g(v){return`Every ${v.invoiceCycleDurationValue} ${v.invoiceCycleDurationUnit}, due in ${v.dueDateCycleValue} ${v.dueDateCycleUnit}`}const w=f(()=>{const v=[];return v.push(Object.assign({},p.find(r=>r.key==="tags"))),v.push(Object.assign({},p.find(r=>r.key==="startTime"),{type:"datetimerange"})),v.push(Object.assign({},p.find(r=>r.key==="endTime"),{type:"datetimerange"})),v.push({key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",updatable:!0,reference:{label:g},options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:W,label:g}}),v}),h=De(w.value);ie();const L=pe(),_=me();oe();const T=m({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}),s=f(()=>[{invoiceConfigId:"lg",tags:"lg"},{startTime:"md"},{endTime:"md"}]),x=f(()=>w.value.map(v=>v.key)),$=m({}),F=f(()=>({type:"text",value:"Filter",icon:"fa-solid fa-check"})),K=f(()=>({type:"text",value:"Cancel",icon:"fa-solid fa-xmark"}));function B(v){_.show(v),setTimeout(O,5e3)}function O(){_.hide()}const l=m(),b=m(!1);async function N(){b.value=!1;const v=h.formatFilters(T.value);L.create("work_logs",v,{path:"preview_invoice"}).then(r=>{l.value=r,l.value.invoice.invoiceDate=new Date(l.value.invoice.invoiceDate),l.value.invoice.dueDate=new Date(l.value.invoice.dueDate),b.value=!0}).catch(r=>{console.error(r),B("Error previewing invoice!")})}function A(){b.value=!1,T.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}return ye(()=>{A()}),(v,r)=>(c(),d("div",xt,[G(Ie,{modelValue:T.value,"onUpdate:modelValue":r[0]||(r[0]=Z=>T.value=Z),"fields-layout":a(s),"data-fields":a(x),schemas:a(w),"error-messages":$.value,"confirm-button":a(F),"cancel-button":a(K),onSubmit:N,onCancel:A},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"]),Et,b.value?(c(),Ve(Ne,{key:0,invoice:l.value.invoice,"invoice-lines":l.value.invoiceLines,"invoice-config":l.value.invoiceConfig,"invoice-number-sequence":l.value.invoiceNumberSequence,contact:l.value.billingContact,"invoice-template":l.value.invoiceTemplate,currency:l.value.currency},null,8,["invoice","invoice-lines","invoice-config","invoice-number-sequence","contact","invoice-template","currency"])):D("",!0)]))}};const Vt=y=>(ke("data-v-a39d22c7"),y=y(),_e(),y),It={class:"view-container"},Ft=Vt(()=>i("h2",{class:"heading"},"Time Tracking",-1)),Kt={__name:"WorkLogs",setup(y){const p=oe(),{dataFields:W,fieldsLayout:S,filters:I,validations:g}=le(),w=[{label:"Today",onchange:h},{label:"Weekly",onchange:L},{label:"Generate Invoice",onchange:()=>{}},{label:"All Logs",onchange:_}];function h(){p.emitEvent("loadTodayLogs",{})}function L(){p.emitEvent("loadWeeklyLogs",{})}function _(){p.emitEvent("loadData",{dataType:"Work Logs"})}function T(s){w[s].onchange()}return(s,x)=>(c(),d("div",It,[Ft,G(Ke,{tabs:w,onTabChange:T},{"tab-0":ne(()=>[G(nt)]),"tab-1":ne(()=>[G(Wt)]),"tab-2":ne(()=>[G(Ct)]),"tab-3":ne(()=>[G(Fe,{"model-class":"work_logs","data-type":"Work Logs",fullscreen:!0,"fields-layout":a(S),"data-fields":a(W),validations:a(g),filters:a(I)},null,8,["fields-layout","data-fields","validations","filters"])]),_:1})]))}},Qt=fe(Kt,[["__scopeId","data-v-a39d22c7"]]);export{Qt as default};
