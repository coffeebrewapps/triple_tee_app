import{_ as Ie,v as Ce,a as _e,u as he,r as o,b as r,d as Le,o as _,c as ke,k as v,q as c,g as l,f as D,e as U,h as Te,j as f,B as h,l as Se,s as Fe,t as we,p as De,i as Ue}from"./index-b3ed4318.js";import{u as x}from"./input-811f8f86.js";import{u as xe}from"./utils-c659d292.js";import{W as Ee}from"./WorkflowContainer-b1135769.js";import{D as G}from"./DataForm-ebf3e12e.js";import{T as Ne}from"./TemplateEditor-6070bea0.js";import"./errors-53bc63a8.js";import"./TabContainer-41a4bb62.js";const je=g=>(De("data-v-6e8529a6"),g=g(),Ue(),g),Oe={class:"page-container"},Ae=je(()=>f("h3",{class:"heading"}," Create Invoice ",-1)),Me={class:"data-col"},Be={class:"data-col"},He={class:"data-col"},qe={class:"data-col"},ze={class:"data-col"},Pe={__name:"CreateInvoice",props:{contactId:{type:String,default:null}},setup(g){const L=g,{isEmpty:J,notEmpty:I}=Ce(),E=_e(),{flashMessage:y}=he(),{generateDataFields:Q,recordValue:k,tagLabel:N,contactLabel:j,invoiceConfigLabel:O}=xe(),V=o({tags:[],contactId:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}),T=r(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:j},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:k,label:j}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:O},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:k,label:O}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:N},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:k,label:N}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),X=x(T.value),Y=r(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),Z=r(()=>T.value.map(e=>e.key)),$=o({});function S(){i.value=null,u.value=[],b.value=null,P.value={}}async function ee(e){const a=H.value.map(t=>q.formatDataForShow(t,e));Promise.all(a).then(t=>{i.value={},H.value.forEach((n,s)=>{i.value[n]=t[s]}),i.value.totalAmount=z.value}).catch(t=>{y("Error generating invoice!"),console.error(t)})}async function te(e){await ee(Object.assign({},e.invoice)),u.value=e.invoiceLines.map(a=>ce(a)),K.value=Object.assign({},e.invoiceConfig),w.value=Object.assign({},e.invoiceNumberSequence),W.value=Object.assign({},e.billingContact),R.value=Object.assign({},e.currency),b.value=Object.assign({},e.invoiceTemplate)}async function ae(){S(),d.value=!0;const e=X.formatFilters(V.value);E.create("invoices",e,{path:"preview_invoice"}).then(a=>{te(a),d.value=!1,C.value=1}).catch(a=>{console.error(a),y("Error previewing invoice!")})}function ne(){S(),V.value={contactId:[],tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}},I(L.contactId)&&(V.value.contactId=[{value:L.contactId}])}const A=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],le=x(A),u=o([]),oe=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await ue()}}],ie=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,a){await M(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,a){await re(a)}}],d=o(!1),se=r(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function ue(){d.value=!0,u.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),d.value=!1}function re(e){d.value=!0,u.value.splice(e,1),d.value=!1}function ce(e){const a={};return a.description=e.description,a.unit=e.unit,a.unitCost=m(e.unitCost),a.unitValue=m(e.unitValue),J(e.subtotal)?M(a):a.subtotal=m(e.subtotal),a}function m(e){return(e||0).toFixed(2)}function M(e){const a=e.unitCost,t=e.unitValue;I(a)&&I(t)?e.subtotal=m(parseFloat(a)*parseFloat(t)):e.subtotal=m(0),i.value.totalAmount=z.value}const de=o([]);function p(e,a){return de[e]?p[e][a]:""}const i=o(),B=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],ve=r(()=>B.reduce((e,a)=>(Object.keys(a).forEach(t=>{e.push(t)}),e),[])),F=r(()=>Q(L.contactId)),H=r(()=>F.value.map(e=>e.key)),q=x(F.value),z=r(()=>{const e=u.value.reduce((a,t)=>I(t.subtotal)?a+parseFloat(t.subtotal):a,0);return m(e)}),P=o({}),b=o(),K=o(),w=o(),W=o(),R=o(),me=r(()=>({invoice:i.value,invoiceLines:u.value,invoiceConfig:K.value,invoiceNumberSequence:w.value,billingContact:W.value,currency:R.value}));async function pe(){return new Promise((e,a)=>{const t=u.value.map(n=>le.formatDataForSave(n));Promise.all(t).then(n=>{e(n)}).catch(n=>{a(n)})})}async function be(){await pe().then(e=>{const a=Object.assign({},{invoice:q.formatDataForSave(i.value),invoiceNumberSequence:w.value,invoiceLines:e});E.create("invoices",a,{path:"generate_with_lines"}).then(t=>{i.value.id=t.id,u.value=t.invoiceLines,C.value=2,y("Invoice created successfully!")}).catch(t=>{y("Error creating invoice!"),console.error(t)})}).catch(e=>{y("Error formatting invoice for save!"),console.error(e)})}const C=o(0),fe=r(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function ge(e){e===0&&(S(),C.value=e)}async function ye(e){e===1&&await ae()}async function Ve(){await be()}return Le(()=>{ne()}),(e,a)=>(_(),ke("div",Oe,[Ae,v(Ee,{steps:l(fe),"current-step-number":C.value,onPrevStep:ge,onNextStep:ye,onSubmit:Ve},{"step-0":c(()=>[v(G,{modelValue:V.value,"onUpdate:modelValue":a[0]||(a[0]=t=>V.value=t),"fields-layout":l(Y),"data-fields":l(Z),schemas:l(T),"error-messages":$.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":c(()=>[i.value?(_(),D(G,{key:0,modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=t=>i.value=t),"fields-layout":B,"data-fields":l(ve),schemas:l(F),"error-messages":P.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):U("",!0),i.value?(_(),D(l(Te),{key:1,name:"Invoice Lines",headers:A,data:u.value,"table-actions":oe,actions:ie,loading:d.value,pagination:{offset:0,limit:u.value.length,client:!0}},{["data-col.description"]:c(({row:t,i:n})=>[f("div",Me,[v(l(h),{modelValue:t.description,"onUpdate:modelValue":s=>t.description=s,type:"text",label:"",size:"lg","error-message":p(n,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unitCost"]:c(({row:t,i:n})=>[f("div",Be,[v(l(h),{modelValue:t.unitCost,"onUpdate:modelValue":s=>t.unitCost=s,type:"number",label:"",size:"sm","error-message":p(n,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unit"]:c(({row:t,i:n})=>[f("div",He,[v(l(Se),{modelValue:t.unit,"onUpdate:modelValue":s=>t.unit=s,type:"text",label:"",size:"md",options:l(se),"error-message":p(n,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),["data-col.unitValue"]:c(({row:t,i:n})=>[f("div",qe,[v(l(h),{modelValue:t.unitValue,"onUpdate:modelValue":s=>t.unitValue=s,type:"number",label:"",size:"sm","error-message":p(n,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.subtotal"]:c(({row:t,i:n})=>[f("div",ze,[v(l(h),{modelValue:t.subtotal,"onUpdate:modelValue":s=>t.subtotal=s,type:"number",label:"",size:"sm","error-message":p(n,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:c(({total:t})=>[Fe(" Total Lines: "+we(t),1)]),_:2},1032,["data","loading","pagination"])):U("",!0)]),"step-2":c(()=>[b.value?(_(),D(Ne,{key:0,id:b.value.id,"template-type":"invoice_templates","content-markup":b.value.contentMarkup,"content-styles":b.value.contentStyles,data:l(me),disabled:!0},null,8,["id","content-markup","content-styles","data"])):U("",!0)]),_:1},8,["steps","current-step-number"])]))}},Ze=Ie(Pe,[["__scopeId","data-v-6e8529a6"]]);export{Ze as default};
