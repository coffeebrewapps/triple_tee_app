import{u as Ge,a as Qe}from"./input-7f33c7c3.js";import{r,c,b as i,d as v,j as R,v as z,g as o,z as Oe,P as Ae,X as We,F as G,_ as Ye,l as _e,o as et,f as J,i as x,x as se,t as L,e as m,Q as tt,M as Se,B as at,a as Yt,u as _t,n as ea,w as Ce,C as Je,y as ze,G as He,H as Xe,I as Ze,R as ta,Z as aa,p as la,h as na}from"./index-4d73f140.js";import{u as sa}from"./errors-a6177d44.js";import{D as lt}from"./DataForm-7927308b.js";const qe={__name:"FormDialog",props:{modelValue:{type:Boolean,default:!1},fieldsLayout:{type:Array,default(){return[]}},dataFields:{type:Array,default(){return[]}},data:{type:Object,default(){return{}}},schemas:{type:Object,default(){return{}}},dialogTitle:{type:String,default:""},fullscreen:{type:Boolean,default:!1},errorMessages:{type:Object,default(){return{}}}},emits:["update:modelValue","submit"],setup(l,{emit:n}){const k=l,B=r(!1),T=r(""),D=c({get:()=>k.modelValue,set:j=>{n("update:modelValue",j)}}),E=c(()=>k.data);function Q(j){n("submit",j)}function H(){D.value=!1,n("update:modelValue",!1)}return(j,O)=>(i(),v(G,null,[R(o(Ae),{modelValue:o(D),"onUpdate:modelValue":O[1]||(O[1]=p=>Oe(D)?D.value=p:null),title:l.dialogTitle,fullscreen:l.fullscreen,class:"form-dialog"},{body:z(()=>[R(lt,{modelValue:o(E),"onUpdate:modelValue":O[0]||(O[0]=p=>Oe(E)?E.value=p:null),"fields-layout":l.fieldsLayout,"data-fields":l.dataFields,schemas:l.schemas,"error-messages":l.errorMessages,onSubmit:Q,onCancel:H},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),_:1},8,["modelValue","title","fullscreen"]),R(o(We),{modelValue:B.value,"onUpdate:modelValue":O[2]||(O[2]=p=>B.value=p),title:"Error",content:T.value,width:400,height:250},null,8,["modelValue","content"])],64))}};const oa={class:"data-row"},ra={class:"data-label"},ua={key:0,class:"data-value"},ia={key:0},ca={key:1,class:"no-value"},da={key:1,class:"data-value tags"},fa={key:0,class:"no-value"},va={__name:"ViewDialog",props:{modelValue:{type:Boolean,default:!1},keys:{type:Array,default(){return[]}},record:{type:Object,default(){return{}}},dataFields:{type:Array,default(){return[]}},title:{type:String,default:"View"},inputLabel:{type:Function,default(l){return l}},inputValue:{type:Function,default(l,n){return n[l]}},includeKeys:{type:Array,default(){return[]}}},emits:["update:modelValue"],setup(l,{emit:n}){const k=l,{tagsFields:B,tagsField:T}=Ge(k.dataFields),{formatTag:D,tagStyle:E}=at(),H=_e().getSystemConfigs(),{isEmpty:j,notEmpty:O}=Qe(),p=c({get:()=>k.modelValue,set:w=>{n("update:modelValue",w)}});function ge(){n("update:modelValue",!1)}const N=r();async function pe(w,y,f){const W=y.map(K=>new Promise(($,F)=>{D(w,K,f,H.tagFormat).then(h=>{$(h)}).catch(h=>{F(h)})}));return new Promise((K,$)=>{Promise.all(W).then(F=>{K({key:f,formattedValue:F})}).catch(F=>{$(F)})})}function S(w,y,f){return N.value[y]?N.value[y][f]:w[y][f]}return et(async()=>{const w=B.value.map(y=>{const f=k.record[y];return pe(k.record,f,y)});Promise.all(w).then(y=>{N.value=Object.assign({},k.record),y.forEach(f=>{N.value[f.key]=f.formattedValue})}).catch(y=>{console.error(y)})}),(w,y)=>N.value?(i(),J(o(Ae),{key:0,modelValue:o(p),"onUpdate:modelValue":y[1]||(y[1]=f=>Oe(p)?p.value=f:null),title:l.title},{body:z(()=>[x("div",oa,[(i(!0),v(G,null,se(l.keys,(f,W)=>(i(),v("div",{key:W,class:"data-col"},[x("div",ra,L(l.inputLabel(f)),1),o(T)(f)?m("",!0):(i(),v("div",ua,[o(O)(l.record[f])?(i(),v("div",ia,L(l.inputValue(f,l.record,l.includeKeys,l.dataFields)),1)):m("",!0),o(j)(l.record[f])?(i(),v("div",ca," --- no value --- ")):m("",!0)])),o(T)(f)?(i(),v("div",da,[(i(!0),v(G,null,se(l.record[f],(K,$)=>(i(),v("div",{key:$,class:"tag",style:tt(o(E)(l.record,K,f))},L(S(l.record,f,$)),5))),128)),l.record[f].length===0?(i(),v("div",fa," --- no value --- ")):m("",!0)])):m("",!0)]))),128))])]),actions:z(()=>[R(o(Se),{"button-type":"text",value:"Close",icon:"fa-solid fa-xmark",onClick:y[0]||(y[0]=f=>ge())})]),_:1},8,["modelValue","title"])):m("",!0)}},ya=Ye(va,[["__scopeId","data-v-efb5ed80"]]);const me=l=>(la("data-v-d1421209"),l=l(),na(),l),ma={class:"page-container"},ga={class:"heading"},pa=me(()=>x("h3",{class:"heading"}," Filters ",-1)),ha=["onClick"],ba=me(()=>x("i",{class:"fa-solid fa-sort"},null,-1)),ka=me(()=>x("i",{class:"fa-solid fa-sort-up"},null,-1)),Da=me(()=>x("i",{class:"fa-solid fa-sort-down"},null,-1)),wa={key:0,class:"col"},Fa={key:0},Va={key:0},Ca={key:1,class:"no-value"},Oa={key:1},Sa={key:0,class:"no-value"},Aa=["download","href"],xa={__name:"DataPage",props:{dataType:{type:String,default:""},modelClass:{type:String,default:null},filters:{type:Object,default(){return{}}},dataFields:{type:Array,default(){return[]}},fieldsLayout:{type:Array,default(){return[]}},validations:{type:Object,default(){return{}}},fullscreen:{type:Boolean,default:!1},createDialogTitle:{type:Function,default:function(l){return`Create ${l}`}},viewDialogTitle:{type:Function,default:function(l,n){return`View ${l} ${n.id}`}},updateDialogTitle:{type:Function,default:function(l,n){return n?`Update ${l} ${n.id}`:""}},deleteDialogTitle:{type:Function,default:function(l,n){return n?`Delete ${l} ${n.id}`:""}},deleteDialogPrimaryText:{type:Function,default:function(l,n){return n?`Are you sure you want to delete ${l} ${n.id}?`:""}},deleteDialogSecondaryText:{type:Function,default:function(l,n){return n?JSON.stringify(n,!1,2):""}},actions:{type:Object,default(){return{}}}},setup(l){const n=l,{inputLabel:k,inputValue:B,tagsField:T,formatDataForShow:D,formatDataForSave:E,formatErrorsForDisplay:Q,formatFilters:H,initOptionsData:j}=Ge(n.dataFields),p=_e().getSystemConfigs(),{formatTag:ge,tagStyle:N}=at(),pe=sa(),S=Yt(),{isEmpty:w,notEmpty:y}=Qe(),f=_t(),W=ea(),K=r({}),$=c(()=>n.dataFields.filter(e=>e.reference)),F=c(()=>$.value.map(e=>e.key)),h=r(Array.from(n.dataFields)),xe=r(!1),he=r(!1);function Te(e,t){return Object.keys(e).reduce((a,s)=>{const u=e[s].map(g=>g(t)).filter(g=>!!g);return u.length>0&&(a[s]=u),a},{})}function nt(e){h.value=h.value.map(t=>{if(t.type==="enum"){const a=e[t.key].enums,s=Object.keys(a).map(u=>({value:u,label:a[u]}));return Object.assign({},t,{options:s})}else return t})}const st=r(n.filters.layout),be=r(!1),X=r({}),Ee=r(Array.from(n.dataFields)),ot=r({}),rt=c(()=>({type:"icon",icon:"fa-solid fa-check"})),ut=c(()=>({type:"icon",icon:"fa-solid fa-filter-circle-xmark"})),it=c(()=>n.dataFields.filter(e=>e.filterable).reduce((e,t)=>(e[t.key]=t,e),{})),ke=c(()=>Object.keys(it.value)),je=c(()=>st.value&&xe.value&&he.value),ct=c(()=>n.filters.layout),dt=c(()=>be.value?"filters expanded":"filters collapsed");async function ft(e){Z.value=0,await q()}async function Y(){he.value=!1,X.value=H(Object.assign({},n.filters.initData));const e=ke.value.map(t=>D(t,X.value));Promise.all(e).then(t=>{ke.value.forEach((a,s)=>{X.value[a]=t[s]}),he.value=!0,Z.value=0,q()})}function vt(){be.value=!be.value}function yt(){Ee.value=Array.from(h.value).map(e=>{const t=Object.assign({},e);return t.filterable&&(t.type==="date"?t.type="daterange":t.type==="datetime"?t.type="datetimerange":t.type==="number"&&(t.type="numberrange")),t}).filter(e=>e.filterable)}const oe=r("id"),_=r(!0),mt=c(()=>({field:oe.value,order:_.value?"asc":"desc"})),gt=c(()=>n.dataFields.filter(e=>e.sortable).reduce((e,t)=>(e[t.key]=t,e),{})),pt=c(()=>Object.keys(gt.value));function De(e){return pt.value.includes(e)}const ht=c(()=>n.dataFields.reduce((e,t)=>{const a=t.key;return De(a)&&a===oe.value?_.value?e[a]="header-field sort down":e[a]="header-field sort up":De(a)?e[a]="header-field sort reset":e[a]="header-field nosort",e},{}));async function bt(e){De(e)&&(e===oe.value?_.value=!_.value:(oe.value=e,_.value=!0),Z.value=0,await q())}const kt=c(()=>{const e={name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(ye){await Ut()}},t=n.actions.create||{},a=Object.assign({},e,t),s={name:"Export",icon:"fa-solid fa-file-export",click:async function(ye){await Qt()}},d=n.actions.export||{},u=Object.assign({},s,d),g={name:"Filter",icon:"fa-solid fa-filter",click:async function(){vt()}},b=n.actions.filter||{},C=Object.assign({},g,b),P=[a,u];return je.value&&P.unshift(C),P}),Dt=c(()=>{const e={name:"View",icon:"fa-solid fa-magnifying-glass",click:async function(P,ye){await Et(P.id)}},t=n.actions.view||{},a=Object.assign({},e,t),s={name:"Update",icon:"fa-solid fa-pen-to-square",click:async function(P,ye){await Mt(P.id)}},d=n.actions.update||{},u=Object.assign({},s,d),g={name:"Delete",icon:"fa-solid fa-trash-can",click:async function(P,ye){await qt(P.id)}},b=n.actions.remove||{},C=Object.assign({},g,b);return[a,u,C]}),$e=r([]),Ue=r(0),Z=r(0),Pe=r(5),re=r(!1),Le=c(()=>n.dataFields.filter(e=>e.listable)),ue=r([]);async function wt(e){Z.value=e,await q()}async function Ft(e,t,a,s){const d=t.map(u=>new Promise((g,b)=>{ge(e,u,a,p.tagFormat).then(C=>{g(C)}).catch(C=>{b(C)})}));return new Promise((u,g)=>{Promise.all(d).then(b=>{u({i:s,key:a,formattedValue:b})}).catch(b=>{g(b)})})}function Vt(e,t,a){const s=`${t}Formatted`;return e[s]?e[s][a]:e[t]}async function Ct(){const e=[];ue.value=[],$e.value.forEach((t,a)=>{ue.value.push(Object.assign({},t)),Le.value.forEach(s=>{const d=s.key,u=t[d];T(d)&&e.push(Ft(t,u,d,a))})}),Promise.all(e).then(t=>{t.forEach(a=>{const s=`${a.key}Formatted`;ue.value[a.i][s]=a.formattedValue})}).catch(t=>{console.error(t)})}W.registerListener("loadData",{id:`DataPage-${n.dataType}`,invoke:e=>{e.dataType===n.dataType&&q()}});async function Ot(){await S.schemas(n.modelClass).then(e=>{const t=e.fields;nt(t),yt(),xe.value=!0}).catch(e=>{console.error(e),A("Error loading schemas!")})}async function q(){const e={include:F.value,offset:Z.value,limit:Pe.value,filters:H(X.value),sort:mt.value};re.value=!0,await S.list(n.modelClass,e).then(t=>{$e.value=t.data,Ct(),Ue.value=t.total,re.value=!1}).catch(t=>{re.value=!1,console.error(t),A("Error loading data!")})}async function we(e,t,a){const s={include:F.value};await S.view(n.modelClass,e,s).then(d=>{t(d)}).catch(d=>{a(d)})}function A(e){f.show(e),setTimeout(St,5e3)}function St(){f.hide()}const U=r(!1),V=r(""),At=c(()=>V.value&&V.value.length>0?(V.value.match(/.{1,100}/g)??[]).join(`
`):""),Re=c(()=>({width:800,height:400})),Fe=r(!1),ee=r(),xt=c(()=>n.dataFields.filter(e=>e.viewable).reduce((e,t)=>(e[t.key]=t,e),{})),Tt=c(()=>Object.keys(xt.value));async function Et(e){we(e,t=>{ee.value=t,Fe.value=!0},t=>{ee.value=null,U.value=!0,V.value=JSON.stringify(t,!1,4)})}const te=r(!1),ae=r(),ie=r({}),jt=c(()=>n.dataFields.filter(e=>e.creatable).reduce((e,t)=>(e[t.key]=t,e),{})),Ve=c(()=>Object.keys(jt.value)),$t=c(()=>n.validations.create||[]);Ce(te,(e,t)=>{e||(ie.value={})});async function Ut(e){ae.value={};const t=Ve.value.map(a=>D(a,{}));Promise.all(t).then(a=>{Ve.value.forEach((s,d)=>{ae.value[s]=a[d],te.value=!0})})}async function Pt(e){const t=Lt(e);if(Object.keys(t).length>0){ie.value=t,A("Error creating data!");return}const a=E(e);await S.create(n.modelClass,a).then(s=>{A("Data created successfully!"),Y(),Rt()}).catch(s=>{ie.value=Q(s),A("Error creating data!")})}function Lt(e){return Te($t.value,e)}function Rt(){te.value=!1,Bt()}function Bt(){ae.value=null}const le=r(!1),I=r(),ce=r({}),Nt=c(()=>n.dataFields.filter(e=>e.updatable).reduce((e,t)=>(e[t.key]=t,e),{})),Kt=c(()=>Object.keys(Nt.value)),It=c(()=>n.validations.update||[]);Ce(le,(e,t)=>{e||(ce.value={})});async function Mt(e){we(e,t=>{Xt(t),le.value=!0},t=>{Be(),U.value=!0,V.value=JSON.stringify(t,!1,4)})}async function Jt(e){const t=zt(e);if(Object.keys(t).length>0){ce.value=t,A("Error updating data!");return}const a=e.id,s=E(e);await S.update(n.modelClass,a,s).then(d=>{A("Data updated successfully!"),Y(),Ht()}).catch(d=>{ce.value=Q(d),A("Error updating data!")})}function zt(e){return Te(It.value,e)}function Ht(){le.value=!1,Be()}async function Xt(e){I.value={};const t=n.dataFields.map(a=>{const s=a.key;return D(s,e)});Promise.all(t).then(a=>{n.dataFields.forEach((s,d)=>{const u=s.key;I.value[u]=a[d]})})}function Be(){I.value=null}const ne=r(!1),M=r(),Zt=r({});Ce(ne,(e,t)=>{e||(Zt.value={})});async function qt(e){we(e,t=>{M.value=t,ne.value=!0},t=>{Ke(),U.value=!0,V.value=JSON.stringify(t,!1,4)})}async function Gt(){const t=M.value.id;await S.remove(n.modelClass,t).then(a=>{A("Data deleted successfully!"),Y()}).catch(a=>{U.value=!0,V.value=a.map(s=>pe[s]()).join(", ")}).finally(()=>{Ne()})}function Ne(){ne.value=!1,Ke()}function Ke(){M.value=null}const de=r(!1),fe=r(),ve=r(),Ie=r("downloadAnchor");async function Qt(){await S.download(n.modelClass).then(e=>{const t=window.URL.createObjectURL(new Blob([e.data]));fe.value=t,ve.value=e.filename,de.value=!0}).catch(e=>{U.value=!0,V.value=JSON.stringify(e,!1,4)})}function Wt(){Ie.value.click(),Me()}function Me(){de.value=!1,fe.value=null,ve.value=null}return et(async()=>{await Ot(),await q(),await j().then(e=>{K.value=e}).catch(e=>{U.value=!0,V.value=JSON.stringify(e,!1,4)}),await Y()}),(e,t)=>(i(),v("div",ma,[x("h2",ga,L(l.dataType),1),o(je)?(i(),v("div",{key:0,class:Je(o(dt))},[pa,R(lt,{modelValue:X.value,"onUpdate:modelValue":t[0]||(t[0]=a=>X.value=a),"fields-layout":o(ct),"data-fields":o(ke),schemas:Ee.value,"error-messages":ot.value,"confirm-button":o(rt),"cancel-button":o(ut),compact:!0,onSubmit:ft,onCancel:Y},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages","confirm-button","cancel-button"])],2)):m("",!0),R(o(ta),{name:"",headers:o(Le),data:ue.value,"table-actions":o(kt),actions:o(Dt),loading:re.value,pagination:{offset:Z.value,limit:Pe.value,client:!1},"total-data":Ue.value,onOffsetChange:wt},{"header-row":z(({headers:a,actions:s})=>[(i(!0),v(G,null,se(a,(d,u)=>(i(),v("th",{key:u,class:"col",onClick:g=>bt(d.key)},[x("div",{class:Je(o(ht)[d.key])},[ze(L(d.label)+" ",1),ba,ka,Da],2)],8,ha))),128)),s.length>0?(i(),v("th",wa)):m("",!0)]),"data-content":z(({headers:a,row:s,i:d})=>[(i(!0),v(G,null,se(a,(u,g)=>(i(),v("td",{key:g,class:"col"},[He(e.$slots,`data-col.${u.key}`,Xe(Ze({header:u,row:s,i:d})),()=>[o(T)(u.key)?m("",!0):(i(),v("div",Fa,[o(y)(s[u.key])?(i(),v("div",Va,L(o(B)(u.key,s,o(F),h.value)),1)):m("",!0),o(w)(s[u.key])?(i(),v("div",Ca," --- no value --- ")):m("",!0)])),o(T)(u.key)?(i(),v("div",Oa,[(i(!0),v(G,null,se(s[u.key],(b,C)=>(i(),v("div",{key:C,class:"tag",style:tt(o(N)(s,b,u.key))},L(Vt(s,u.key,C)),5))),128)),s[u.key].length===0?(i(),v("div",Sa," --- no value --- ")):m("",!0)])):m("",!0)],!0)]))),128))]),_:3},8,["headers","data","table-actions","actions","loading","pagination","total-data"]),V.value.length>0?(i(),J(o(We),{key:1,modelValue:U.value,"onUpdate:modelValue":t[1]||(t[1]=a=>U.value=a),title:"Error",class:"error-alert",content:o(At),width:o(Re).width,height:o(Re).height},null,8,["modelValue","content","width","height"])):m("",!0),ae.value?(i(),J(qe,{key:2,modelValue:te.value,"onUpdate:modelValue":t[2]||(t[2]=a=>te.value=a),schemas:h.value,"fields-layout":l.fieldsLayout,"data-fields":o(Ve),data:ae.value,"dialog-title":l.createDialogTitle(l.dataType),fullscreen:l.fullscreen,"error-messages":ie.value,onSubmit:Pt},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):m("",!0),He(e.$slots,"updateDialog",Xe(Ze({row:I.value})),()=>[I.value?(i(),J(qe,{key:0,modelValue:le.value,"onUpdate:modelValue":t[3]||(t[3]=a=>le.value=a),schemas:h.value,"fields-layout":l.fieldsLayout,"data-fields":o(Kt),data:I.value,"dialog-title":l.updateDialogTitle(l.dataType,I.value),fullscreen:l.fullscreen,"error-messages":ce.value,onSubmit:Jt},null,8,["modelValue","schemas","fields-layout","data-fields","data","dialog-title","fullscreen","error-messages"])):m("",!0)],!0),ee.value?(i(),J(ya,{key:3,modelValue:Fe.value,"onUpdate:modelValue":t[4]||(t[4]=a=>Fe.value=a),keys:o(Tt),"include-keys":o(F),"data-fields":h.value,record:ee.value,title:l.viewDialogTitle(l.dataType,ee.value),"input-label":o(k),"input-value":o(B),class:"view-dialog"},null,8,["modelValue","keys","include-keys","data-fields","record","title","input-label","input-value"])):m("",!0),M.value?(i(),J(o(aa),{key:4,modelValue:ne.value,"onUpdate:modelValue":t[5]||(t[5]=a=>ne.value=a),title:l.deleteDialogTitle(l.dataType,M.value),"primary-text":l.deleteDialogPrimaryText(l.dataType,M.value),"secondary-text":l.deleteDialogSecondaryText(l.dataType,M.value),width:500,height:350,class:"delete-dialog",onConfirm:Gt,onCancel:Ne},null,8,["modelValue","title","primary-text","secondary-text"])):m("",!0),fe.value?(i(),J(o(Ae),{key:5,modelValue:de.value,"onUpdate:modelValue":t[8]||(t[8]=a=>de.value=a),title:"Download export file",width:400,height:250},{body:z(()=>[ze(L(ve.value),1)]),actions:z(()=>[x("a",{ref_key:"downloadAnchor",ref:Ie,class:"hidden",rel:"noreferrer",download:ve.value,href:fe.value},null,8,Aa),R(o(Se),{"button-type":"text",value:"Download",icon:"fa-solid fa-file-arrow-down",onClick:t[6]||(t[6]=a=>Wt())}),R(o(Se),{"button-type":"text",value:"Cancel",icon:"fa-solid fa-xmark",onClick:t[7]||(t[7]=a=>Me())})]),_:1},8,["modelValue"])):m("",!0)]))}},Ua=Ye(xa,[["__scopeId","data-v-d1421209"]]);export{Ua as D,qe as _};
