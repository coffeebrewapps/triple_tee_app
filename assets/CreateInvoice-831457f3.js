import{_ as Le,m as Te,a as ke,u as Se,c as u,r as o,o as we,b as C,d as Fe,j as v,v as c,g as l,f as D,e as U,R as De,i as f,A as I,s as Ue,y as xe,t as Ee,p as Ne,h as je}from"./index-456a89cc.js";import{a as Oe,u as x}from"./input-701303c2.js";import{u as Ae}from"./utils-a8a1fa8d.js";import{W as Be}from"./WorkflowContainer-9ef6ad6a.js";import{D as J}from"./DataForm-c9afdb67.js";import{T as Me}from"./TemplateEditor-4ab264f1.js";import"./errors-a6177d44.js";import"./TabContainer-65d2b41a.js";const He=V=>(Ne("data-v-6c74f055"),V=V(),je(),V),Re={class:"page-container"},qe=He(()=>f("h3",{class:"heading"}," Create Invoice ",-1)),ze={class:"data-col"},Pe={class:"data-col"},Ke={class:"data-col"},We={class:"data-col"},Ge={class:"data-col"},Je={__name:"CreateInvoice",setup(V){const Q=Te(),{isEmpty:X,notEmpty:h}=Oe(),E=ke(),N=Se(),Y=Object.assign({},Q.currentRoute.value),L=u(()=>Y.query.contactId),{generateDataFields:Z,recordValue:T,tagLabel:j,contactLabel:O,invoiceConfigLabel:A}=Ae(),g=o({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}});h(L.value)&&(g.value.invoiceConfigId=[{value:L.value}]);const k=u(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:O},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:T,label:O}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:A},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:T,label:A}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:j},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:T,label:j}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),$=x(k.value),ee=u(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),te=u(()=>k.value.map(e=>e.key)),ae=o({});function S(){i.value=null,r.value=[],b.value=null,P.value={}}async function ne(e){const a=R.value.map(t=>q.formatDataForShow(t,e));Promise.all(a).then(t=>{i.value={},R.value.forEach((n,s)=>{i.value[n]=t[s]}),i.value.totalAmount=z.value}).catch(t=>{y("Error generating invoice!"),console.error(t)})}async function le(e){await ne(Object.assign({},e.invoice)),r.value=e.invoiceLines.map(a=>me(a)),K.value=Object.assign({},e.invoiceConfig),F.value=Object.assign({},e.invoiceNumberSequence),W.value=Object.assign({},e.billingContact),G.value=Object.assign({},e.currency),b.value=Object.assign({},e.invoiceTemplate)}async function oe(){S(),d.value=!0;const e=$.formatFilters(g.value);E.create("invoices",e,{path:"preview_invoice"}).then(a=>{le(a),d.value=!1,_.value=1}).catch(a=>{console.error(a),y("Error previewing invoice!")})}function ie(){S(),g.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}const B=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],se=x(B),r=o([]),ue=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await de()}}],re=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,a){await M(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,a){await ve(a)}}],d=o(!1),ce=u(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function de(){d.value=!0,r.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),d.value=!1}function ve(e){d.value=!0,r.value.splice(e,1),d.value=!1}function me(e){const a={};return a.description=e.description,a.unit=e.unit,a.unitCost=m(e.unitCost),a.unitValue=m(e.unitValue),X(e.subtotal)?M(a):a.subtotal=m(e.subtotal),a}function m(e){return(e||0).toFixed(2)}function M(e){const a=e.unitCost,t=e.unitValue;h(a)&&h(t)?e.subtotal=m(parseFloat(a)*parseFloat(t)):e.subtotal=m(0),i.value.totalAmount=z.value}const pe=o([]);function p(e,a){return pe[e]?p[e][a]:""}const i=o(),H=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],be=u(()=>H.reduce((e,a)=>(Object.keys(a).forEach(t=>{e.push(t)}),e),[])),w=u(()=>Z(L.value)),R=u(()=>w.value.map(e=>e.key)),q=x(w.value),z=u(()=>{const e=r.value.reduce((a,t)=>h(t.subtotal)?a+parseFloat(t.subtotal):a,0);return m(e)}),P=o({}),b=o(),K=o(),F=o(),W=o(),G=o(),fe=u(()=>({invoice:i.value,invoiceLines:r.value,invoiceConfig:K.value,invoiceNumberSequence:F.value,billingContact:W.value,currency:G.value}));async function ge(){return new Promise((e,a)=>{const t=r.value.map(n=>se.formatDataForSave(n));Promise.all(t).then(n=>{e(n)}).catch(n=>{a(n)})})}async function ye(){await ge().then(e=>{const a=Object.assign({},{invoice:q.formatDataForSave(i.value),invoiceNumberSequence:F.value,invoiceLines:e});E.create("invoices",a,{path:"generate_with_lines"}).then(t=>{i.value.id=t.id,r.value=t.invoiceLines,_.value=2,y("Invoice created successfully!")}).catch(t=>{y("Error creating invoice!"),console.error(t)})}).catch(e=>{y("Error formatting invoice for save!"),console.error(e)})}function y(e){N.show(e),setTimeout(Ve,5e3)}function Ve(){N.hide()}const _=o(0),he=u(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function _e(e){e===0&&(S(),_.value=e)}async function Ce(e){e===1&&await oe()}async function Ie(){await ye()}return we(()=>{ie()}),(e,a)=>(C(),Fe("div",Re,[qe,v(Be,{steps:l(he),"current-step-number":_.value,onPrevStep:_e,onNextStep:Ce,onSubmit:Ie},{"step-0":c(()=>[v(J,{modelValue:g.value,"onUpdate:modelValue":a[0]||(a[0]=t=>g.value=t),"fields-layout":l(ee),"data-fields":l(te),schemas:l(k),"error-messages":ae.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":c(()=>[i.value?(C(),D(J,{key:0,modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=t=>i.value=t),"fields-layout":H,"data-fields":l(be),schemas:l(w),"error-messages":P.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):U("",!0),i.value?(C(),D(l(De),{key:1,name:"Invoice Lines",headers:B,data:r.value,"table-actions":ue,actions:re,loading:d.value,pagination:{offset:0,limit:r.value.length,client:!0}},{["data-col.description"]:c(({row:t,i:n})=>[f("div",ze,[v(l(I),{modelValue:t.description,"onUpdate:modelValue":s=>t.description=s,type:"text",label:"",size:"lg","error-message":p(n,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unitCost"]:c(({row:t,i:n})=>[f("div",Pe,[v(l(I),{modelValue:t.unitCost,"onUpdate:modelValue":s=>t.unitCost=s,type:"number",label:"",size:"sm","error-message":p(n,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.unit"]:c(({row:t,i:n})=>[f("div",Ke,[v(l(Ue),{modelValue:t.unit,"onUpdate:modelValue":s=>t.unit=s,type:"text",label:"",size:"md",options:l(ce),"error-message":p(n,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),["data-col.unitValue"]:c(({row:t,i:n})=>[f("div",We,[v(l(I),{modelValue:t.unitValue,"onUpdate:modelValue":s=>t.unitValue=s,type:"number",label:"",size:"sm","error-message":p(n,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),["data-col.subtotal"]:c(({row:t,i:n})=>[f("div",Ge,[v(l(I),{modelValue:t.subtotal,"onUpdate:modelValue":s=>t.subtotal=s,type:"number",label:"",size:"sm","error-message":p(n,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:c(({total:t})=>[xe(" Total Lines: "+Ee(t),1)]),_:2},1032,["data","loading","pagination"])):U("",!0)]),"step-2":c(()=>[b.value?(C(),D(Me,{key:0,id:b.value.id,"template-type":"invoice_templates","content-markup":b.value.contentMarkup,"content-styles":b.value.contentStyles,data:l(fe),disabled:!0},null,8,["id","content-markup","content-styles","data"])):U("",!0)]),_:1},8,["steps","current-step-number"])]))}},nt=Le(Je,[["__scopeId","data-v-6c74f055"]]);export{nt as default};
