import{_ as le,r as i,c as o,a as r,b as S,h as g,F as te,m as ae,z as De,t as se,d as k,R as Ue,T as Ee,A as Ne,B as $e,D as je,f as s,e as x,S as M,j as Ae,u as Oe,o as Pe,i as V,l as b,C as ze,W as A,J as Be,n as Me,p as qe,g as He}from"./index-cf9ea608.js";import{a as Re,u as q,F as ne}from"./Form-6ecdf185.js";import{a as We}from"./dataAccess-238ee380.js";import{u as Ke}from"./utils-47eab738.js";import{T as Je}from"./TemplateEditor-6719ac54.js";import"./errors-a6177d44.js";import"./TabContainer-bd4cd668.js";const Ge={class:"workflow-container"},Qe={class:"step-breadcrumbs"},Xe={class:"title"},Ye={key:0,class:"fa-solid fa-caret-right"},Ze={class:"step-container"},et={class:"actions"},tt={__name:"WorkflowContainer",props:{steps:{type:Array,default(){return[]}}},emits:["prevStep","nextStep","submit"],setup(p,{emit:F}){const y=p,n=i(0);o(()=>y.steps[n.value]);const N=o(()=>n.value<y.steps.length-1&&n.value>0),$=o(()=>n.value<y.steps.length-1),O=o(()=>{if(y.steps.length===1)return!0;n.value,y.steps.length-2});function D(){n.value>0&&(n.value=n.value-1,F("prevStep",n.value))}function P(){n.value<y.steps.length-1&&(n.value=n.value+1,F("nextStep",n.value))}function U(){F("submit")}function j(I){return n.value===I?"step-breadcrumb active":"step-breadcrumb"}return(I,_)=>(r(),S("div",Ge,[g("div",Qe,[(r(!0),S(te,null,ae(p.steps,(m,u)=>(r(),S("div",{class:De(j(u))},[g("div",Xe,se(m.title),1),u!==p.steps.length-1?(r(),S("i",Ye)):k("",!0)],2))),256))]),(r(!0),S(te,null,ae(p.steps,(m,u)=>Ue((r(),S("div",Ze,[Ne(I.$slots,`step-${u}`,$e(je({step:m,i:u})),void 0,!0)],512)),[[Ee,n.value===u]])),256)),g("div",et,[s(N)?(r(),x(s(M),{key:0,value:"Prev Step",icon:"fa-solid fa-arrow-left",onClick:_[0]||(_[0]=m=>D())})):k("",!0),s($)?(r(),x(s(M),{key:1,value:"Next Step",icon:"fa-solid fa-arrow-right",onClick:_[1]||(_[1]=m=>P())})):k("",!0),s(O)?(r(),x(s(M),{key:2,value:"Submit",icon:"fa-solid fa-check",onClick:_[2]||(_[2]=m=>U())})):k("",!0)])]))}},at=le(tt,[["__scopeId","data-v-fc5b0051"]]);const nt=p=>(qe("data-v-184a3028"),p=p(),He(),p),lt={class:"page-container"},st=nt(()=>g("h3",{class:"heading"},"Create Invoice",-1)),ot={class:"data-col"},it={class:"data-col"},rt={class:"data-col"},ut={class:"data-col"},ct={class:"data-col"},dt={__name:"CreateInvoice",setup(p){const F=Ae(),{isEmpty:y,notEmpty:n}=Re(),N=We(),$=Oe(),O=Object.assign({},F.currentRoute.value),D=o(()=>O.query.contactId),{generateDataFields:P,recordValue:U,tagLabel:j,contactLabel:I,currencyLabel:_,invoiceConfigLabel:m}=Ke(),u=i({tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}});n(D.value)&&(u.value.invoiceConfigId=[{value:D.value}]);const z=o(()=>[{key:"contactId",type:"singleSelect",label:"Contact",reference:{label:I},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"contacts",value:U,label:I}},{key:"invoiceConfigId",type:"singleSelect",label:"Invoice Config",reference:{label:m},listable:!1,viewable:!0,creatable:!0,updatable:!0,options:{server:!0,pagination:!0,modelClass:"invoice_configs",value:U,label:m}},{key:"tags",type:"multiSelect",label:"Tags",reference:{label:j},listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,options:{server:!0,pagination:!0,modelClass:"tags",value:U,label:j}},{key:"startTime",type:"datetimerange",label:"Start Time",defaultValue:()=>new Date,listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0},{key:"endTime",type:"datetimerange",label:"End Time",listable:!0,viewable:!0,creatable:!0,updatable:!0,filterable:!0,sortable:!0}]),oe=q(z.value),ie=o(()=>[{contactId:"lg",invoiceConfigId:"lg"},{tags:"lg"},{startTime:"md"},{endTime:"md"}]),re=o(()=>z.value.map(e=>e.key)),ue=i({});o(()=>({type:"text",value:"Filter",icon:"fa-solid fa-check"})),o(()=>({type:"text",value:"Cancel",icon:"fa-solid fa-xmark"}));function H(){c.value=null,v.value=[],T.value=null}async function ce(e){const t=J.value.map(a=>G.formatDataForShow(a,e));Promise.all(t).then(a=>{c.value={},J.value.forEach((l,d)=>{c.value[l]=a[d]}),c.value.totalAmount=Q.value}).catch(a=>{E("Error generating invoice!"),console.error(a)})}async function de(e){await ce(Object.assign({},e.invoice)),v.value=e.invoiceLines.map(t=>_e(t)),X.value=Object.assign({},e.invoiceConfig),h.value=Object.assign({},e.invoiceNumberSequence),Y.value=Object.assign({},e.billingContact),Z.value=Object.assign({},e.currency),T.value=Object.assign({},e.invoiceTemplate)}async function ve(){H(),C.value=!0;const e=oe.formatFilters(u.value);N.create("invoices",e,{path:"preview_invoice"}).then(t=>{de(t),C.value=!1}).catch(t=>{console.error(t),E("Error previewing invoice!")})}function pe(){H(),u.value={tags:[],invoiceConfigId:[],startTime:{startTime:null,endTime:null},endTime:{startTime:null,endTime:null}}}const R=[{key:"description",type:"text",label:"Description",listable:!0,creatable:!0,updatable:!0},{key:"unitValue",type:"number",label:"Unit Value",listable:!0,creatable:!0,updatable:!0},{key:"unitCost",type:"number",label:"Unit Cost",listable:!0,creatable:!0,updatable:!0},{key:"unit",type:"enum",label:"Unit",listable:!0,creatable:!0,updatable:!0},{key:"subtotal",type:"number",label:"Subtotal",listable:!0,creatable:!0,updatable:!0}],me=q(R),v=i([]),fe=[{name:"Create",icon:"fa-solid fa-circle-plus fa-xl",click:async function(e){await ye()}}],be=[{name:"Calculate",icon:"fa-solid fa-calculator",click:async function(e,t){await W(e)}},{name:"Delete",icon:"fa-solid fa-trash-can",click:async function(e,t){await he(t)}}],C=i(!1),ge=o(()=>[{value:"hour",label:"Hour"},{value:"minute",label:"Minute"},{value:"count",label:"Count"},{value:"fixed",label:"Fixed"}]);function ye(){C.value=!0,v.value.push({description:null,unitCost:null,unit:null,unitValue:null,subtotal:null}),C.value=!1}function he(e){C.value=!0,v.value.splice(e,1),C.value=!1}function _e(e){const t={};return t.description=e.description,t.unit=e.unit,t.unitCost=w(e.unitCost),t.unitValue=w(e.unitValue),y(e.subtotal)?W(t):t.subtotal=w(e.subtotal),t}function w(e){return(e||0).toFixed(2)}function W(e){const t=e.unitCost,a=e.unitValue;n(t)&&n(a)?e.subtotal=w(parseFloat(t)*parseFloat(a)):e.subtotal=w(0),c.value.totalAmount=Q.value}const Ce=i([]);function L(e,t){return Ce[e]?L[e][t]:""}const c=i(),K=[{invoiceNumber:"lg",contactId:"lg"},{invoiceDate:"md",dueDate:"md",totalAmount:"md"},{customFields:"md"},{invoiceConfigId:"lg"},{currencyId:"lg"}],Ve=o(()=>K.reduce((e,t)=>(Object.keys(t).forEach(a=>{e.push(a)}),e),[])),B=o(()=>P(D.value)),J=o(()=>B.value.map(e=>e.key)),G=q(B.value);o(()=>{const e=[];return n(h.value.prefix)&&e.push(h.value.prefix),e.push(h.value.currentSequence),n(h.value.suffix)&&e.push(h.value.suffix),e.join("-")});const Q=o(()=>{const e=v.value.reduce((t,a)=>n(a.subtotal)?t+parseFloat(a.subtotal):t,0);return w(e)}),Se=i({}),T=i(),X=i(),h=i(),Y=i(),Z=i(),ke=o(()=>({invoice:c.value,invoiceLines:v.value,invoiceConfig:X.value,invoiceNumberSequence:h.value,billingContact:Y.value,currency:Z.value}));async function Ie(){return new Promise((e,t)=>{const a=v.value.map(l=>me.formatDataForSave(l));Promise.all(a).then(l=>{e(l)}).catch(l=>{t(l)})})}async function ee(){await Ie().then(e=>{const t=Object.assign({},{invoice:G.formatDataForSave(c.value),invoiceNumberSequence:h.value,invoiceLines:e});N.create("invoices",t,{path:"generate_with_lines"}).then(a=>{c.value.id=a.id,v.value=a.invoiceLines,E("Invoice created successfully!")}).catch(a=>{E("Error creating invoice!"),console.error(a)})}).catch(e=>{E("Error formatting invoice for save!"),console.error(e)})}function E(e){$.show(e),setTimeout(we,5e3)}function we(){$.hide()}const Le=o(()=>[{title:"Filter Work Logs"},{title:"Fill Invoice and Lines"},{title:"Preview Invoice"}]);async function Te(e){}async function xe(e){e===1?await ve():e===2&&await ee()}async function Fe(){await ee()}return Pe(()=>{pe()}),(e,t)=>(r(),S("div",lt,[st,V(at,{steps:s(Le),onPrevStep:Te,onNextStep:xe,onSubmit:Fe},{"step-0":b(()=>[V(ne,{modelValue:u.value,"onUpdate:modelValue":t[0]||(t[0]=a=>u.value=a),"fields-layout":s(ie),"data-fields":s(re),schemas:s(z),"error-messages":ue.value,submittable:!1},null,8,["modelValue","fields-layout","data-fields","schemas","error-messages"])]),"step-1":b(()=>[c.value?(r(),x(ne,{key:0,modelValue:c.value,"onUpdate:modelValue":t[1]||(t[1]=a=>c.value=a),"fields-layout":K,"data-fields":s(Ve),schemas:s(B),"error-messages":Se.value,submittable:!1},null,8,["modelValue","data-fields","schemas","error-messages"])):k("",!0),c.value?(r(),x(s(ze),{key:1,name:"Invoice Lines",headers:R,data:v.value,"table-actions":fe,actions:be,loading:C.value,pagination:{offset:0,limit:v.value.length,client:!0}},{"data-col.description":b(({headers:a,row:l,i:d})=>[g("div",ot,[V(s(A),{modelValue:l.description,"onUpdate:modelValue":f=>l.description=f,type:"text",label:"",size:"lg","error-message":L(d,"description")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),"data-col.unitCost":b(({headers:a,row:l,i:d})=>[g("div",it,[V(s(A),{modelValue:l.unitCost,"onUpdate:modelValue":f=>l.unitCost=f,type:"number",label:"",size:"sm","error-message":L(d,"unitCost")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),"data-col.unit":b(({headers:a,row:l,i:d})=>[g("div",rt,[V(s(Be),{modelValue:l.unit,"onUpdate:modelValue":f=>l.unit=f,type:"text",label:"",size:"md",options:s(ge),"error-message":L(d,"unit")},null,8,["modelValue","onUpdate:modelValue","options","error-message"])])]),"data-col.unitValue":b(({headers:a,row:l,i:d})=>[g("div",ut,[V(s(A),{modelValue:l.unitValue,"onUpdate:modelValue":f=>l.unitValue=f,type:"number",label:"",size:"sm","error-message":L(d,"unitValue")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),"data-col.subtotal":b(({headers:a,row:l,i:d})=>[g("div",ct,[V(s(A),{modelValue:l.subtotal,"onUpdate:modelValue":f=>l.subtotal=f,type:"number",label:"",size:"sm","error-message":L(d,"subtotal")},null,8,["modelValue","onUpdate:modelValue","error-message"])])]),pagination:b(({total:a})=>[Me(" Total Lines: "+se(a),1)]),_:1},8,["data","loading","pagination"])):k("",!0)]),"step-2":b(()=>[T.value?(r(),x(Je,{key:0,"template-type":"invoice_templates",id:T.value.id,"content-markup":T.value.contentMarkup,"content-styles":T.value.contentStyles,data:s(ke),disabled:!0},null,8,["id","content-markup","content-styles","data"])):k("",!0)]),_:1},8,["steps"])]))}},ht=le(dt,[["__scopeId","data-v-184a3028"]]);export{ht as default};
